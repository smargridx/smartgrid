
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Power Systems Newton-Raphson Simulator</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23fbbf24%22><path d=%22M13 2L3 14h9l-1 8 10-12h-9l1-8z%22/></svg>"
        type="image/svg+xml">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' } // Custom dark slate
                    }
                }
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Vis.js Network (For Single Line Diagram) -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- MathJax for nice equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>

    <style>
        html {
            background-color: #f8fafc;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Dark mode support for html root */
        html.dark {
            background-color: #0f172a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            zoom: 0.8;
            height: 100%;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        body.dark {
            background-color: #0f172a;
        }

        /* Mobile Optimizations */
        @media (max-width: 640px) {

            th,
            td {
                padding-left: 0.75rem !important;
                /* px-3 */
                padding-right: 0.75rem !important;
            }

            .btn-click {
                min-height: 44px;
                /* Apple Human Interface Guidelines */
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .slide-up {
            animation: slideUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .slide-up-delay-1 {
            animation-delay: 0.1s;
        }

        .slide-up-delay-2 {
            animation-delay: 0.2s;
        }

        .slide-up-delay-3 {
            animation-delay: 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hover-scale {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-scale:hover {
            transform: scale(1.02);
        }

        .btn-click:active {
            transform: scale(0.95);
        }

        .scroll-custom::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scroll-custom::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        /* Hide Scrollbar for Tabs */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }



        .scroll-custom::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }

        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #1e40af;
            font-weight: 600;
            background-color: #eff6ff;
        }

        .tab-inactive {
            color: #64748b;
            transition: all 0.2s;
        }

        .tab-inactive:hover {
            color: #1e293b;
            background-color: #f8fafc;
        }

        .input-edit {
            border: 1px solid transparent;
            background: transparent;
            transition: all 0.2s;
            border-radius: 4px;
            width: 100%;
            text-align: right;
            padding: 4px;
            font-family: monospace;
        }

        .input-edit:hover {
            border-color: #cbd5e1;
            background: #fff;
        }

        .input-edit:focus {
            border-color: #3b82f6;
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 2px #bfdbfe;
        }

        .info-btn {
            cursor: pointer;
            color: #2563eb;
            background-color: #dbeafe;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .info-btn:hover {
            background-color: #bfdbfe;
            color: #1e40af;
            transform: scale(1.1);
        }

        .info-btn-sm {
            cursor: pointer;
            color: #3b82f6;
            background-color: #eff6ff;
            border-radius: 50%;
            padding: 2px;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 4px;
            vertical-align: middle;
        }

        .info-btn-sm:hover {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        /* Print Specifics for PDF */
        .pdf-header {
            display: none;
        }

        /* Math/Code Block styling */
        .math-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        /* Flowchart Styles */
        .flow-node {
            transition: all 0.4s ease;
            border: 2px solid #e2e8f0;
            background: white;
            color: #64748b;
        }

        .flow-active {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #1e40af;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            font-weight: bold;
        }

        .flow-arrow {
            transition: all 0.4s ease;
            color: #cbd5e1;
        }

        .flow-arrow-active {
            color: #3b82f6;
        }

        /* Network Graph Styles */
        #sld-container {
            width: 100%;
            height: 600px;
            /* Responsive Height for Tall Phones */
            min-height: 50vh;
            max-height: 75vh;
        }

        @media (min-width: 1024px) {
            #sld-container {
                height: 600px;
            }
        }

        /* Tour Overlay Styles */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            pointer-events: none;
            /* Allow clicking through to highlighted element? No, usually blocks */
            /* We want to block interaction with non-highlighted elements */
        }

        .tour-highlight {
            position: relative;
            z-index: 10000;
            box-shadow: 0 0 0 4px #fbbf24, 0 0 0 5000px rgba(0, 0, 0, 0.7);
            pointer-events: auto;
            background-color: white;
            /* Ensure visibility */
            border-radius: 4px;
        }

        .tour-tooltip {
            position: absolute;
            z-index: 10001;
            background: white;
            color: #1e293b;
            padding: 16px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-left: 4px solid #fbbf24;
            animation: fadeIn 0.3s ease;
        }

        .tour-tooltip h4 {
            font-weight: bold;
            color: #fbbf24;
            /* Amber 400 */
            text-transform: uppercase;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
        }

        .tour-tooltip p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .tour-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tour-btn {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-btn-next {
            background: #fbbf24;
            color: #1e293b;
            border: none;
        }

        .tour-btn-next:hover {
            background: #f59e0b;
        }

        .tour-btn-skip {
            background: transparent;
            color: #94a3b8;
            border: 1px solid transparent;
        }

        .tour-btn-skip:hover {
            color: #64748b;
        }

        /* PRINT STYLES */
        @media print {
            body {
                overflow: visible !important;
                height: auto !important;
                background: white !important;
            }

            /* Hide everything but the modal content */
            body>*:not(#manualCalcModal) {
                display: none !important;
            }

            #manualCalcModal {
                position: static !important;
                display: block !important;
                visibility: visible !important;
                background: white !important;
                height: auto !important;
                width: 100% !important;
                overflow: visible !important;
                z-index: auto !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            #manualCalcModal>div {
                height: auto !important;
                max-width: none !important;
                width: 100% !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                border: none !important;
                display: block !important;
                overflow: visible !important;
            }

            /* Hide Modal Header and scrollbars during print */
            #manualCalcModal .bg-slate-900,
            #manualCalcModal button,
            #manualCalcModal .scroll-custom::-webkit-scrollbar {
                display: none !important;
            }

            #manualCalcModal .overflow-y-auto {
                overflow: visible !important;
                height: auto !important;
                width: 100% !important;
                padding: 0 !important;
            }

            #manualCalcContent {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 2cm !important;
                /* Standards for margins */
            }

            /* Ensure text is readable */
            .text-white,
            .text-slate-400,
            .text-slate-500,
            .text-blue-100 {
                color: #000 !important;
            }

            .bg-slate-950,
            .bg-slate-900,
            .bg-slate-800,
            .bg-slate-50 {
                background-color: #fff !important;
                color: #000 !important;
                border: 1px solid #eee !important;
            }

            /* MathJax scaling for print */
            .mjx-chtml {
                font-size: 100% !important;
            }

            /* Page breaks */
            section,
            .bg-white.rounded-2xl {
                page-break-inside: avoid;
                margin-bottom: 2rem !important;
            }
        }
    </style>
</head>

<body class="text-gray-800 dark:text-gray-100 selection:bg-blue-200 transition-colors duration-300">

    <!-- INTRO LANDING PAGE -->
    <div id="introPage" class="fixed inset-0 z-50 bg-slate-900 text-white overflow-y-auto">
        <div class="min-h-screen flex flex-col items-center justify-center p-4">
            <div
                class="max-w-6xl w-full bg-slate-800 rounded-3xl shadow-2xl overflow-hidden border border-slate-700 flex flex-col lg:flex-row animate-fadeIn">

                <!-- Left: Hero -->
                <div
                    class="lg:w-5/12 bg-gradient-to-br from-blue-700 via-blue-800 to-slate-900 p-10 flex flex-col justify-between relative overflow-hidden">
                    <!-- Background Effects -->
                    <div
                        class="absolute top-0 right-0 -mr-20 -mt-20 w-80 h-80 bg-blue-500/20 rounded-full blur-3xl animate-pulse">
                    </div>
                    <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-80 h-80 bg-purple-500/20 rounded-full blur-3xl animate-pulse"
                        style="animation-delay: 1s;"></div>
                    <div
                        class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/circuit-board.png')] opacity-10">
                    </div>

                    <div class="relative z-10 slide-up">
                        <div
                            class="w-20 h-20 bg-yellow-400 rounded-2xl rotate-3 flex items-center justify-center shadow-xl mb-8 group hover:rotate-6 transition-transform duration-300 border-4 border-yellow-300/50">
                            <span class="font-bold text-4xl text-slate-900">PH</span>
                        </div>

                        <div class="mb-2">
                            <span
                                class="inline-block py-1 px-3 rounded-full bg-blue-500/30 border border-blue-400/30 text-blue-100 text-[10px] font-bold uppercase tracking-widest backdrop-blur-md">
                                Final Project Capstone
                            </span>
                        </div>

                        <h1
                            class="text-3xl md:text-4xl font-extrabold tracking-tight mb-4 leading-snug text-white shadow-black drop-shadow-md">
                            Design and Implementation of a <br>
                            <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-blue-200 to-purple-200 animate-pulse">Web-Based
                                Power Flow Simulator</span> <br>
                            for Educational Use
                        </h1>
                        <p
                            class="text-blue-100 font-medium text-sm border-l-4 border-yellow-400 pl-4 py-1 opacity-90 bg-blue-900/20 rounded-r-lg">
                            Advanced Power System Analysis Platform
                        </p>
                    </div>

                    <div class="relative z-10 mt-12 slide-up slide-up-delay-1">
                        <div
                            class="flex items-center gap-4 text-sm text-blue-200 bg-blue-900/40 p-4 rounded-xl backdrop-blur-sm border border-blue-700/50 shadow-lg">
                            <i class="ph ph-graduation-cap text-3xl text-yellow-400 drop-shadow-lg"></i>
                            <p class="leading-relaxed">"Empowering the next generation of electrical engineers through
                                interactive simulation."</p>
                        </div>

                        <div class="mt-6">
                            <h4 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">System
                                Specifications</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs text-slate-300">
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">Base MVA: <span
                                        class="text-white font-mono">100 MVA</span></div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">Frequency: <span
                                        class="text-white font-mono">60 Hz</span></div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">Slack Bus: <span
                                        class="text-white font-mono">Bus 1</span></div>
                                <div class="bg-slate-900/50 p-2 rounded border border-slate-700">Solver: <span
                                        class="text-white font-mono">Newton-Raphson</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Content -->
                <div class="lg:w-7/12 p-10 bg-slate-800 relative">
                    <div class="space-y-8">

                        <div class="slide-up slide-up-delay-1">
                            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-3">
                                <span class="bg-blue-600/20 p-2 rounded-lg text-blue-400"><i
                                        class="ph ph-info"></i></span>
                                System Overview
                            </h2>

                        </div>

                        <div class="slide-up slide-up-delay-2">
                            <h3 class="font-bold text-slate-200 text-sm mb-3">Key Capabilities</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div
                                    class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition duration-300">
                                    <i class="ph ph-function text-xl text-pink-400 mt-1"></i>
                                    <div>
                                        <h4 class="font-bold text-pink-200 text-xs">Newton-Raphson Solver</h4>
                                        <p class="text-xs text-slate-400 mt-1">Solves non-linear power flow equations
                                            iteratively.</p>
                                    </div>
                                </div>
                                <div
                                    class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition duration-300">
                                    <i class="ph ph-warning-circle text-xl text-yellow-400 mt-1"></i>
                                    <div>
                                        <h4 class="font-bold text-yellow-200 text-xs">Compliance Checks</h4>
                                        <p class="text-xs text-slate-400 mt-1">Real-time PGC & PDC voltage regulation
                                            analysis.</p>
                                    </div>
                                </div>
                                <div
                                    class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition duration-300">
                                    <i class="ph ph-share-network text-xl text-green-400 mt-1"></i>
                                    <div>
                                        <h4 class="font-bold text-green-200 text-xs">Topology Editor</h4>
                                        <p class="text-xs text-slate-400 mt-1">Simulate N-1 contingencies by removing
                                            lines.</p>
                                    </div>
                                </div>
                                <div
                                    class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition duration-300">
                                    <i class="ph ph-file-pdf text-xl text-red-400 mt-1"></i>
                                    <div>
                                        <h4 class="font-bold text-red-200 text-xs">Report Generation</h4>
                                        <p class="text-xs text-slate-400 mt-1">Export full simulation results to PDF.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-6 border-t border-slate-700 slide-up slide-up-delay-3">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Operator
                                Identity</label>
                            <div class="flex gap-3">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-2.5 text-slate-500"><i
                                            class="ph ph-user"></i></span>
                                    <input type="text" id="introNameInput" placeholder="Engr. Uzumaki Naruto"
                                        value="Engr. Uzumaki Naruto"
                                        onfocus="if(this.value=='Engr. Uzumaki Naruto') this.value=''"
                                        class="w-full bg-slate-900 border border-slate-600 rounded-lg pl-10 pr-4 py-2 text-white focus:outline-none focus:border-blue-500 transition focus:ring-1 focus:ring-blue-500/50">
                                </div>
                                <button onclick="playSound(); startApp()"
                                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-8 rounded-lg transition-all shadow-lg hover:shadow-blue-500/30 flex items-center gap-2 btn-click group">
                                    Initialize <i
                                        class="ph ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            </div>
                            <p id="nameError" class="text-red-400 text-xs mt-2 hidden flex items-center gap-1"><i
                                    class="ph ph-warning"></i> Please identify yourself to proceed.</p>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-slate-500 text-xs mt-8 opacity-60">Batangas State University • The National Engineering
                University</p>
        </div>
    </div>

    <!-- SETUP MODAL (Phase 2) -->
    <div id="setupModal"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out]">
            <div class="p-6 text-center space-y-6">
                <div>
                    <div
                        class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="ph ph-sliders text-3xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">System Configuration</h3>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">Choose how you want to initialize the simulation
                        environment.</p>
                </div>

                <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-lg border border-gray-200 dark:border-slate-700">
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-200 mb-2">Configure
                        Network Size</label>
                    <div class="flex flex-col items-center justify-center gap-2">
                        <div class="flex items-center gap-2">
                            <input type="number" id="setupBusCount" value="5" min="3" max="15"
                                title="Enter a value between 3 and 15"
                                class="w-24 text-center border border-gray-300 rounded px-3 py-2 font-bold text-lg focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                            <span class="text-gray-500 dark:text-gray-400 font-medium">Buses</span>
                        </div>
                        <p class="text-[10px] text-gray-400 dark:text-gray-500 font-medium italic">Limited to 3 to 15
                            bus only</p>
                    </div>
                    <button onclick="playSound(); initCustomSystem()"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-blue-500/30 transition btn-click flex items-center justify-center gap-2">
                        <i class="ph ph-lightning"></i> Initialize Custom Grid
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION MODAL -->
    <div id="notificationModal"
        class="hidden fixed inset-0 z-[1100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden transform transition-all scale-100 ring-1 ring-slate-900/5 dark:ring-slate-700/50 animate-[fadeIn_0.2s_ease-out]">
            <div id="notifyHeader" class="h-1.5 w-full bg-red-500"></div>
            <div class="p-6 text-center">
                <div id="notifyIcon"
                    class="w-12 h-12 mx-auto bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mb-4 text-2xl transition-colors">
                    <i class="ph ph-warning-octagon"></i>
                </div>
                <h3 id="notifyTitle" class="text-lg font-bold text-slate-800 dark:text-slate-100 mb-2">Invalid Input
                </h3>
                <p id="notifyMessage" class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed mb-6">
                    Grid size must be between 3 and 15 buses.
                </p>
                <button onclick="playSound(); closeNotification()"
                    class="w-full py-2.5 bg-slate-900 hover:bg-slate-800 dark:bg-blue-600 dark:hover:bg-blue-500 text-white font-bold rounded-lg transition-colors shadow-lg active:scale-95 btn-click">
                    Okay, Got it
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden initially) -->
    <div id="mainApp" class="hidden h-full flex flex-col">

        <!-- Navbar -->
        <nav class="bg-slate-900 text-white shadow-xl z-10">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <button onclick="playSound(); toggleSidebar()"
                        class="lg:hidden text-slate-400 hover:text-white transition p-1">
                        <i class="ph ph-list text-2xl"></i>
                    </button>
                    <div
                        class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center font-bold text-xl text-slate-900 shadow-inner hover:scale-110 transition cursor-pointer">
                        PH</div>
                    <div class="truncate max-w-[120px] sm:max-w-none">
                        <div>
                            <h1 class="text-xl font-bold tracking-tight truncate">
                                <span class="hidden lg:inline">Web-Based Power Flow Simulator</span>
                                <span class="lg:hidden">PowerSim</span>
                            </h1>
                            <div class="text-[10px] text-slate-400 font-medium flex items-center gap-1">
                                <i class="ph ph-user-circle"></i> Operator: <span id="displayUserName"
                                    class="text-blue-400">Guest</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-1.5 md:gap-2">


                    <!-- Vertical Divider -->
                    <div class="h-6 w-px bg-slate-700 mx-1 hidden lg:block"></div>

                    <!-- Tour Button (High Visibility) -->
                    <button onclick="playSound(); startTour()"
                        class="h-9 px-3 bg-amber-500 hover:bg-amber-400 text-slate-900 font-bold text-sm rounded-md transition flex items-center gap-2 btn-click shadow-sm">
                        <i class="ph ph-flag-checkered"></i> <span class="hidden xl:inline">Tour</span>
                    </button>

                    <!-- File/View Group (Hidden on Mobile, Visible on LG) -->
                    <div class="hidden lg:flex items-center gap-2">
                        <!-- View Group -->
                        <div class="flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700/50">
                            <button onclick="playSound(); openHelp('procedure')"
                                class="h-7 px-2.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded-md transition flex items-center gap-2 text-sm">
                                <i class="ph ph-book-open"></i> <span class="hidden xl:inline">Manual</span>
                            </button>
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                            <button onclick="playSound(); openSLDModal()"
                                class="h-7 px-2.5 text-cyan-400 hover:text-white hover:bg-cyan-900/30 rounded-md transition flex items-center gap-2 text-sm">
                                <i class="ph ph-share-network"></i> <span class="hidden xl:inline">SLD</span>
                            </button>
                        </div>

                        <!-- File Group -->
                        <div class="flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700/50">
                            <button onclick="playSound(); exportScenario()"
                                class="h-7 w-8 flex items-center justify-center text-emerald-400 hover:text-white hover:bg-emerald-900/30 rounded-md transition">
                                <i class="ph ph-download-simple"></i>
                            </button>
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                            <input type="file" id="importFile" accept=".json" class="hidden"
                                onchange="importScenario(this)">
                            <button onclick="playSound(); document.getElementById('importFile').click()"
                                class="h-7 w-8 flex items-center justify-center text-purple-400 hover:text-white hover:bg-purple-900/30 rounded-md transition">
                                <i class="ph ph-upload-simple"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Vertical Divider -->
                    <div class="h-6 w-px bg-slate-700 mx-1 hidden lg:block"></div>

                    <!-- Utility Group (Reset, Theme, Info) -->
                    <div class="flex items-center gap-1">
                        <button onclick="playSound(); goToLanding()"
                            class="h-9 px-3 flex items-center justify-center gap-2 text-red-300 hover:bg-red-900/20 hover:text-red-200 rounded-md transition btn-click"
                            title="Reset">
                            <i class="ph ph-house text-lg"></i>
                            <span class="hidden xl:inline font-bold text-sm">Reset</span>
                        </button>

                        <button onclick="playSound(); toggleTheme()" id="themeToggleBtn"
                            class="h-9 w-9 flex items-center justify-center text-yellow-400 hover:bg-slate-800 rounded-md transition btn-click">
                            <i class="ph ph-sun text-lg"></i>
                        </button>

                        <button onclick="playSound(); openAuthorModal()"
                            class="h-9 w-9 flex items-center justify-center text-slate-400 hover:bg-slate-800 hover:text-white rounded-md transition btn-click"
                            title="Project Report">
                            <i class="ph ph-file-text text-lg"></i>
                        </button>
                    </div>

                    <!-- Primary Action -->
                    <div class="flex items-center gap-1.5 md:gap-2 flex-shrink-0">
                        <button onclick="playSound(); showManualNRCalculation()" id="manualNRBtn"
                            class="hidden h-10 px-3 md:px-4 bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 text-slate-700 dark:text-slate-200 hover:border-blue-500 dark:hover:border-blue-400 hover:text-blue-600 dark:hover:text-blue-300 font-black text-[10px] sm:text-xs uppercase tracking-tighter rounded-xl transition-all shadow-sm hover:shadow-blue-500/10 flex items-center justify-center gap-2 whitespace-nowrap group btn-click">
                            <div
                                class="w-6 h-6 rounded bg-slate-50 dark:bg-slate-900 flex items-center justify-center group-hover:bg-blue-50 dark:group-hover:bg-blue-900/30 transition-colors">
                                <i
                                    class="ph ph-math-operations text-blue-500 transition-transform group-hover:scale-110"></i>
                            </div>
                            <span class="hidden lg:inline">Report</span>
                        </button>
                        <button onclick="playSound(); runSimulation()" id="runBtn"
                            class="h-10 px-4 md:px-6 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-black text-[10px] sm:text-xs uppercase tracking-tighter rounded-xl transition-all shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 flex items-center justify-center gap-2 whitespace-nowrap active:scale-95 btn-click ring-2 ring-blue-500/20">
                            <i class="ph ph-play-circle text-lg"></i>
                            <span class="hidden md:inline">Run Solver</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden flex relative">

            <!-- Sidebar Overlay (Mobile) -->
            <div id="sidebarOverlay" onclick="toggleSidebar()"
                class="fixed inset-0 z-30 bg-slate-900/50 backdrop-blur-sm hidden lg:hidden transition-opacity"></div>

            <!-- Sidebar (Visual Topology List) -->
            <aside id="mobileSidebar"
                class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 overflow-y-auto scroll-custom transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static lg:block shadow-inner h-full pt-16 lg:pt-0">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Active Topology</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="playSound(); openHelp('topology')" class="info-btn"
                                title="Learn about Grid Topology">
                                <i class="ph ph-info text-sm"></i>
                            </button>
                            <button onclick="toggleSidebar()"
                                class="lg:hidden text-gray-400 hover:text-red-500 transition">
                                <i class="ph ph-x text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div
                        class="bg-slate-50 dark:bg-slate-800/80 p-3 rounded-lg border border-slate-100 dark:border-slate-700 mb-4 relative hover-scale">
                        <button onclick="playSound(); openHelp('gridStatus')"
                            class="absolute top-2 right-2 info-btn-sm"><i class="ph ph-question text-xs"></i></button>
                        <div class="text-xs text-gray-500">Grid Status</div>
                        <div class="text-lg font-bold text-green-600 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Connected
                        </div>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-semibold text-gray-600">Live Connections</h3>
                        <button onclick="playSound(); openHelp('liveConnections')" class="info-btn-sm"><i
                                class="ph ph-question text-xs"></i></button>
                    </div>
                    <div
                        class="bg-gray-50 dark:bg-slate-950 rounded-lg border border-gray-200 dark:border-slate-700 h-[calc(100vh-250px)] overflow-y-auto scroll-custom p-2 text-sm font-mono text-gray-600 dark:text-gray-400 shadow-inner">
                        <ul id="sidebarTopologyList" class="space-y-1"></ul>
                    </div>
                </div>
            </aside>

            <!-- Central Canvas -->
            <div class="flex-1 overflow-y-auto scroll-custom bg-slate-50 dark:bg-slate-900 p-4 md:p-8 relative w-full">

                <!-- Input State -->
                <div id="inputState" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <!-- Header Section with improved layout -->
                    <div class="flex flex-col xl:flex-row xl:items-center justify-between gap-6 pb-2">
                        <!-- Left: Title & Description -->
                        <div class="relative pl-4 border-l-4 border-blue-500">
                            <div class="flex items-center gap-3 mb-1">
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">
                                    System Configuration
                                </h2>
                                <button onclick="playSound(); openHelp('config')"
                                    class="text-slate-400 hover:text-blue-500 transition-colors p-1 rounded-full hover:bg-blue-50 dark:hover:bg-slate-800"
                                    title="Configuration Help">
                                    <i class="ph ph-info text-xl"></i>
                                </button>
                            </div>
                            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 max-w-xl">
                                Configure bus data and grid topology. Define your system parameters and transmission
                                lines manually or use auto-populate tools.
                            </p>
                        </div>

                        <!-- Right: Action Toolbar -->
                        <div class="flex flex-wrap items-center gap-3">

                            <!-- 1. Bus Count Widget -->
                            <div class="h-11 flex items-center gap-3 px-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:border-blue-400 transition-colors group cursor-default"
                                title="Current Bus Count">
                                <div class="flex flex-col">
                                    <span
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider leading-none mb-0.5 group-hover:text-blue-500 transition-colors">Buses</span>
                                    <div class="flex items-baseline gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                        <span class="text-xs font-semibold text-slate-500">Active</span>
                                    </div>
                                </div>
                                <div class="h-6 w-px bg-slate-100 dark:bg-slate-700"></div>
                                <span id="busCountDisplay"
                                    class="font-mono text-xl font-bold text-slate-700 dark:text-slate-200">5</span>
                            </div>

                            <!-- 2. Convergence Delta Widget -->
                            <div class="h-11 flex items-center gap-3 px-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:border-violet-400 transition-colors group relative overflow-hidden"
                                title="Convergence Tolerance">
                                <!-- Subtle background decoration -->
                                <div
                                    class="absolute right-0 top-0 w-8 h-full bg-gradient-to-l from-violet-50/50 to-transparent pointer-events-none">
                                </div>

                                <div class="flex flex-col justify-center">
                                    <label for="toleranceInput"
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider leading-none mb-0.5 group-hover:text-violet-500 transition-colors">Delta
                                        (ε)</label>
                                    <span class="text-[10px] text-slate-400">Tolerance</span>
                                </div>

                                <input type="number" id="toleranceInput" value="0.0001" step="0.00001" min="0.000001"
                                    class="w-24 bg-transparent text-right font-mono text-sm font-bold text-slate-700 dark:text-slate-200 focus:outline-none border-b border-transparent focus:border-violet-400 placeholder-slate-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-900 rounded px-1">
                            </div>

                            <!-- NEW: Base Power Widget -->
                            <div class="h-11 flex items-center gap-3 px-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:border-amber-400 transition-colors group relative overflow-hidden"
                                title="System Base MVA">
                                <div class="flex flex-col justify-center">
                                    <label for="baseMVAInput"
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider leading-none mb-0.5 group-hover:text-amber-500 transition-colors">Base</label>
                                    <span class="text-[10px] text-slate-400">Power (MVA)</span>
                                </div>
                                <input type="number" id="baseMVAInput" value="100" step="10" min="1"
                                    class="w-16 bg-transparent text-right font-mono text-sm font-bold text-slate-700 dark:text-slate-200 focus:outline-none border-b border-transparent focus:border-amber-400 placeholder-slate-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-900 rounded px-1">
                            </div>

                            <!-- NEW: Base Voltage Widget -->
                            <div class="h-11 flex items-center gap-3 px-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:border-sky-400 transition-colors group relative overflow-hidden"
                                title="System Base Voltage">
                                <div class="flex flex-col justify-center">
                                    <label for="baseKVInput"
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider leading-none mb-0.5 group-hover:text-sky-500 transition-colors">Base</label>
                                    <span class="text-[10px] text-slate-400">Voltage (kV)</span>
                                </div>
                                <input type="number" id="baseKVInput" value="230" step="5" min="1"
                                    class="w-16 bg-transparent text-right font-mono text-sm font-bold text-slate-700 dark:text-slate-200 focus:outline-none border-b border-transparent focus:border-sky-400 placeholder-slate-300 transition-all hover:bg-slate-50 dark:hover:bg-slate-900 rounded px-1">
                            </div>

                            <!-- 3. Load Defaults Button -->
                            <button onclick="playSound(); resetGrid()" id="resetBtn"
                                class="h-11 flex items-center gap-2 pl-4 pr-5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm text-slate-600 dark:text-slate-300 font-bold text-sm transition-all hover:border-red-500 hover:text-red-600 hover:shadow-md active:scale-95 group relative overflow-hidden">
                                <div class="absolute inset-0 bg-red-500/0 group-hover:bg-red-500/5 transition-colors">
                                </div>
                                <div
                                    class="bg-slate-100 dark:bg-slate-700 rounded-full p-1 group-hover:bg-red-100 group-hover:text-red-600 transition-colors">
                                    <i class="ph ph-trash text-lg"></i>
                                </div>
                                <span>Clear Grid</span>
                            </button>

                            <!-- 4. Status Badge -->
                            <div class="h-11 flex items-center gap-2 px-4 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg select-none"
                                title="Current Mode">
                                <span class="relative flex h-2.5 w-2.5">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500"></span>
                                </span>
                                <span
                                    class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wide">Pre-Sim</span>
                            </div>
                        </div>
                    </div>

                    <!-- Input Tabs -->
                    <div
                        class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
                        <!-- Input Tables (Stacked in Single Panel) -->
                        <div
                            class="border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50 px-4">
                            <nav class="-mb-px flex space-x-8">
                                <button id="tab-input-bus-data" onclick="switchInputTab('bus-data')"
                                    class="tab-active px-4 py-2 text-sm font-medium rounded-t-lg bg-white dark:bg-slate-800 border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 flex items-center gap-2 transition-colors">
                                    <i class="ph ph-table"></i> Bus Data
                                    <i class="ph ph-question text-xs text-blue-300 hover:text-blue-500 cursor-pointer"
                                        onclick="event.stopPropagation(); openHelp('busData')"></i>
                                </button>
                                <button onclick="playSound(); switchInputTab('topology')" id="tab-input-topology"
                                    class="tab-inactive py-3 px-4 border-b-2 border-transparent font-medium text-sm flex items-center gap-2 transition-colors dark:text-gray-400 dark:hover:text-gray-200">
                                    <i class="ph ph-share-network"></i> Grid Topology
                                    <span onclick="event.stopPropagation(); openHelp('topology')" class="info-btn-sm"
                                        title="Topology Guide">
                                        <i class="ph ph-question text-xs"></i>
                                    </span>
                                </button>
                            </nav>
                        </div>

                        <!-- Bus Data Input Panel -->
                        <div id="input-bus-data" class="overflow-x-auto h-[600px] scroll-custom p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-700 dark:text-gray-200">System Bus Configuration</h3>
                                <div class="flex gap-2">
                                    <button onclick="playSound(); populateTestValues()" id="btnPopulateValues"
                                        class="px-3 py-1 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded border border-amber-200 text-sm font-semibold flex items-center gap-2 btn-click transition-all duration-500"
                                        title="Fill with random test data">
                                        <i class="ph ph-magic-wand"></i> Populate Test Values
                                    </button>
                                    <button onclick="playSound(); addBus()"
                                        class="px-3 py-1 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded border border-blue-200 text-sm font-semibold flex items-center gap-2 btn-click">
                                        <i class="ph ph-plus"></i> Add New Bus
                                    </button>
                                </div>
                            </div>

                            <!-- BUS TYPE SUMMARY REFERENCE TABLE -->
                            <div
                                class="mb-6 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg overflow-hidden shadow-sm">
                                <div
                                    class="bg-gray-50 dark:bg-slate-900 px-4 py-2 border-b border-gray-200 dark:border-slate-700">
                                    <h4 class="text-[11px] font-bold text-gray-500 uppercase tracking-wider">Bus Type
                                        Summary Reference</h4>
                                </div>
                                <table class="min-w-full text-xs text-left">
                                    <thead
                                        class="bg-white dark:bg-slate-800 text-gray-400 font-medium border-b border-gray-100 dark:border-slate-700">
                                        <tr>
                                            <th class="px-4 py-2">Bus Type</th>
                                            <th class="px-4 py-2">Known Variables</th>
                                            <th class="px-4 py-2">Unknown Variables (Calculated)</th>
                                            <th class="px-4 py-2">Common Application</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-50 dark:divide-slate-700">
                                        <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                                            <td class="px-4 py-2 font-bold text-gray-700 dark:text-gray-200">PQ (Load
                                                Bus)</td>
                                            <td class="px-4 py-2 font-mono text-blue-600">P, Q</td>
                                            <td class="px-4 py-2 font-mono text-emerald-600">V, &delta;</td>
                                            <td class="px-4 py-2 text-gray-500 italic">Substations,
                                                residential/industrial loads</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                                            <td class="px-4 py-2 font-bold text-gray-700 dark:text-gray-200">PV
                                                (Generator Bus)</td>
                                            <td class="px-4 py-2 font-mono text-blue-600">P, V</td>
                                            <td class="px-4 py-2 font-mono text-emerald-600">Q, &delta;</td>
                                            <td class="px-4 py-2 text-gray-500 italic">Power plants, voltage control
                                                devices</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/30">
                                            <td class="px-4 py-2 font-bold text-gray-700 dark:text-gray-200">Slack
                                                (Swing Bus)</td>
                                            <td class="px-4 py-2 font-mono text-blue-600">V, &delta;</td>
                                            <td class="px-4 py-2 font-mono text-emerald-600">P, Q</td>
                                            <td class="px-4 py-2 text-gray-500 italic">System reference (usually Bus 1)
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <table
                                class="min-w-full text-sm text-left text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-slate-700 rounded-lg overflow-hidden">
                                <thead
                                    class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-slate-900 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-4 py-3 bg-gray-100 dark:bg-slate-900 w-[10%]">Bus <span
                                                onclick="playSound(); openHelp('busColumn')" class="info-btn-sm"><i
                                                    class="ph ph-info text-xs"></i></span></th>
                                        <th class="px-4 py-3 bg-gray-100 dark:bg-slate-900 text-center border-l border-gray-200 dark:border-slate-700 w-[20%]"
                                            colspan="2">Voltage</th>
                                        <th class="px-4 py-3 bg-gray-100 dark:bg-slate-900 text-center border-l border-gray-200 dark:border-slate-700 w-[24%]"
                                            colspan="2">Generation <span onclick="playSound(); openHelp('genColumn')"
                                                class="info-btn-sm"><i class="ph ph-info text-xs"></i></span></th>
                                        <th class="px-4 py-3 bg-gray-100 dark:bg-slate-900 text-center border-l border-gray-200 dark:border-slate-700 w-[24%]"
                                            colspan="2">Load <span onclick="playSound(); openHelp('loadColumn')"
                                                class="info-btn-sm"><i class="ph ph-info text-xs"></i></span></th>
                                        <th
                                            class="px-4 py-3 bg-gray-100 dark:bg-slate-900 text-right border-l border-gray-200 dark:border-slate-700 w-[10%]">
                                            Action</th>
                                    </tr>
                                    <tr>
                                        <th class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-gray-400 font-normal">ID
                                        </th>
                                        <th
                                            class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-right font-normal border-l border-gray-200 dark:border-slate-700">
                                            Mag</th>
                                        <th class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-right font-normal">Angle
                                        </th>
                                        <th
                                            class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-right font-normal border-l border-gray-200 dark:border-slate-700">
                                            P (MW)</th>
                                        <th class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-right font-normal">Q
                                            (Mvar)</th>
                                        <th
                                            class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-right font-normal border-l border-gray-200 dark:border-slate-700">
                                            P (MW)</th>
                                        <th class="px-4 py-2 bg-gray-50 dark:bg-slate-800 text-right font-normal">Q
                                            (Mvar)</th>
                                        <th class="px-4 py-2 bg-gray-50 border-l border-gray-200"></th>
                                    </tr>
                                </thead>
                                <tbody id="inputTableBody"
                                    class="divide-y divide-gray-100 text-gray-700 dark:text-gray-300"></tbody>
                            </table>
                        </div>

                        <!-- Topology Input Panel -->
                        <div id="input-topology" class="hidden overflow-x-auto h-[600px] scroll-custom p-6">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-gray-700 dark:text-gray-200">Transmission Line Connections
                                    </h3>
                                    <button onclick="playSound(); openHelp('topologyList')" class="info-btn-sm"><i
                                            class="ph ph-question text-xs"></i></button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="playSound(); populateTopology()" id="btnPopulateTopology"
                                        class="px-3 py-1 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded border border-amber-200 text-sm font-semibold flex items-center gap-2 btn-click transition-all duration-500"
                                        title="Auto-connect buses">
                                        <i class="ph ph-magic-wand"></i> Populate Topology
                                    </button>
                                    <button onclick="playSound(); openAddLineModal()" id="btnAddLine"
                                        class="px-3 py-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded border border-emerald-200 text-sm font-semibold flex items-center gap-2 btn-click">
                                        <i class="ph ph-plus"></i> Add Line
                                        <span onclick="event.stopPropagation(); openHelp('addLine')"
                                            class="bg-emerald-200 text-emerald-700 rounded-full w-4 h-4 flex items-center justify-center text-[10px]"><i
                                                class="ph ph-question"></i></span>
                                    </button>
                                </div>
                            </div>
                            <table
                                class="w-full text-sm text-left text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-slate-700 rounded-lg overflow-hidden">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-slate-900 shadow-sm">
                                    <tr>
                                        <th class="px-3 py-2 w-[8%]">ID</th>
                                        <th class="px-3 py-2 w-[10%]">Type</th>
                                        <th class="px-3 py-2 w-[8%] text-center">From</th>
                                        <th class="px-3 py-2 w-[8%] text-center">To</th>
                                        <th class="px-3 py-2 w-[12%] text-center">R / %Z</th>
                                        <th class="px-3 py-2 w-[15%] text-center">X / Voltages / a</th>
                                        <th class="px-3 py-2 w-[10%] text-center">B/2 (p.u)</th>
                                        <th class="px-3 py-2 w-[15%] text-center">Calculated Z</th>
                                        <th class="px-3 py-2 text-right w-[8%]">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="topologyTableBody"
                                    class="divide-y divide-gray-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- Loading Overlay -->
                <div id="loadingState"
                    class="hidden absolute inset-0 bg-white/95 z-[900] flex flex-col items-center justify-center backdrop-blur-sm">
                    <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4">
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="loadingText">Solving Power Flow...</h3>
                    <p class="text-sm text-gray-500 mt-2">Computing Line Losses & Voltages (Newton-Raphson)</p>
                </div>

                <!-- Results State -->
                <div id="resultsState" class="hidden max-w-7xl mx-auto space-y-6 fade-in p-2">

                    <!-- PDF Header (Hidden normally, visible in print) -->
                    <div class="pdf-header mb-6 border-b pb-4">
                        <h1 class="text-2xl font-bold text-gray-900">IEEE 30-Bus Simulation Report</h1>
                        <p class="text-sm text-gray-600">Generated by Smart Grid Simulator</p>
                        <div class="mt-2 flex justify-between text-sm">
                            <p><strong>Operator:</strong> <span id="pdfUserName"></span></p>
                            <p><strong>Date:</strong> <span id="pdfDate"></span></p>
                        </div>
                    </div>

                    <div class="flex items-center justify-between" id="resultsControls">
                        <div class="flex items-center gap-2">
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-gray-100">Simulation Output</h2>
                            <button onclick="playSound(); openHelp('results')" class="info-btn"
                                title="Results Analysis Guide">
                                <i class="ph ph-info text-sm"></i>
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="playSound(); exportToPDF()"
                                class="px-4 py-2 text-sm text-red-600 bg-red-50 border border-red-200 hover:bg-red-100 font-bold rounded-lg transition flex items-center gap-2 btn-click">
                                <i class="ph ph-file-pdf text-lg"></i> Export Report
                            </button>
                            <button onclick="playSound(); resetSimulation()"
                                class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition btn-click">
                                <i class="ph ph-arrow-left mr-1"></i> Back to Config
                            </button>
                            <!-- Feature 2: 24h Analysis Button -->
                            <button onclick="playSound(); openDailyModal()"
                                class="px-4 py-2 text-sm text-purple-600 bg-purple-50 border border-purple-200 hover:bg-purple-100 font-bold rounded-lg transition flex items-center gap-2 btn-click">
                                <i class="ph ph-clock text-lg"></i> 24H Cycle
                            </button>
                        </div>
                    </div>



                    <!-- KPI Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div
                            class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-blue-300 transition hover-scale">
                            <button onclick="playSound(); openHelp('kpiGen')"
                                class="absolute top-2 right-2 info-btn-sm z-10"><i
                                    class="ph ph-question text-xs"></i></button>
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><i
                                    class="ph ph-lightning text-4xl text-blue-600"></i></div>
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Total Generation
                            </div>
                            <div class="text-2xl font-bold text-blue-600 mt-1" id="totalGenDisplay">0 MW</div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-purple-300 transition hover-scale">
                            <button onclick="playSound(); openHelp('kpiLoad')"
                                class="absolute top-2 right-2 info-btn-sm z-10"><i
                                    class="ph ph-question text-xs"></i></button>
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><i
                                    class="ph ph-house-line text-4xl text-purple-600"></i></div>
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Total Load</div>
                            <div class="text-2xl font-bold text-purple-600 mt-1" id="totalLoadDisplay">0 MW</div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-red-300 transition hover-scale">
                            <button onclick="playSound(); openHelp('kpiLoss')"
                                class="absolute top-2 right-2 info-btn-sm z-10"><i
                                    class="ph ph-question text-xs"></i></button>
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><i
                                    class="ph ph-fire text-4xl text-red-600"></i></div>
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">System Losses
                            </div>
                            <div class="text-2xl font-bold text-red-600 mt-1" id="totalLossDisplay">2.86 MW</div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-800 p-5 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-emerald-300 transition hover-scale">
                            <button onclick="playSound(); openHelp('kpiStatus')"
                                class="absolute top-2 right-2 info-btn-sm z-10"><i
                                    class="ph ph-question text-xs"></i></button>
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><i
                                    class="ph ph-check-square text-4xl text-emerald-600"></i></div>
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Grid Code Status
                            </div>
                            <div class="text-2xl font-bold text-emerald-600 mt-1" id="complianceStatus">COMPLIANT
                            </div>
                        </div>
                    </div>

                    <!-- Results Tabs -->
                    <div class="border-b border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                        <nav
                            class="-mb-px flex flex-wrap lg:flex-nowrap justify-start lg:justify-between items-center px-2">
                            <button onclick="playSound(); switchTab('line-flows')" id="tab-line-flows"
                                class="tab-active py-3 px-2 border-b-2 font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all">
                                <i class="ph ph-flow-arrow"></i> Flows
                            </button>

                            <button onclick="playSound(); switchTab('math')" id="tab-math"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all">
                                <i class="ph ph-math-operations"></i> Solver
                            </button>

                            <button onclick="playSound(); switchTab('compliance')" id="tab-compliance"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all">
                                <i class="ph ph-check-square"></i> PGC
                            </button>

                            <button onclick="playSound(); switchTab('contingency')" id="tab-contingency"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all text-red-600 hover:text-red-700">
                                <i class="ph ph-warning"></i> N-1
                            </button>

                            <button onclick="playSound(); switchTab('fault')" id="tab-fault"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all text-orange-600 hover:text-orange-700">
                                <i class="ph ph-lightning"></i> Faults
                            </button>

                            <button onclick="playSound(); switchTab('opf')" id="tab-opf"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all text-blue-600 hover:text-blue-700">
                                <i class="ph ph-chart-bar"></i> OPF
                            </button>

                            <button onclick="playSound(); switchTab('arc-flash')" id="tab-arc-flash"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all text-yellow-600 hover:text-yellow-700">
                                <i class="ph ph-shield-warning"></i> Arc
                            </button>

                            <button onclick="playSound(); switchTab('harmonics')" id="tab-harmonics"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all text-indigo-600 hover:text-indigo-700">
                                <i class="ph ph-waves"></i> Harmonics
                            </button>

                            <button onclick="playSound(); switchTab('stability')" id="tab-stability"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all text-emerald-600 hover:text-emerald-700">
                                <i class="ph ph-activity"></i> Stability
                            </button>

                            <button onclick="playSound(); switchTab('voltage')" id="tab-voltage"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all">
                                <i class="ph ph-chart-line"></i> Profile
                            </button>

                            <button onclick="playSound(); switchTab('proof')" id="tab-proof"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 text-blue-600 hover:text-blue-700">
                                <i class="ph ph-math-operations"></i> Report
                            </button>

                            <button onclick="playSound(); switchTab('pv-curve')" id="tab-pv-curve"
                                class="tab-inactive py-3 px-2 border-b-2 border-transparent font-medium text-[10px] md:text-xs whitespace-nowrap flex items-center gap-1 transition-all">
                                <i class="ph ph-monitor"></i> PV Curve
                            </button>
                        </nav>
                    </div>

                    <!-- Table 2: Line Flows & Losses -->
                    <div id="content-line-flows"
                        class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden animate-fadeIn">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Line Power Flows and Losses</h3>
                            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">Newton-Raphson
                                Method</span>
                        </div>
                        <div class="overflow-x-auto h-[500px] scroll-custom">
                            <table class="min-w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 w-[8%]">From Bus</th>
                                        <th class="px-6 py-3 w-[8%]">To Bus</th>
                                        <th class="px-6 py-3 text-emerald-600 w-[16%]">Voltages (From | To) <div
                                                class="text-[9px] font-normal">[p.u.] / [kV] / [&ang;&deg;]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right w-[12%]">Flow (From&rarr;To) <div
                                                class="text-[9px] font-normal">[p.u.] / [MW]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right w-[12%]">Flow (To&rarr;From) <div
                                                class="text-[9px] font-normal">[p.u.] / [MW]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right text-blue-600 w-[16%]">Current (I) <div
                                                class="text-[9px] font-normal">[p.u.] / [A] / [&ang;&deg;]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right text-red-600 w-[14%]">Loss P <div
                                                class="text-[9px] font-normal">[p.u.] / [MW]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right text-red-600 w-[14%]">Loss Q <div
                                                class="text-[9px] font-normal">[p.u.] / [Mvar]</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="lineFlowTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>





                    <!-- MATHEMATICAL SOLVER TAB -->
                    <div id="content-math"
                        class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden animate-fadeIn flex flex-col h-[800px]">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Newton-Raphson Iteration & Formulas</h3>
                            <div class="flex gap-2">
                                <button onclick="playSound(); startSolverAnim()" id="btnMathStart"
                                    class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded hover:bg-green-200 transition btn-click flex items-center gap-1"><i
                                        class="ph ph-play"></i> Auto Run</button>
                                <button onclick="playSound(); stepSolverAnim()" id="btnMathStep"
                                    class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded hover:bg-blue-200 transition btn-click flex items-center gap-1"><i
                                        class="ph ph-step-forward"></i> Step</button>
                                <button onclick="playSound(); resetSolverAnim()" id="btnMathReset"
                                    class="px-3 py-1 bg-gray-100 text-gray-700 text-xs font-bold rounded hover:bg-gray-200 transition btn-click flex items-center gap-1"><i
                                        class="ph ph-arrow-counter-clockwise"></i> Reset</button>
                            </div>
                        </div>

                        <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 overflow-hidden bg-slate-50">
                            <!-- Left: Math Parameters (Z and Y-Bus) -->
                            <div
                                class="border-r border-gray-200 flex flex-col gap-4 overflow-y-auto scroll-custom p-4 bg-white">
                                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                    <h4
                                        class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                                        <i class="ph ph-matrix text-blue-600"></i> System Admittance (Y-Bus)
                                    </h4>
                                    <div id="yBusDisplay"
                                        class="font-mono text-[9px] overflow-auto scroll-custom whitespace-nowrap bg-slate-50 p-3 rounded border border-gray-100 leading-relaxed text-slate-700 max-h-[400px]">
                                        [ Execute simulation ]
                                    </div>
                                </div>

                                <div class="bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
                                    <h4
                                        class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                                        <i class="ph ph-list-numbers"></i> Branch Impedances (Z)
                                    </h4>
                                    <div class="overflow-x-auto max-h-48 scroll-custom border border-gray-50 rounded">
                                        <table class="min-w-full text-[10px]">
                                            <thead class="bg-gray-50 sticky top-0">
                                                <tr class="text-gray-400 text-left">
                                                    <th class="py-1.5 px-2">Line</th>
                                                    <th class="py-1.5 px-2">R (p.u.)</th>
                                                    <th class="py-1.5 px-2">X (p.u.)</th>
                                                    <th class="py-1.5 px-2">|Z|</th>
                                                </tr>
                                            </thead>
                                            <tbody id="zTableBody"
                                                class="divide-y divide-gray-50 text-gray-600 font-mono">
                                                <!-- Populated via JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-[10px] text-blue-900">
                                    <h5 class="font-bold border-b border-blue-200 pb-2 mb-2">Algorithm Base</h5>
                                    <ul class="list-disc pl-4 space-y-1 opacity-80">
                                        <li>Complex Voltages: \( V = |V| \angle \delta \)</li>
                                        <li>Power Balance: \( S_{gen} - S_{load} = S_{calc} \)</li>
                                        <li>System Base: <span id="mathBaseMVA">100</span> MVA</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Middle: Flowchart & Convergence -->
                            <div class="border-r border-gray-200 flex flex-col gap-4 overflow-y-auto scroll-custom p-4">
                                <div
                                    class="bg-white border border-gray-100 rounded-lg p-6 relative flex flex-col items-center gap-3 shadow-sm">
                                    <h4
                                        class="text-[10px] font-bold text-gray-400 uppercase w-full text-center border-b pb-2 mb-2">
                                        Algorithm Flow</h4>
                                    <div id="flow-start"
                                        class="flow-node px-4 py-2 rounded-full text-[10px] font-medium shadow-sm w-40 text-center border">
                                        1. Flat Start</div>
                                    <div class="flow-arrow opacity-40"><i class="ph ph-arrow-down"></i></div>
                                    <div id="flow-mismatch"
                                        class="flow-node px-4 py-2 rounded-lg text-[10px] font-medium shadow-sm w-48 text-center border-l-4 border-l-purple-400">
                                        2. Mismatches</div>
                                    <div class="flow-arrow opacity-40"><i class="ph ph-arrow-down"></i></div>
                                    <div id="flow-check"
                                        class="flow-node px-4 py-2 rounded-lg text-[10px] font-medium shadow-sm w-48 text-center border-l-4 border-l-yellow-400">
                                        3. Convergence Check</div>
                                    <div class="flow-arrow opacity-40"><i class="ph ph-arrow-down"></i></div>
                                    <div id="flow-jacobian"
                                        class="flow-node px-4 py-2 rounded-lg text-[10px] font-medium shadow-sm w-48 text-center border-l-4 border-l-blue-400">
                                        4. Jacobian Matrix</div>
                                    <div class="flow-arrow opacity-40"><i class="ph ph-arrow-down"></i></div>
                                    <div id="flow-update"
                                        class="flow-node px-4 py-2 rounded-lg text-[10px] font-medium shadow-sm w-48 text-center border-l-4 border-l-green-400">
                                        5. Update States</div>

                                    <div
                                        class="absolute right-2 top-1/2 bottom-12 w-4 border-r border-dashed border-gray-300 rounded-r-lg pointer-events-none opacity-50">
                                    </div>

                                    <button onclick="playSound(); switchTab('proof')"
                                        class="mt-4 px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-bold border border-blue-100 hover:bg-blue-100 transition flex items-center justify-center gap-2 w-full">
                                        <i class="ph ph-math-operations"></i> View Technical Report
                                    </button>
                                </div>

                                <div
                                    class="bg-white border border-gray-100 rounded-lg p-3 shadow-sm h-52 flex flex-col">
                                    <h5 class="text-[10px] font-bold text-gray-400 mb-1 px-1">Error Profile</h5>
                                    <div class="flex-grow w-full relative">
                                        <canvas id="convergenceChart"></canvas>
                                    </div>
                                </div>

                                <div class="bg-white border border-gray-100 rounded-lg p-3 shadow-sm">
                                    <h5 class="text-[10px] font-bold text-gray-400 mb-2 px-1">Active Formula</h5>
                                    <div class="math-block text-xs bg-slate-50 p-2 rounded border border-slate-100"
                                        id="activeEqDisplay">
                                        $$ f(x) = 0 $$
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Live Log -->
                            <div
                                class="flex flex-col h-full bg-slate-900 rounded-xl overflow-hidden shadow-inner border border-slate-700">
                                <div
                                    class="bg-slate-800 px-4 py-2 flex items-center justify-between border-b border-slate-700">
                                    <span class="text-xs font-bold text-slate-400 flex items-center gap-2"><i
                                            class="ph ph-terminal-window"></i> Solver Console</span>
                                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                </div>
                                <div class="flex-1 p-4 font-mono text-xs text-green-400 overflow-y-auto scroll-custom space-y-1"
                                    id="interactiveMathLog">
                                    <span class="text-gray-500 opacity-50">System Ready. Press 'Auto Run' or 'Step'
                                        to
                                        visualize logic.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mechanical Proof Tab -->
                    <div id="content-proof"
                        class="hidden bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden animate-fadeIn flex flex-col p-6 min-h-[800px]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-800">Newton-Raphson Technical Report</h3>
                            <div class="flex gap-2">
                                <button onclick="playSound(); showManualNRCalculation()" id="btnGenerateProof"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all shadow-md flex items-center gap-2 text-sm">
                                    <i class="ph ph-lightning"></i> Generate Report
                                </button>
                                <button onclick="playSound(); printManualCalc()"
                                    class="px-4 py-2 bg-slate-50 text-slate-600 border border-slate-200 hover:bg-slate-100 font-bold rounded-lg transition-all flex items-center gap-2 text-sm">
                                    <i class="ph ph-printer"></i> Print
                                </button>
                                <button onclick="playSound(); exportManualCalcToPDF()"
                                    class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 font-bold rounded-lg transition-all flex items-center gap-2 text-sm">
                                    <i class="ph ph-file-pdf"></i> Export
                                </button>
                            </div>
                        </div>

                        <div id="manualCalcContent" class="flex-1 overflow-y-auto pr-4 scroll-custom">
                            <div class="flex flex-col items-center justify-center h-full text-slate-400 py-20">
                                <i class="ph ph-math-operations text-6xl mb-4 opacity-20"></i>
                                <p class="text-lg font-medium">Mathematical Model Ready</p>
                                <p class="text-sm italic">Click "Generate Report" to expand the full Newton-Raphson
                                    technical report.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Tab -->
                    <div id="content-compliance"
                        class="hidden bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6 animate-fadeIn">
                        <div
                            class="flex items-start justify-between gap-4 p-4 bg-yellow-50 rounded-lg border border-yellow-100">
                            <div class="flex items-start gap-4">
                                <i class="ph ph-warning-circle text-yellow-600 text-2xl"></i>
                                <div>
                                    <h3 class="font-bold text-yellow-900">Philippine Grid Code (PGC) Standards</h3>
                                    <p class="text-sm text-yellow-800 mt-1">
                                        <strong>Voltage Compliance (PGC GR 3.3.3.1):</strong> Normal State must be
                                        within
                                        <strong>0.95 p.u. to 1.05 p.u.</strong><br>
                                        <strong>Distribution Code (PDC 3.2.3):</strong> Service voltage tolerance is
                                        <strong>±10% (0.90 - 1.10 p.u.)</strong>.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto h-[400px] scroll-custom">
                            <table class="min-w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 w-[15%]">Bus ID</th>
                                        <th class="px-6 py-3 w-[20%]">Voltage (p.u.)</th>
                                        <th class="px-6 py-3 w-[20%]">PGC Status (±5%)</th>
                                        <th class="px-6 py-3 w-[20%]">PDC Status (±10%)</th>
                                        <th class="px-6 py-3 w-[25%] text-right">Action Required</th>
                                    </tr>
                                </thead>
                                <tbody id="complianceTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Voltage Chart Tab -->
                    <div id="content-voltage"
                        class="hidden bg-white p-6 rounded-xl border border-gray-200 shadow-sm animate-fadeIn">
                        <div class="h-96 w-full">
                            <canvas id="voltageChart"></canvas>
                        </div>
                    </div>

                    <!-- Contingency Analysis Results -->
                    <div id="content-contingency"
                        class="hidden p-6 bg-white rounded-lg border border-gray-200 shadow-sm animate-fadeIn">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="ph ph-warning-octagon text-red-500"></i> N-1 Contingency Analysis
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">Simulate the failure of each transmission line
                                    (N-1) and evaluate system reliability.</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="playSound(); runN1Analysis()"
                                    class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105 btn-click flex items-center gap-2">
                                    <i class="ph ph-lightning-slash text-xl"></i> Run Analysis
                                </button>
                            </div>
                        </div>

                        <!-- Explanation Block -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-sm text-blue-800">
                            <details class="cursor-pointer group">
                                <summary class="font-bold flex items-center gap-2 select-none">
                                    <i class="ph ph-info text-lg"></i> Understanding N-1 Results & Recommendations
                                    <i class="ph ph-caret-down ml-auto group-open:rotate-180 transition"></i>
                                </summary>
                                <div
                                    class="mt-3 space-y-2 text-blue-700 text-xs leading-relaxed pl-6 border-l-2 border-blue-200">
                                    <p><strong>N-1 Criterion:</strong> A rule requiring the grid to remain stable
                                        even
                                        if any single component (line/generator) fails.</p>
                                    <ul class="list-disc pl-4 space-y-1">
                                        <li><span class="font-bold text-red-600">ISLANDING:</span> The grid splits
                                            into
                                            disconnected parts. <br><em>Fix:</em> Add a redundant (parallel)
                                            transmission line to maintain connectivity.</li>
                                        <li><span class="font-bold text-red-600">VOLTAGE COLLAPSE:</span> Voltage
                                            drops
                                            below 0.90 p.u., risking blackout. <br><em>Fix:</em> Add Reactive
                                            Compensation (Capacitor Bank) at the weak bus.</li>
                                        <li><span class="font-bold text-amber-600">OVERLOAD:</span> Remaining lines
                                            carry too much current (>100%). <br><em>Fix:</em> Upgrade line capacity
                                            or
                                            add parallel paths.</li>
                                    </ul>
                                </div>
                            </details>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-xs text-gray-500 uppercase font-bold">Total Scenarios</div>
                                <div class="text-2xl font-bold text-gray-800" id="n1-total">0</div>
                            </div>
                            <div
                                class="bg-red-50 p-4 rounded-lg border border-red-200 col-span-2 flex justify-between items-center">
                                <div>
                                    <div class="text-xs text-red-500 uppercase font-bold">Critical Violations</div>
                                    <div class="text-2xl font-bold text-red-600" id="n1-critical">0</div>
                                </div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                                <div class="text-xs text-amber-500 uppercase font-bold">Warnings</div>
                                <div class="text-2xl font-bold text-amber-600" id="n1-warning">0</div>
                            </div>
                        </div>

                        <!-- Moved N-1 Table -->
                        <div class="overflow-x-auto rounded-lg border border-gray-200 mt-6">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3 w-[20%]">Bus/Line ID</th>
                                        <th class="px-6 py-3 w-[20%]">Status</th>
                                        <th class="px-6 py-3 w-[60%] text-right">Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody id="n1TableBody" class="divide-y divide-gray-100">
                                    <tr>
                                        <td colspan="3" class="px-6 py-8 text-center text-gray-400 italic">
                                            Click "Run Analysis" to simulate contingencies for all <span
                                                id="n1-line-count">...</span> lines.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>

                    <!-- Fault Analysis Results Tab (NEW) -->
                    <div id="content-fault"
                        class="hidden p-6 bg-white rounded-lg border border-gray-200 shadow-sm animate-fadeIn">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="ph ph-lightning text-orange-500"></i> Short Circuit Analysis
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">Calculates fault currents using Z-Bus Matrix
                                    Inversion.
                                    <button onclick="playSound(); openHelp('faultAnalysis')" class="info-btn-sm"
                                        title="Fault Analysis Help">
                                        <i class="ph ph-question text-xs"></i>
                                    </button>
                                </p>
                            </div>
                            <div class="flex flex-wrap items-center gap-3">
                                <div
                                    class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Fault Type:</label>
                                    <select id="faultTypeSelect"
                                        class="bg-transparent text-sm font-bold text-slate-700 focus:outline-none">
                                        <option value="3phase">3-Phase Bolted</option>
                                        <option value="lg">Line-to-Ground (L-G)</option>
                                        <option value="ll">Line-to-Line (L-L)</option>
                                        <option value="llg">Double Line-to-Ground (L-L-G)</option>
                                    </select>
                                </div>
                                <button onclick="playSound(); runFaultAnalysis()"
                                    class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105 btn-click flex items-center gap-2">
                                    <i class="ph ph-lightning text-xl"></i> Calculate Faults
                                </button>
                            </div>
                        </div>

                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6 text-sm text-orange-800">
                            <p><strong>Safety Check:</strong> Simulates a fault at every bus based on the selected type
                                to verify breaker capacities.</p>
                            <p class="mt-1">Assumes Sequence Ratios: <span
                                    class="font-mono bg-orange-100 px-1 rounded">Z2 ≈
                                    Z1</span>, <span class="font-mono bg-orange-100 px-1 rounded">Z0 ≈ 2.5×Z1</span>.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Table Column -->
                            <div
                                class="lg:col-span-2 overflow-x-auto rounded-lg border border-gray-200 h-[550px] scroll-custom relative bg-white shadow-sm">
                                <table class="w-full text-sm text-left text-gray-600">
                                    <thead
                                        class="text-xs text-gray-700 uppercase bg-gray-100 text-center sticky top-0 z-10">
                                        <tr>
                                            <th class="px-4 py-3 w-[10%]">Bus ID</th>
                                            <th class="px-4 py-3 w-[15%]">Pre-Fault (V)</th>
                                            <th class="px-4 py-3 w-[25%]">Thevenin Z1 (p.u.)</th>
                                            <th class="px-4 py-3 w-[20%]">Fault Current (kA)</th>
                                            <th class="px-4 py-3 w-[15%]">Fault MVA</th>
                                            <th class="px-4 py-3 w-[15%] text-right">Breaker Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="faultTableBody" class="divide-y divide-gray-100 text-center">
                                        <tr>
                                            <td colspan="6" class="px-6 py-12 text-center text-gray-400 italic">
                                                <div class="flex flex-col items-center gap-3">
                                                    <i class="ph ph-lightning-slash text-4xl opacity-20"></i>
                                                    <span>Click "Calculate Faults" to perform Short Circuit
                                                        Study.</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Console Column -->
                            <div
                                class="flex flex-col h-[550px] bg-slate-900 rounded-xl overflow-hidden shadow-2xl border border-slate-700">
                                <div
                                    class="bg-slate-800 px-4 py-2 flex items-center justify-between border-b border-slate-700">
                                    <div class="flex items-center gap-2">
                                        <i class="ph ph-terminal-window text-orange-400"></i>
                                        <span class="text-xs font-bold text-slate-300">Fault Solver Console</span>
                                    </div>
                                    <span id="faultConsoleStatus" class="w-2 h-2 bg-slate-600 rounded-full"></span>
                                </div>
                                <div class="flex-1 p-4 font-mono text-[11px] text-orange-400 overflow-y-auto scroll-custom space-y-3"
                                    id="faultMathLog">
                                    <div class="text-slate-500 opacity-50">System: Custom Distribution Grid</div>
                                    <div class="text-slate-500 opacity-50">Status: Awaiting Fault Trigger...</div>
                                    <div class="pt-4 border-t border-slate-800">
                                        <span class="text-blue-400">&gt;</span> Use the dropdown to select a fault type.
                                        <br><span class="text-blue-400">&gt;</span> Click "Calculate Faults" to begin
                                        inversion.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- TAB: PV Curve (Voltage Stability) -->
                <div id="content-pv-curve" class="hidden animate-fadeIn">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">PV Curve Analysis (Voltage
                                    Stability)
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">Simulates increasing system load until
                                    voltage
                                    collapse (Nose Curve).</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="playSound(); runPVCurveAnalysis()"
                                    class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2 btn-click">
                                    <i class="ph ph-play"></i> Run PV Analysis
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 h-80 relative bg-slate-50 rounded-lg border border-slate-200 p-2">
                                <canvas id="pvCurveChart"></canvas>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                    <h5 class="text-xs font-bold text-blue-800 uppercase mb-2">Analysis Results
                                    </h5>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Current Load:</span>
                                            <span id="pvCurrentLoad" class="font-mono font-bold text-blue-700">-
                                                MW</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Max Load (P_max):</span>
                                            <span id="pvMaxLoad" class="font-mono font-bold text-purple-700">-
                                                MW</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Collapse Voltage:</span>
                                            <span id="pvCriticalV" class="font-mono font-bold text-red-600">-
                                                p.u.</span>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="bg-yellow-50 p-3 rounded border border-yellow-100 text-xs text-yellow-800 leading-relaxed">
                                    <strong class="block mb-1"><i class="ph ph-lightbulb"></i> Understanding the
                                        Curve:</strong>
                                    The "Nose Point" represents the maximum power transfer capability. operating
                                    beyond this point leads to voltage collapse.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: OPF Results -->
                <div id="content-opf" class="hidden animate-fadeIn">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="p-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                            <h3 class="font-bold text-blue-900">Optimal Power Flow (OPF) Solution</h3>
                            <button onclick="playSound(); runOPFSimulation()"
                                class="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded hover:bg-blue-700 transition flex items-center gap-1">
                                <i class="ph ph-magic-wand"></i> Optimize Grid
                            </button>
                        </div>
                        <div class="overflow-x-auto h-[500px] scroll-custom">
                            <table class="min-w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3">Bus ID</th>
                                        <th class="px-6 py-3">Optimal Mag (p.u.)</th>
                                        <th class="px-6 py-3">Angle</th>
                                        <th class="px-6 py-3 text-right">Gen P <div class="text-[9px] font-normal">[MW]
                                                / [p.u.]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right">Gen Q <div class="text-[9px] font-normal">
                                                [Mvar] / [p.u.]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right">Load P <div class="text-[9px] font-normal">[MW]
                                                / [p.u.]</div>
                                        </th>
                                        <th class="px-6 py-3 text-right">Load Q <div class="text-[9px] font-normal">
                                                [Mvar] / [p.u.]</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="opfTableBody" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: Arc Flash Analysis -->
                <div id="content-arc-flash" class="hidden animate-fadeIn">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">IEEE 1584 Arc Flash Analysis</h3>
                                <p class="text-sm text-gray-500">Incident Energy and Protection Boundary Calculation</p>
                            </div>
                            <div
                                class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                <i class="ph ph-shield-warning"></i> Safety Analysis
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="arcFlashKpis">
                            <!-- Populated via JS -->
                        </div>

                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3">Bus Location</th>
                                        <th class="px-6 py-3 text-center">Fault Current (kA)</th>
                                        <th class="px-6 py-3 text-center">Arcing Time (s)</th>
                                        <th class="px-6 py-3 text-center">Incident Energy (cal/cm²)</th>
                                        <th class="px-6 py-3 text-center">Flash Boundary (in)</th>
                                        <th class="px-6 py-3 text-center">PPE Category</th>
                                    </tr>
                                </thead>
                                <tbody id="arcFlashTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: Harmonic Analysis -->
                <div id="content-harmonics" class="hidden animate-fadeIn">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Total Harmonic Distortion (THD)</h3>
                                <p class="text-sm text-gray-500">Frequency Spectrum and Waveform Analysis</p>
                            </div>
                            <button onclick="playSound(); runHarmonicsAnalysis()"
                                class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2 btn-click">
                                <i class="ph ph-broadcast"></i> Scan Harmonics
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 h-80 relative">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Harmonic Spectrum</h4>
                                <canvas id="harmonicsChart"></canvas>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 h-80 relative">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Distorted Waveform</h4>
                                <canvas id="waveformChart"></canvas>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                <div class="text-xs text-gray-500 font-bold uppercase">THD (Voltage)</div>
                                <div class="text-2xl font-bold text-indigo-600" id="vthdDisplay">0.0%</div>
                            </div>
                            <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                <div class="text-xs text-gray-500 font-bold uppercase">THD (Current)</div>
                                <div class="text-2xl font-bold text-indigo-600" id="ithdDisplay">0.0%</div>
                            </div>
                            <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                <div class="text-xs text-gray-500 font-bold uppercase">Dominant Order</div>
                                <div class="text-2xl font-bold text-slate-800" id="dominantHarmonic">5th</div>
                            </div>
                            <div class="p-4 bg-white border border-gray-200 rounded-lg">
                                <div class="text-xs text-gray-500 font-bold uppercase">IEEE 519 Status</div>
                                <div class="text-2xl font-bold text-emerald-600" id="harmonicsStatus">PASS</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Transient Stability -->
                <div id="content-stability" class="hidden animate-fadeIn">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 space-y-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Transient Stability (Swing Curve)</h3>
                                <p class="text-sm text-gray-500">Rotor Angle response to 3-Phase Fault</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="playSound(); runStabilityAnalysis()"
                                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2 btn-click">
                                    <i class="ph ph-lightning-slash"></i> Trigger Fault
                                </button>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 h-96 relative">
                            <canvas id="stabilityChart"></canvas>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-100">
                                <h5 class="text-xs font-bold text-emerald-800 uppercase mb-1">Crit. Clearing Time</h5>
                                <div class="text-2xl font-bold text-emerald-700 font-mono" id="cctDisplay">0.18s</div>
                                <p class="text-[10px] text-emerald-600 mt-1">CCT calculated based on current loading.
                                </p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h5 class="text-xs font-bold text-blue-800 uppercase mb-1">Damping Ratio</h5>
                                <div class="text-2xl font-bold text-blue-700 font-mono" id="dampingDisplay">0.05</div>
                                <p class="text-[10px] text-blue-600 mt-1">Power System Stabilizer (PSS) active.</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <h5 class="text-xs font-bold text-slate-600 uppercase mb-1">Stability Margin</h5>
                                <div class="text-2xl font-bold text-slate-800 font-mono" id="stabilityMargin">42%</div>
                                <p class="text-[10px] text-slate-500 mt-1">Distance to Out-of-Step condition.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
    </div>
    </main>
    </div>

    <!-- ... (Previous Author/Help/AddLine Modals remain unchanged) ... -->
    <!-- Author Modal -->
    <div id="authorModal"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out]">
            <div class="bg-slate-900 p-6 text-white relative">
                <button onclick="playSound(); closeAuthorModal()"
                    class="absolute top-4 right-4 text-slate-400 hover:text-white transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
                <h3 class="text-xl font-bold">Project Report & Design Team</h3>
                <p class="text-xs text-slate-400 mt-1">Web-Based Smart Grid Simulator Architecture</p>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div
                            class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs">
                            NB</div>
                        <span class="font-medium text-slate-700">Napisah T. Bantog</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div
                            class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold text-xs">
                            JB</div>
                        <span class="font-medium text-slate-700">Josa Daniela F. Bautista</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div
                            class="w-8 h-8 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center font-bold text-xs">
                            JC</div>
                        <span class="font-medium text-slate-700">Joanne O. Cantos</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div
                            class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold text-xs">
                            FF</div>
                        <span class="font-medium text-slate-700">Fernando Jr. F. Faltado</span>
                    </div>
                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded transition">
                        <div
                            class="w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-xs">
                            BL</div>
                        <span class="font-medium text-slate-700">Bryan James T. Litan</span>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-gray-100 text-center">
                    <p class="text-xs font-bold text-slate-800 uppercase tracking-wider">College of Engineering</p>
                    <p class="text-xs text-slate-500 mt-1">Batangas State University<br>The National Engineering
                        University</p>
                </div>
                <!-- Report Button in Authors Page -->
                <div class="mt-6">
                    <button onclick="playSound(); closeAuthorModal(); showManualNRCalculation()"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 group">
                        <i class="ph ph-file-text text-xl group-hover:scale-110 transition-transform"></i>
                        Open Technical Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DAILY ANALYSIS MODAL -->
    <div id="dailyModal"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out] flex flex-col h-[80vh]">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center shadow-md">
                <div class="flex items-center gap-3">
                    <i class="ph ph-clock-countdown text-2xl text-purple-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">24-Hour Cycle Analysis</h3>
                        <p class="text-xs text-slate-400">Time-Series Simulation (Daily Load
                            Profile)
                        </p>
                    </div>
                </div>
                <button onclick="playSound(); closeDailyModal()"
                    class="text-slate-400 hover:text-white bg-slate-700 hover:bg-red-600 w-8 h-8 rounded flex items-center justify-center transition">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>

            <div class="flex-1 bg-slate-50 dark:bg-slate-950 p-6 overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <!-- Left: Controls & Summary -->
                    <div class="lg:col-span-1 space-y-4">
                        <div
                            class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-gray-200 dark:border-slate-700 shadow-sm">
                            <h4 class="font-bold text-gray-700 mb-2">Simulation Parameters</h4>
                            <p class="text-xs text-gray-500 mb-4">Simulates a full day of operation
                                using a standard residential/industrial load curve.</p>

                            <button onclick="playSound(); runDailySimulation()" id="btnRunDaily"
                                class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg shadow-md transition flex items-center justify-center gap-2 mb-4">
                                <i class="ph ph-play-circle text-xl"></i> Run 24H Cycle
                            </button>

                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-gray-500">Peak Load (18:00):</span>
                                    <span class="font-bold text-gray-800" id="dailyPeakLoad">-</span>
                                </div>
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-gray-500">Peak Loss:</span>
                                    <span class="font-bold text-red-600" id="dailyPeakLoss">-</span>
                                </div>
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-gray-500">Lowest Voltage:</span>
                                    <span class="font-bold text-orange-600" id="dailyMinVolt">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h4 class="font-bold text-blue-800 text-xs uppercase mb-2">Insight</h4>
                            <p class="text-xs text-blue-700 leading-relaxed" id="dailyInsight">
                                Click "Run" to generate insights about grid stability during peak
                                hours.
                            </p>
                        </div>
                    </div>

                    <!-- Right: Charts -->
                    <div class="lg:col-span-2 flex flex-col gap-4">
                        <div
                            class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm flex-1 min-h-[250px] relative">
                            <canvas id="dailyLoadChart"></canvas> <!-- Chart 1: Load Curve -->
                        </div>
                        <div
                            class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm flex-1 min-h-[250px] relative">
                            <canvas id="dailyVoltageChart"></canvas>
                            <!-- Chart 2: Min/Max Voltage -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MULTI-UNIT CONFIG MODAL -->
    <div id="multiUnitModal"
        class="hidden fixed inset-0 z-[1100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out]">
            <div class="bg-slate-800 p-5 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="multiUnitIcon"
                        class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-500/20 text-blue-400">
                        <i class="ph ph-factory text-2xl"></i>
                    </div>
                    <div>
                        <h3 id="multiUnitTitle" class="font-bold text-lg">Bus 1 Generators</h3>
                        <p id="multiUnitSubtitle" class="text-xs text-slate-400">Manage multiple generation units for
                            this
                            bus</p>
                    </div>
                </div>
                <button onclick="playSound(); closeMultiUnitModal()" class="text-slate-400 hover:text-white transition">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto scroll-custom bg-slate-50 dark:bg-slate-950">
                <div id="unitList" class="space-y-3">
                    <!-- Units populated here -->
                </div>

                <button onclick="playSound(); addUnitToBus()"
                    class="w-full mt-6 py-3 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl text-slate-500 hover:text-blue-500 hover:border-blue-500 transition-all flex items-center justify-center gap-2 font-bold text-sm">
                    <i class="ph ph-plus-circle"></i> Add New Unit
                </button>
            </div>
            <div
                class="p-5 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <div class="text-slate-500 text-sm">
                    Total: <span id="multiUnitTotal" class="font-bold text-slate-900 dark:text-white">0.00 MW</span>
                </div>
                <button onclick="playSound(); closeMultiUnitModal()"
                    class="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-bold transition">Done</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div
            class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out] flex flex-col max-h-[90vh]">
            <div class="bg-blue-600 p-6 text-white relative">
                <button onclick="playSound(); closeHelp()"
                    class="absolute top-4 right-4 text-blue-200 hover:text-white transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
                <div class="flex items-center gap-3">
                    <i class="ph ph-info text-3xl opacity-80"></i>
                    <div>
                        <h3 class="text-xl font-bold" id="helpTitle">User Guide</h3>
                        <p class="text-xs text-blue-100 mt-1">Educational Resource & Usage Instructions</p>
                    </div>
                </div>
            </div>
            <div class="p-8 overflow-y-auto" id="helpContent">
                <!-- Content injected via JS -->
            </div>
            <div class="bg-gray-50 p-4 border-t border-gray-100 flex justify-end">
                <button onclick="playSound(); closeHelp()"
                    class="px-4 py-2 bg-white border border-gray-300 rounded text-gray-700 text-sm font-bold hover:bg-gray-50 transition btn-click">Close
                    Guide</button>
            </div>
        </div>
    </div>

    <!-- Add Line Modal -->
    <div id="addLineModal"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden animate-[fadeIn_0.3s_ease-out]">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold">Add New Connection</h3>
                <button onclick="playSound(); closeAddLineModal()" class="text-slate-400 hover:text-white"><i
                        class="ph ph-x text-lg"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">From Bus</label>
                    <select id="newFromBus" class="w-full border border-gray-300 rounded p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">To Bus</label>
                    <select id="newToBus" class="w-full border border-gray-300 rounded p-2 text-sm bg-white"></select>
                </div>
                <div id="addLineError" class="text-red-500 text-xs hidden">Cannot connect bus to itself or connection
                    already exists.</div>
                <button onclick="playSound(); confirmAddLine()"
                    class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded transition btn-click">Add
                    Connection</button>
            </div>
        </div>
    </div>



    <!-- SLD MODAL (Separate Window) -->
    <div id="sldModal"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm">
        <div
            class="bg-white rounded-xl shadow-2xl w-full h-full md:w-[95vw] md:h-[90vh] overflow-hidden animate-[fadeIn_0.3s_ease-out] flex flex-col">
            <!-- Modal Header -->
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center shadow-md">
                <div class="flex items-center gap-3">
                    <i class="ph ph-share-network text-2xl text-blue-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">Single Line Diagram</h3>
                        <p class="text-xs text-slate-400">Interactive Network Topology Visualization</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Controls -->
                    <div
                        class="hidden md:flex items-center gap-3 text-xs font-semibold text-slate-300 bg-slate-700/50 px-3 py-1.5 rounded border border-slate-600">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="sldShowVoltage" checked onchange="renderSLD()"
                                class="accent-blue-500"> Show Voltage
                        </label>
                        <span class="text-slate-600">|</span>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="sldShowPower" checked onchange="renderSLD()"
                                class="accent-blue-500"> Show Flow
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="sldShowComponents" checked onchange="renderSLD()"
                                class="accent-blue-500"> Gen/Load
                        </label>
                        <span class="text-slate-600">|</span>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="sldShowPF" onchange="renderSLD()" class="accent-blue-500"> PF
                        </label>
                        <span class="text-slate-600">|</span>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-white transition">
                            <input type="checkbox" id="sldHeatmap" onchange="renderSLD()" class="accent-blue-500">
                            Health (Heatmap)
                        </label>
                    </div>

                    <button onclick="playSound(); closeSLDModal()"
                        class="text-slate-400 hover:text-white bg-slate-700 hover:bg-red-600 w-8 h-8 rounded flex items-center justify-center transition">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Body (Canvas) -->
            <div class="flex-1 bg-slate-50 relative overflow-hidden">
                <div id="sld-container" class="w-full h-full"></div>

                <!-- Legend Overlay -->
                <div id="sldLegend"
                    class="absolute bottom-6 left-6 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border border-gray-200 dark:border-slate-700 p-5 rounded-2xl shadow-2xl text-[10px] text-gray-600 dark:text-gray-300 z-[20] w-56 flex flex-col gap-4 transition-all duration-300 hover:scale-105">

                    <!-- Basic Components -->
                    <div>
                        <div
                            class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2 border-b border-gray-100 dark:border-slate-800 pb-1 flex items-center gap-1">
                            <i class="ph ph-grid-four"></i> Legend
                        </div>
                        <div class="flex flex-wrap gap-x-4 gap-y-2">
                            <span class="flex items-center gap-1.5"><span
                                    class="w-3 h-0.5 bg-gray-900 dark:bg-white inline-block"></span> Bus</span>
                            <span class="flex items-center gap-1.5"><span
                                    class="w-2.5 h-2.5 rounded-full bg-emerald-50 border border-emerald-600 inline-block"></span>
                                Gen</span>
                            <span class="flex items-center gap-1.5"><span
                                    class="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[6px] border-t-purple-600 inline-block"></span>
                                Load</span>
                        </div>
                    </div>

                    <!-- Line Loading -->
                    <div id="loadingLegendSection">
                        <div
                            class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2 border-b border-gray-100 dark:border-slate-800 pb-1 flex items-center gap-1">
                            <i class="ph ph-lightning"></i> Line Loading
                        </div>
                        <div class="space-y-1.5">
                            <span class="flex items-center gap-2">
                                <div class="w-3 h-1 bg-[#3b82f6] rounded-full"></div> &lt; 50% (Normal)
                            </span>
                            <span class="flex items-center gap-2">
                                <div class="w-3 h-1 bg-[#f59e0b] rounded-full"></div> 50 - 85% (Heavy)
                            </span>
                            <span class="flex items-center gap-2">
                                <div class="w-3 h-1 bg-[#ef4444] rounded-full"></div> &gt; 85% (Critical)
                            </span>
                            <span class="flex items-center gap-2">
                                <div class="w-3 h-1 bg-[#8b5cf6] rounded-full border-t border-dashed border-white/30">
                                </div> Transformer
                            </span>
                        </div>
                    </div>

                    <!-- Bus Health (Heatmap) -->
                    <div id="heatmapLegendSection">
                        <div
                            class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2 border-b border-gray-100 dark:border-slate-800 pb-1 flex items-center gap-1">
                            <i class="ph ph-heartbeat"></i> Health (Heatmap)
                        </div>
                        <div class="space-y-1.5">
                            <span class="flex items-center gap-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-[#10b981]"></div> Normal (0.98 - 1.02)
                            </span>
                            <span class="flex items-center gap-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-[#f59e0b]"></div> Warning (±5%)
                            </span>
                            <span class="flex items-center gap-2">
                                <div class="w-2.5 h-2.5 rounded-full bg-[#ef4444]"></div> Critical (&gt; ±5%)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SOUND SYSTEM ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // --- DATA MODEL ---
        // MOVED TO TOP to fix ReferenceError

        // Base Topology (Removed IEEE 30-Bus)
        const baseBranchData = [];

        // Base Line Flows (Removed IEEE 30-Bus)
        const baseLineFlows = [];

        // System OPF Results (Removed IEEE 30-Bus)
        const ieee30OPF = [];

        // --- GUIDED TOUR SYSTEM ---
        const tourSteps = [
            { id: 'displayUserName', title: 'Welcome Operator', text: 'Welcome to PowerSim. You are currently logged in as the system operator.', tab: 'bus-data' },
            { id: 'busCountDisplay', title: 'System Size', text: 'Displays the number of buses in the current system configuration.', tab: 'bus-data' },
            { id: 'input-bus-data', title: 'Bus Configuration', text: 'Define the electrical properties (Generation/Load) for each bus here.', tab: 'bus-data' },
            { id: 'inputTableBody', title: 'Bus Data Table', text: '<strong>Slack Bus (1):</strong> The reference bus.<br><strong>P/Q:</strong> Active/Reactive power injections.', tab: 'bus-data' },
            { id: 'tab-input-topology', title: 'Grid Topology', text: 'Switch to the Topology tab to define the physical transmission lines.', tab: 'topology' },
            { id: 'input-topology', title: 'Topology Editor', text: 'Define the physical transmission lines connecting your buses here.', tab: 'topology' },
            { id: 'btnPopulateTopology', title: 'Auto-Connect', text: 'Use this magic wand to automatically generate standard IEEE connections.', tab: 'topology' },
            { id: 'btnAddLine', title: 'Manual Connection', text: 'Or click here to manually add a transmission line between two buses.', tab: 'topology' },
            { id: 'runBtn', title: 'Run Power Flow', text: 'Click this button to execute the Newton-Raphson Power Flow Algorithm.', tab: 'bus-data' },

            // These will be skipped by logic if results are hidden
            { id: 'resultsState', title: 'Simulation Results', text: 'After running the simulation, detailed analysis and key metrics appear here.', tab: 'results' },
            { id: 'tab-line-flows', title: 'Line Flows', text: 'View real & reactive power flows and losses for every branch.', tab: 'results' },
            { id: 'tab-voltage', title: 'Voltage Profile', text: 'Check voltage magnitudes across the system to identify under/over-voltage issues.', tab: 'results' },
            { id: 'tab-contingency', title: 'N-1 Analysis', text: 'Simulate single-line failures to test system reliability and redundancy.', tab: 'results' },
            { id: 'tab-pv-curve', title: 'Voltage Stability', text: 'Analyze the pV-Curve to determine the voltage collapse point.', tab: 'results' },
            { id: 'dailyLoadChart', title: '24-Hour Cycle', text: 'Visualise the daily load profile and system response over 24 hours.', tab: 'results' }
        ];

        let currentTourStep = 0;

        function startTour() {
            currentTourStep = 0;
            // Create Overlay if not exists
            if (!document.getElementById('tour-overlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'tour-overlay';
                overlay.className = 'tour-overlay';
                document.body.appendChild(overlay);
            }
            showTourStep();
        }

        function endTour() {
            const overlay = document.getElementById('tour-overlay');
            if (overlay) overlay.remove();

            // Remove lingering highlights or tooltips
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            document.querySelectorAll('.tour-tooltip').forEach(el => el.remove());
        }

        function showTourStep() {
            // Cleanup previous
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            document.querySelectorAll('.tour-tooltip').forEach(el => el.remove());

            if (currentTourStep >= tourSteps.length) {
                endTour();
                return;
            }

            const step = tourSteps[currentTourStep];

            // Ensure Tab visible if needed
            if (step.tab === 'bus-data' || step.tab === 'topology') {
                switchInputTab(step.tab);
            } else if (step.tab === 'results' || ['line-flows', 'voltage', 'math', 'contingency'].includes(step.id.replace('tab-', ''))) {
                // For results, we assume results are visible. 
                // If specific result tab is targeted, switch to it.
                if (step.id.startsWith('tab-')) {
                    switchTab(step.id.replace('tab-', ''));
                }
            }

            const target = document.getElementById(step.id);
            if (!target) {
                // Skip if target not found
                currentTourStep++;
                showTourStep();
                return;
            }

            // check visibility
            const rect = target.getBoundingClientRect();
            if (rect.width === 0 && rect.height === 0) {
                // Element is hidden, skip step
                currentTourStep++;
                showTourStep();
                return;
            }

            // Highlight Target
            target.classList.add('tour-highlight');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Create Tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'tour-tooltip';
            tooltip.innerHTML = `
                <h4>${step.title}</h4>
                <p>${step.text}</p>
                <div class="tour-footer">
                    <button class="tour-btn tour-btn-skip" onclick="endTour()">Skip Tour</button>
                    <button class="tour-btn tour-btn-next" onclick="nextTourStep()">
                        ${currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Next'}
                    </button>
                </div>
            `;

            // Improved Positioning Logic
            const tooltipWidth = 300; // Approx max width
            const tooltipHeight = 150; // Approx max height
            const margin = 10;

            // Calculate available space
            const spaceBelow = window.innerHeight - rect.bottom;
            const spaceAbove = rect.top;

            let top, left;

            // Vertical Position: Prefer Bottom, flip to Top if crowded
            if (spaceBelow < tooltipHeight + margin && spaceAbove > tooltipHeight + margin) {
                // Place Above
                top = rect.top - tooltipHeight - margin;
                tooltip.classList.add('top');
            } else {
                // Place Below (Default)
                top = rect.bottom + margin;
                tooltip.classList.add('bottom');
            }

            // Horizontal Position: Center, but clamp to viewport
            left = rect.left + (rect.width / 2) - (tooltipWidth / 2);

            // Clamp Left Edge
            if (left < margin) left = margin;
            // Clamp Right Edge
            if (left + tooltipWidth > window.innerWidth - margin) {
                left = window.innerWidth - tooltipWidth - margin;
            }

            // Apply absolute positioning including scroll
            tooltip.style.top = `${top + window.scrollY}px`;
            tooltip.style.left = `${left + window.scrollX}px`;

            document.body.appendChild(tooltip);
        }

        function nextTourStep() {
            currentTourStep++;
            showTourStep();
        }

        // Base Case Data (Removed IEEE 30-Bus)
        const ieee30Base = [];

        let userName = "Guest";

        // Initial State: Empty
        let currentData = [];
        let activeBranches = [];
        let isSimulationSolved = false;
        let chartInstance = null;
        let network = null; // Vis.js instance

        // --- APP FLOW ---
        function startApp() {
            const nameInput = document.getElementById('introNameInput');
            if (nameInput.value.trim() === "") {
                document.getElementById('nameError').classList.remove('hidden');
                return;
            }

            userName = nameInput.value;
            const displayEl = document.getElementById('displayUserName');
            if (displayEl) displayEl.innerText = userName;
            const pdfUserEl = document.getElementById('pdfUserName');
            if (pdfUserEl) pdfUserEl.innerText = userName;

            // Fade out intro, show setup modal
            document.getElementById('introPage').classList.add('hidden');
            document.getElementById('setupModal').classList.remove('hidden');
        }

        // Removed initStandardSystem function


        // --- NOTIFICATION SYSTEM ---
        function showNotification(title, message, type = 'error') {
            const modal = document.getElementById('notificationModal');
            const iconEl = document.getElementById('notifyIcon');
            const headerEl = document.getElementById('notifyHeader');
            const titleEl = document.getElementById('notifyTitle');
            const msgEl = document.getElementById('notifyMessage');

            // Configure Theme
            let colorHeader = 'bg-red-500';
            let colorIcon = 'bg-red-50 dark:bg-red-900/20 text-red-500';
            let iconHtml = '<i class="ph ph-warning-octagon"></i>';

            if (type === 'success') {
                colorHeader = 'bg-emerald-500';
                colorIcon = 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600';
                iconHtml = '<i class="ph ph-check-circle"></i>';
            } else if (type === 'info') {
                colorHeader = 'bg-blue-500';
                colorIcon = 'bg-blue-50 dark:bg-blue-900/20 text-blue-600';
                iconHtml = '<i class="ph ph-info"></i>';
            }

            headerEl.className = `h-1.5 w-full ${colorHeader}`;
            iconEl.className = `w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-4 text-2xl transition-colors ${colorIcon}`;
            iconEl.innerHTML = iconHtml;

            titleEl.innerText = title;
            msgEl.innerText = message;

            modal.classList.remove('hidden');
        }

        function closeNotification() {
            document.getElementById('notificationModal').classList.add('hidden');
        }

        function initCustomSystem() {
            let count = parseInt(document.getElementById('setupBusCount').value) || 5;

            // Validate Range with new Modal
            if (count < 3 || count > 15) {
                showNotification("Invalid Grid Size", "Please enter a value between 3 and 15 buses to ensure stable simulation boundaries.", "error");
                return;
            }

            document.getElementById('setupModal').classList.add('hidden');

            // Create Empty Buses
            currentData = [];
            for (let i = 1; i <= count; i++) {
                currentData.push({
                    bus: i, mag: 1.0, ang: 0,
                    gp: 0, gq: 0, generators: [],
                    lp: 0, lq: 0, loads: [],
                    injQ: 0, type: i === 1 ? 'Slack' : 'PQ'
                });
            }
            activeBranches = []; // Clear branches for new system
            isSimulationSolved = false;

            // Update UI Reflectors
            renderInputTable();
            renderTopologyInput();
            renderSidebarTopology();
            initAddLineModal(); // Refresh dropdowns with new buses

            // Update Bus Count Input in Dashboard
            const dashDisplay = document.getElementById('busCountDisplay');
            if (dashDisplay) dashDisplay.innerText = count;

            calculateVoltageBases();
            launchMainApp();
        }

        function launchMainApp() {
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('fade-in');

            // UX Improvement: Auto-switch to Bus Data and Highlight Actions
            switchInputTab('bus-data');

            // Highlight buttons to guide user
            const btnValues = document.getElementById('btnPopulateValues');
            const btnTopology = document.getElementById('btnPopulateTopology');

            [btnValues, btnTopology].forEach(btn => {
                if (btn) {
                    btn.classList.add('ring-4', 'ring-amber-300', 'animate-pulse');
                    // Remove highlight after 5 seconds or on click
                    setTimeout(() => {
                        btn.classList.remove('ring-4', 'ring-amber-300', 'animate-pulse');
                    }, 5000);

                    // Also remove on click (event listener overkill but safer to just timeout)
                }
            });
        }

        // --- RESET TO LANDING ---
        function goToLanding() {
            // Hide App
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('fade-in');

            // Reset Data
            currentData = [];
            activeBranches = [];

            // Reset User Identity
            document.getElementById('introNameInput').value = '';
            const displayEl = document.getElementById('displayUserName');
            if (displayEl) displayEl.innerText = "Guest";
            userName = "Guest";

            // Reset Inputs
            if (document.getElementById('setupBusCount')) document.getElementById('setupBusCount').value = "5";
            if (document.getElementById('busCountDisplay')) document.getElementById('busCountDisplay').innerText = "0";

            // Clear Result Tables
            const tables = ['lineFlowTableBody', 'complianceTableBody', 'inputTableBody', 'topologyTableBody'];
            tables.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });

            // Reset KPIs
            if (document.getElementById('totalLoadDisplay')) document.getElementById('totalLoadDisplay').innerText = "0 MW";
            if (document.getElementById('totalLossDisplay')) document.getElementById('totalLossDisplay').innerText = "0 MW";
            if (document.getElementById('complianceStatus')) {
                document.getElementById('complianceStatus').innerText = "Unknown";
                document.getElementById('complianceStatus').className = "text-2xl font-bold text-gray-400 mt-1";
            }

            // Reset Solver Log
            if (document.getElementById('interactiveMathLog')) {
                document.getElementById('interactiveMathLog').innerHTML = "<span class='text-gray-500 opacity-50'>System Ready.</span>";
            }

            // Reset View State to Input
            document.getElementById('resultsState').classList.add('hidden');
            document.getElementById('inputState').classList.remove('hidden');

            // Show Intro (Landing Page)
            document.getElementById('introPage').classList.remove('hidden');
        }

        // --- SCENARIO MANAGEMENT ---
        function exportScenario() {
            const scenario = {
                timestamp: new Date().toISOString(),
                user: userName,
                description: "Smart Grid Simulator Scenario",
                busCount: currentData.length,
                data: currentData,
                topology: activeBranches
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scenario, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `grid-scenario-${new Date().toISOString().slice(0, 10)}.json`);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importScenario(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const scenario = JSON.parse(e.target.result);

                    // Basic Validation
                    if (!scenario.data || !Array.isArray(scenario.data) || !scenario.topology) {
                        alert("Invalid Scenario File Format. Missing data or topology.");
                        return;
                    }

                    // Load Data & Ensure compatibility with multi-unit system
                    currentData = scenario.data.map(bus => ({
                        ...bus,
                        generators: bus.generators || (bus.gp > 0 || bus.gq > 0 ? [{ id: 1, name: "Main Gen", p: bus.gp || 0, q: bus.gq || 0 }] : []),
                        loads: bus.loads || (bus.lp > 0 || bus.lq > 0 ? [{ id: 1, name: "City Load", p: bus.lp || 0, q: bus.lq || 0 }] : [])
                    }));
                    activeBranches = scenario.topology;

                    // Update User context if reasonable (optional)
                    // if(scenario.user) userName = scenario.user;

                    // Update UI Reflections
                    renderInputTable();
                    renderTopologyInput();
                    renderSidebarTopology();
                    initAddLineModal();

                    // Update Bus Count Display
                    const disp = document.getElementById('busCountDisplay');
                    if (disp) disp.innerText = currentData.length;

                    calculateVoltageBases();

                    // Reset View
                    resetSimulation();

                    // Feedback
                    // alert("Scenario loaded successfully with " + currentData.length + " buses.");
                    // Use a toast or subtle indication instead of alert if possible, but alert is fine for now.

                } catch (err) {
                    console.error(err);
                    alert("Error parsing JSON file. Please ensure it is a valid scenario file.");
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input so same file can be selected again
        }

        // --- HELP SYSTEM CONTENT ---
        const helpTopics = {
            intro: {
                title: "Welcome to the Smart Grid Simulator",
                content: `
                    <p class="mb-4 text-gray-700 leading-relaxed">
                        This interactive tool simulates the operation of various electrical network configurations using the Newton-Raphson method. It is designed to help students and engineers understand the complex behavior of electrical grids.
                    </p>
                    
                    <h4 class="font-bold text-gray-800 mb-2 border-b border-gray-200 pb-1">Key Features:</h4>
                    <ul class="list-disc ml-5 mb-5 space-y-2 text-gray-600">
                        <li><strong>Interactive Configuration:</strong> Create your own grid topology with 3 to 15 buses.</li>
                        <li><strong>Real-Time Solver:</strong> Watch the Newton-Raphson algorithm iterate step-by-step with live MathJax equations.</li>
                        <li><strong>Visual Analytics:</strong> View the Single Line Diagram (SLD), voltage profiles, and line flow heatmaps.</li>
                        <li><strong>Compliance Checking:</strong> Automatically validates results against the Philippine Grid Code (PGC) standards.</li>
                    </ul>

                    <h4 class="font-bold text-gray-800 mb-2 border-b border-gray-200 pb-1">Getting Started:</h4>
                    <p class="text-gray-600 mb-2">
                        You are currently in the <strong>Configuration Mode</strong>. Use the tabs on the left to set up your system boundaries (Buses) and connections (Lines). When ready, hit the blue <strong>Run Simulation</strong> button in the top right.
                    </p>
                `
            },
            procedure: {
                title: "Comprehensive User Guide & Procedures",
                content: `
                    <div class="space-y-6 text-gray-700">
                        <!-- MERGED INTRO SECTION -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                            <p class="mb-4 text-sm text-blue-900 leading-relaxed">
                                This interactive tool simulates the operation of the <strong>IEEE 30-Bus System</strong> and custom user-defined grids. It utilizes the Newton-Raphson method to solve power flow equations and is designed to comply with PGC standards.
                            </p>
                            <h5 class="font-bold text-blue-800 text-sm mb-2">Key Features at a Glance:</h5>
                            <ul class="list-disc ml-5 space-y-1 text-xs text-blue-800">
                                <li><strong>Custom Topology:</strong> Modify buses, generation, loads, and lines.</li>
                                <li><strong>Live Solver:</strong> Step-by-step visualization of the Newton-Raphson iteration.</li>
                                <li><strong>N-1 Analysis:</strong> Test grid reliability against line faults.</li>
                                <li><strong>Compliance:</strong> Automatic checking against Philippine Grid Code voltage/frequency limits.</li>
                            </ul>
                        </div>
                        
                        <section>
                            <h4 class="font-bold text-blue-700 text-lg mb-2 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span> 
                                Getting Started
                            </h4>
                            <p class="text-sm text-gray-600 mb-3">Follow this standard workflow to perform a simulation:</p>
                        </section>

                        <section>
                            <h4 class="font-bold text-blue-700 text-lg mb-2 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span> 
                                Configuration
                            </h4>
                            <p class="mb-2 text-sm">Choose how you want to start:</p>
                            <ul class="list-disc ml-8 space-y-1 text-sm text-gray-600">
                                <li><strong>Custom System:</strong> Use the "Populate Test Values" or "Add New Bus" buttons to build a system from scratch (3-15 buses).</li>
                            </ul>
                        </section>

                        <section>
                            <h4 class="font-bold text-blue-700 text-lg mb-2 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span> 
                                Configuration
                            </h4>
                            <div class="pl-8 space-y-3">
                                <div>
                                    <h5 class="font-bold text-sm text-gray-800">A. Bus Data Management</h5>
                                    <p class="text-sm text-gray-600">Navigate to the <strong>Bus Data</strong> tab. Here you can:</p>
                                    <ul class="list-disc ml-4 text-xs text-gray-500 mt-1">
                                        <li>Set <strong>Generation (MW/Mvar)</strong> for generator buses.</li>
                                        <li>Define <strong>Load (MW/Mvar)</strong> for consumer buses.</li>
                                        <li>Add <strong>Shunt Injection</strong> (Capacitor Banks) if needed.</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 class="font-bold text-sm text-gray-800">B. Topology Management</h5>
                                    <p class="text-sm text-gray-600">Navigate to the <strong>Grid Topology</strong> tab to define lines:</p>
                                    <ul class="list-disc ml-4 text-xs text-gray-500 mt-1">
                                        <li>Click <strong>Add Line</strong> to connect two buses.</li>
                                        <li>Use <strong>Populate Topology</strong> to automatically create a valid network graph.</li>
                                        <li>Remove lines to simulate N-1 contingency scenarios (faults).</li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h4 class="font-bold text-blue-700 text-lg mb-2 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span> 
                                Simulation & Analysis
                            </h4>
                            <ol class="list-decimal ml-8 space-y-2 text-sm text-gray-600">
                                <li>Click <strong>Run Simulation</strong> in the navbar.</li>
                                <li>Wait for the <strong>Newton-Raphson Solver</strong> to converge. You can watch the mathematical steps in the "Newton-Raphson Logic" tab.</li>
                                <li>Once converged, review the results:
                                    <ul class="list-disc ml-4 mt-1 text-xs">
                                        <li><strong>Line Flows & Losses:</strong> Check the "Line Flows" tab for active/reactive power flow and transmission losses.</li>
                                        <li><strong>Compliance:</strong> essential for verifying if voltages are within the 0.95 - 1.05 p.u. range (PGC standard).</li>
                                        <li><strong>Voltage Profile:</strong> View the bar chart to spot voltage dips or swells.</li>
                                        <li><strong>Visual SLD:</strong> Click "View SLD" in the navbar to see the interactive diagram.</li>
                                    </ul>
                                </li>
                            </ol>
                        </section>
                    </div >
            `
            },
            config: {
                title: "System Configuration Guide",
                content: `
            <p class="mb-3">The configuration section allows you to modify the physical state of the power grid before running a simulation.</p>
                    <p class="mb-3">The system initializes with a custom editable grid. You can simulate different scenarios (e.g., peak load, generator failure) by changing the values in the table.</p>
                    <p class="text-sm text-gray-500 italic">Tip: If you make a mistake or the system becomes unstable, click "Reset Defaults" to restore the starting point.</p>
        `
            },
            busData: {
                title: "Understanding Bus Data (Table 1)",
                content: `
            <p class="mb-3">This table defines the state of every bus(node) in the network.</p>
                <div class="space-y-3">
                    <div class="bg-blue-50 p-3 rounded border border-blue-100">
                        <strong class="text-blue-800">Generation (P & Q)</strong>
                        <p class="text-sm text-blue-700">Power created by power plants. <strong>P</strong> is Active Power (MW) which does the work. <strong>Q</strong> is Reactive Power (Mvar) needed to maintain voltage levels.</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded border border-purple-100">
                        <strong class="text-purple-800">Load (P & Q)</strong>
                        <p class="text-sm text-purple-700">Power consumed by cities or factories connected to that bus.</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded border border-gray-100">
                        <strong class="text-gray-800">Injection (Q)</strong>
                        <p class="text-sm text-gray-700">Capacitor banks or reactors added to support voltage locally.</p>
                    </div>
                </div>
        `
            },
            topology: {
                title: "Grid Topology & Transmission Lines",
                content: `
            <p class="mb-3">The topology defines how buses are connected. Transmission lines carry power between buses.</p>
                    <ul class="list-disc ml-5 mb-4 space-y-2">
                        <li><strong>Redundancy:</strong> Loops in the grid provide reliability. If one line fails, power can flow through another path.</li>
                        <li><strong>Radial vs. Meshed:</strong> Transmission systems often use meshed networks for high-reliability energy delivery.</li>
                    </ul>
                    <p class="mb-3"><strong>Simulator Action:</strong> You can "Add Line" to create new paths or click the Trash icon to simulate a line trip/failure.</p>
        `
            },
            results: {
                title: "Interpreting Simulation Results",
                content: `
            <p class="mb-3">After clicking "Run Simulation", the app performs a <strong>Newton-Raphson Power Flow</strong> calculation. This solves the complex non-linear equations of the grid.</p>
                    <h4 class="font-bold text-gray-800 mb-2">Key Metrics:</h4>
                    <ul class="list-disc ml-5 mb-4 space-y-2">
                        <li><strong>Total Generation vs Load:</strong> Generation must always equal Load + Losses.</li>
                        <li><strong>System Losses:</strong> Energy lost as heat in transmission lines (I²R losses). Lower is better.</li>
                        <li><strong>Line Flows:</strong> Shows how much power is moving through each specific wire.</li>
                    </ul>
        `
            },
            compliance: {
                title: "PGC & PDC Compliance Standards",
                content: `
            <p class="mb-4">Grid operators must ensure voltage levels remain stable to prevent equipment damage or blackouts.</p>
                    <div class="space-y-4">
                        <div class="border-l-4 border-green-500 pl-4">
                            <h5 class="font-bold text-gray-800">Philippine Grid Code (PGC)</h5>
                            <p class="text-sm text-gray-600">Standard for High Voltage Transmission.</p>
                            <p class="text-sm font-mono bg-gray-100 inline-block px-2 py-1 rounded mt-1">Limit: 0.95 p.u. to 1.05 p.u. (±5%)</p>
                        </div>
                        <div class="border-l-4 border-yellow-500 pl-4">
                            <h5 class="font-bold text-gray-800">Philippine Distribution Code (PDC)</h5>
                            <p class="text-sm text-gray-600">Standard for Lower Voltage Distribution (End-users).</p>
                            <p class="text-sm font-mono bg-gray-100 inline-block px-2 py-1 rounded mt-1">Limit: 0.90 p.u. to 1.10 p.u. (±10%)</p>
                        </div>
                    </div>
                    <p class="mt-4 text-sm text-gray-500"><strong>p.u. (Per Unit):</strong> A normalized value. 1.0 p.u. represents the ideal rated voltage (e.g., 230 kV). 0.95 p.u. means 95% of rated voltage.</p>
        `
            },
            faultAnalysis: {
                title: "Short Circuit & Fault Analysis",
                content: `
                    <p class="mb-4 text-gray-700 leading-relaxed">
                        Fault analysis determines the maximum currents that flow during an electrical failure. This is critical for sizing <strong>Circuit Breakers</strong> and protection relays.
                    </p>
                    <div class="space-y-4">
                        <div class="bg-orange-50 p-3 rounded border border-orange-100">
                            <h5 class="font-bold text-orange-900 text-sm">Balanced Fault (3-Phase)</h5>
                            <p class="text-xs text-orange-800">All three phases are shorted together. Usually produces the highest fault current in transmission systems.</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                            <h5 class="font-bold text-blue-900 text-sm">Unbalanced Faults</h5>
                            <ul class="list-disc ml-4 text-xs text-blue-800 space-y-1">
                                <li><strong>L-G (Line-to-Ground):</strong> One phase hits the ground. Most common fault type.</li>
                                <li><strong>L-L (Line-to-Line):</strong> Two phases touch each other.</li>
                                <li><strong>L-L-G (Double Line-to-Ground):</strong> Two phases hit the ground simultaneously.</li>
                            </ul>
                        </div>
                    </div>
                    <p class="mt-4 text-xs text-gray-500">
                        The simulator uses <strong>Sequence Components</strong> (Positive, Negative, and Zero) to compute these unbalanced currents accurately using the Z-Bus matrix.
                    </p>
                `
            },
            tabSLD: {
                title: "Single Line Diagram",
                content: `
            <p class="mb-3">This tab visualizes the electrical network topology using standard symbols.</p>
                    <ul class="list-disc ml-5 space-y-2">
                        <li><strong>Black Bar:</strong> Represents a Bus (Node).</li>
                        <li><strong>Circle:</strong> Represents a Generator.</li>
                        <li><strong>Triangle (Arrow):</strong> Represents a Load.</li>
                        <li><strong>Lines:</strong> Represent transmission lines connecting buses.</li>
                    </ul>
                    <p class="mt-2 text-sm text-gray-500">You can drag nodes to rearrange the view. The layout updates automatically if you add/remove buses.</p>
        `
            },
            arcFlash: {
                title: "Arc Flash Analysis (IEEE 1584)",
                content: `<p>Calculates the incident energy and protection boundaries for electrical safety. Helps determine the required PPE (Personal Protective Equipment) for maintenance.</p>`
            },
            harmonics: {
                title: "Harmonic Distortion Analysis",
                content: `<p>Evaluates the Total Harmonic Distortion (THD) caused by non-linear loads. Essential for maintaining power quality and preventing equipment overheating.</p>`
            },
            stability: {
                title: "Transient Stability Analysis",
                content: `<p>Analyzes the grid's ability to remain in synchronism after a major disturbance, like a 3-phase fault. Visualized using the Generator Swing Curve.</p>`
            },
            // --- NEW TOPICS ---
            gridStatus: {
                title: "Grid Status Indicator",
                content: `
            <p class="mb-3">This indicator shows if the power grid is electrically <strong>coherent</strong>.</p>
                <ul class="list-disc ml-5 mb-4 space-y-2">
                    <li><strong>Connected:</strong> All buses can reach each other. The slack bus can support the entire system.</li>
                    <li><strong>Islanded:</strong> The grid has split into separate pieces. This usually causes simulation failure because one island lacks a power source.</li>
                </ul>
        `
            },
            liveConnections: {
                title: "Live Connection Feed",
                content: `
            <p>This sidebar list represents the real-time "digital twin" of the transmission network. It updates dynamically as you add or remove lines in the topology editor.</p>
                <p class="mt-2 text-sm text-gray-500">It helps you visualize the density of connections in the network.</p>
        `
            },
            resetDefaults: {
                title: "Reset IEEE 30-Bus Defaults",
                content: `
            <p>Clicking this button completely <strong>discards all your changes</strong> to bus data and topology.</p>
                <p class="mt-2">It clears the system and resets all parameters to their initial default state. Use this if your simulation stops converging or you want to start over.</p>
        `
            },
            preSim: {
                title: "Pre-Simulation Mode",
                content: `
            <p>You are currently in <strong>Edit Mode</strong>. The values you see are input parameters.</p>
                <p class="mt-2">The physics engine is not running yet. Changes you make here (like increasing Load MW) will not affect voltages until you click <strong>Run Simulation</strong>.</p>
        `
            },
            busColumn: {
                title: "Bus ID",
                content: `
            <p>A unique identifier for each node(substation) in the power system.</p>
                <p class="mt-2"><strong>Bus 1</strong> is typically the <strong>Slack Bus</strong> (Reference Bus) which balances the system's power.</p>
        `
            },
            genColumn: {
                title: "Generation (P & Q)",
                content: `
            <p><strong>P (Active Power):</strong> The actual energy doing work (Megawatts). Supplied by turbines.</p>
                <p class="mt-2"><strong>Q (Reactive Power):</strong> The power required to maintain magnetic fields (Megavars). Supplied by exciters.</p>
        `
            },
            loadColumn: {
                title: "Load (P & Q)",
                content: `
            < p > The power demand at this bus.Represents the aggregate consumption of a city or industrial zone.</p >
                <p class="mt-2">Changing these values simulates peak load (high demand) or off-peak (low demand) scenarios.</p>
        `
            },
            injColumn: {
                title: "Reactive Injection (Q)",
                content: `
            < p > Static devices attached to the bus to support voltage.</p >
                <ul class="list-disc ml-5 mt-2 space-y-1">
                    <li><strong>Positive:</strong> Capacitor Bank (Boosts Voltage).</li>
                    <li><strong>Negative:</strong> Reactor (Lowers Voltage).</li>
                </ul>
        `
            },
            topologyList: {
                title: "Topology List",
                content: `
            <p>This table defines the physical wires connecting the buses. You can delete lines to simulate faults (N-1 Contingency Analysis).</p>
                `
            },
            addLine: {
                title: "Add Transmission Line",
                content: `
                <p>Opens a tool to build new connections. Adding parallel lines increases capacity and reliability but reduces the total impedance between buses.</p>
                    `
            },
            kpiGen: {
                title: "Total Generation",
                content: `
                    <p class="text-2xl font-bold text-blue-600 mb-2">Σ Gen = Σ Load + Σ Losses</p>
                        <p>The sum of all power produced by generators. This value is calculated <strong>after</strong> the simulation to ensure it exactly meets demand plus system inefficiencies.</p>
        `
            },
            kpiLoad: {
                title: "Total System Load",
                content: `
            <p>The total power demand requested by consumers across all 30 buses. This is your independent variable—the system must work to meet this target.</p>
                `
            },
            kpiLoss: {
                title: "System Losses (I²R)",
                content: `
                <p>Energy wasted as heat in the transmission lines.</p>
                    <p class="mt-2"><strong>Formula:</strong> Loss = I² × R</p>
                    <p>High losses mean the grid is inefficient, often caused by transmitting power over long distances or overloading lines.</p>
        `
            },
            kpiStatus: {
                title: "Grid Code Status",
                content: `
            <p>A quick summary of regulatory compliance.</p>
                <ul class="list-disc ml-5 mt-2 space-y-1">
                    <li><strong>COMPLIANT:</strong> All bus voltages are within limits.</li>
                    <li><strong>NON-COMPLIANT:</strong> At least one bus is experiencing under-voltage or over-voltage.</li>
                </ul>
        `
            },
            tabLineFlows: {
                title: "Table 2: Line Flows",
                content: `
            <p>Detailed breakdown of power movement through every line.</p>
                <p class="mt-2">Allows you to spot <strong>Congestion</strong> (overloaded lines) and identify where the most power is being lost.</p>
        `
            },
            tabOPF: {
                title: "Table 5: OPF Results",
                content: `
            <p><strong>Optimal Power Flow (OPF)</strong> results showing the final state of every bus after the Newton-Raphson solver converges.</p>
                <p class="mt-2">This is the "Answer Key" to your simulation configuration.</p>
        `
            },
            tabVoltage: {
                title: "Voltage Profile Chart",
                content: `
            <p>A visual graph of voltage stability.</p>
                <p class="mt-2">Look for the line dipping below <strong>0.95</strong> (Sag) or rising above <strong>1.05</strong> (Swell). A flat line near 1.0 is ideal.</p>
        `
            },
            flowColumn: {
                title: "Power Flow Direction",
                content: `
            <p>Power can flow from Bus A to B, or B to A, depending on voltage angles.</p>
                    <p class="mt-2"><strong>From&rarr;To:</strong> Power leaving the first bus.</p>
                    <p><strong>To&rarr;From:</strong> Power arriving at the second bus (usually slightly less due to losses).</p>
        `
            },
            lossColumn: {
                title: "Line Loss (P & Q)",
                content: `
            <p>The difference between power sent and power received.</p>
                <p class="mt-2">This energy heats up the aluminum conductors in the transmission lines.</p>
        `
            },
            opfMag: {
                title: "Voltage Magnitude (p.u.)",
                content: `
            <p>The pressure of electricity at the bus, normalized to a base value (Per Unit).</p>
                <p class="mt-2"><strong>1.0 p.u. = 100% Rated Voltage</strong> (e.g., 230 kV).</p>
        `
            },
            opfAngle: {
                title: "Voltage Angle (deg)",
                content: `
            <p>The phase shift of the AC waveform relative to the Slack Bus (0°).</p>
                <p class="mt-2">Power flows from <strong>Higher Angle</strong> to <strong>Lower Angle</strong>. Larger differences mean heavier power flow.</p>
        `
            }
        };

        // --- INIT ---
        window.onload = () => {
            renderInputTable();
            renderTopologyInput();
            renderSidebarTopology();
            initAddLineModal();

            // Link Base KV Input to Propagation Logic
            const kbInput = document.getElementById('baseKVInput');
            if (kbInput) {
                kbInput.addEventListener('change', () => {
                    calculateVoltageBases();
                    renderInputTable();
                });
            }
        };

        function openAuthorModal() {
            document.getElementById('authorModal').classList.remove('hidden');
        }

        function closeAuthorModal() {
            document.getElementById('authorModal').classList.add('hidden');
        }

        // --- HELP SYSTEM LOGIC ---
        function openHelp(topic) {
            const data = helpTopics[topic];
            if (data) {
                document.getElementById('helpTitle').innerText = data.title;
                document.getElementById('helpContent').innerHTML = data.content;
                document.getElementById('helpModal').classList.remove('hidden');
            }
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        function switchInputTab(id) {
            ['bus-data', 'topology'].forEach(t => {
                const el = document.getElementById(`input-${t}`);
                if (el) el.classList.add('hidden');

                const tab = document.getElementById(`tab-input-${t}`);
                if (tab) {
                    tab.classList.remove('tab-active');
                    tab.classList.add('tab-inactive', 'border-transparent');
                }
            });
            const targetEl = document.getElementById(`input-${id}`);
            if (targetEl) targetEl.classList.remove('hidden');

            const targetTab = document.getElementById(`tab-input-${id}`);
            if (targetTab) {
                targetTab.classList.add('tab-active');
                targetTab.classList.remove('tab-inactive', 'border-transparent');
            }
        }

        // --- RENDERERS ---

        function renderSidebarTopology() {
            const list = document.getElementById('sidebarTopologyList');
            list.innerHTML = '';
            activeBranches.forEach((b) => {
                list.innerHTML += `
            <li class="flex justify-between items-center p-1 hover:bg-blue-50 dark:hover:bg-slate-700/50 rounded group cursor-default border-b border-transparent dark:border-slate-800">
                    <span class="text-xs text-gray-400 dark:text-gray-500 font-mono group-hover:text-blue-500 dark:group-hover:text-blue-400 transition">L${b.id}</span>
                    <span class="text-slate-700 dark:text-slate-300 font-medium text-xs">Bus ${b.from} <i class="ph ph-arrows-left-right text-[10px] text-gray-400"></i> Bus ${b.to}</span>
                </li>`;
            });
        }

        function renderInputTable() {
            const tbody = document.getElementById('inputTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            currentData.forEach((row, index) => {
                const isSlack = row.type === 'Slack' || row.bus === 1;
                const type = row.type || (isSlack ? 'Slack' : 'PQ');
                const isPV = type === 'PV';
                const isPQ = type === 'PQ';

                let typeLabel = type === 'Slack' ? 'Slack' : (isPV ? 'PV Bus' : 'PQ Bus');
                let typeClass = '';
                if (isSlack) {
                    typeClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                } else if (isPV) {
                    typeClass = 'bg-green-100 text-green-800 border-green-200';
                } else {
                    typeClass = 'bg-blue-100 text-blue-800 border-blue-200';
                }

                const baseKV = row.baseKV || parseFloat(document.getElementById('baseKVInput').value) || 230;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 border-b border-gray-100 dark:border-slate-700 transition">
                        <td class="px-4 py-2 font-bold text-gray-700 dark:text-gray-200 bg-gray-50/50 dark:bg-slate-800/50">
                            <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2">
                                    <span>Bus ${row.bus}</span>
                                    <span class="text-[9px] font-mono text-slate-400 font-normal">(${baseKV}kV)</span>
                                </div>
                                ${isSlack ?
                        `<span class="text-[9px] px-1.5 py-0.5 rounded border uppercase tracking-wide font-normal w-fit ${typeClass}">Slack</span>` :
                        `<select onchange="updateData(${index}, 'type', this.value)" 
                                            class="text-[9px] px-1 py-0.5 rounded border uppercase tracking-wide font-bold w-fit outline-none cursor-pointer ${typeClass} dark:bg-slate-800">
                                        <option value="PQ" ${isPQ ? 'selected' : ''}>PQ BUS</option>
                                        <option value="PV" ${isPV ? 'selected' : ''}>PV BUS</option>
                                    </select>`
                    }
                            </div>
                        </td>
                        
                        <td class="px-4 py-2 border-l border-gray-100 dark:border-slate-700">
                            <input type="${isPQ && !isSimulationSolved ? 'text' : 'number'}" step="0.01" 
                                class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full focus:outline-none ${isPQ ? 'text-gray-400 font-normal italic' : 'font-bold'}" 
                                value="${isPQ && !isSimulationSolved ? 'Unknown' : row.mag}" onchange="updateData(${index}, 'mag', this.value)" 
                                ${isPQ ? 'readonly' : ''}
                                title="${isPQ ? 'Voltage Magnitude is CALCULATED for PQ Bus' : 'Specified Parameter'}">
                        </td>
                        <td class="px-4 py-2">
                            <input type="${!isSlack && !isSimulationSolved ? 'text' : 'number'}" step="0.1" 
                                class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full focus:outline-none ${!isSlack ? 'text-gray-400 font-normal italic' : 'font-bold'}" 
                                value="${!isSlack && !isSimulationSolved ? 'Unknown' : row.ang}" onchange="updateData(${index}, 'ang', this.value)"
                                ${!isSlack ? 'readonly' : ''}
                                title="${!isSlack ? 'Phase Angle is CALCULATED for non-Slack Bus' : 'Fixed Reference'}">
                        </td>

                        <td class="px-4 py-2 border-l border-gray-100 dark:border-slate-700">
                            <div class="flex items-center gap-2">
                                <input type="${isSlack && !isSimulationSolved ? 'text' : 'number'}" 
                                    class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full focus:outline-none ${isSlack ? 'text-gray-400 font-normal italic' : 'font-bold'}" 
                                    value="${isSlack && !isSimulationSolved ? 'Unknown' : (row.gp || 0).toFixed(2)}" 
                                    onchange="updateData(${index}, 'gp', this.value)"
                                    ${isSlack ? 'readonly' : ''}>
                                ${!isSlack ? `
                                <button onclick="playSound(); openMultiUnitModal(${index}, 'gen')" 
                                    class="text-blue-500 hover:text-blue-700 p-1 rounded hover:bg-blue-50 transition" title="Manage Multiple Generators">
                                    <i class="ph ph-list-plus text-sm"></i>
                                </button>` : ''}
                            </div>
                        </td>
                        <td class="px-4 py-2">
                            <input type="${(isSlack || isPV) && !isSimulationSolved ? 'text' : 'number'}" 
                                class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full focus:outline-none ${isSlack || isPV ? 'text-gray-400 font-normal italic' : 'font-bold'}" 
                                value="${(isSlack || isPV) && !isSimulationSolved ? 'Unknown' : (row.gq || 0).toFixed(2)}" 
                                onchange="updateData(${index}, 'gq', this.value)"
                                ${(isSlack || isPV) ? 'readonly' : ''}>
                        </td>

                        <td class="px-4 py-2 border-l border-gray-100 dark:border-slate-700">
                            <div class="flex items-center gap-2">
                                <input type="number" step="0.1" 
                                    class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full focus:outline-none font-bold" 
                                    value="${(row.lp || 0).toFixed(2)}" onchange="updateData(${index}, 'lp', this.value)">
                                <button onclick="playSound(); openMultiUnitModal(${index}, 'load')" 
                                    class="text-purple-500 hover:text-purple-700 p-1 rounded hover:bg-purple-50 transition" title="Manage Multiple Loads">
                                    <i class="ph ph-list-plus text-sm"></i>
                                </button>
                            </div>
                        </td>
                        <td class="px-4 py-2">
                            <input type="number" step="0.1" 
                                class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full focus:outline-none font-bold" 
                                value="${(row.lq || 0).toFixed(2)}" onchange="updateData(${index}, 'lq', this.value)">
                        </td>

                        <td class="px-4 py-2 text-right border-l border-gray-100 dark:border-slate-700">
                            ${isSlack ?
                        `<span class="text-gray-300" title="Slack Bus cannot be removed"><i class="ph ph-trash"></i></span>` :
                        `<button onclick="playSound(); deleteBus(${index})" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition btn-click" title="Remove Bus"><i class="ph ph-trash"></i></button>`
                    }
                        </td>
                    </tr>
                `;
            });
        }

        function renderTopologyInput() {
            const tbody = document.getElementById('topologyTableBody');
            tbody.innerHTML = '';
            activeBranches.forEach((b, index) => {
                const fromOptions = currentData.map(bus => `<option value="${bus.bus}" ${bus.bus === b.from ? 'selected' : ''}>Bus ${bus.bus} ${bus.bus === 1 ? '(Slack)' : ''}</option>`).join('');
                const toOptions = currentData.map(bus => `<option value="${bus.bus}" ${bus.bus === b.to ? 'selected' : ''}>Bus ${bus.bus} ${bus.bus === 1 ? '(Slack)' : ''}</option>`).join('');

                const isTransformer = b.type === 'transformer';

                tbody.innerHTML += `
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 border-b border-gray-100 dark:border-slate-700 transition">
                        <td class="px-3 py-2 font-mono text-xs text-gray-500 dark:text-gray-400">${isTransformer ? 'T' : 'L'}${b.id}</td>
                        <td class="px-3 py-2">
                            <select class="text-[10px] bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded p-1 focus:outline-none font-bold"
                                    onchange="updateBranchData(${index}, 'type', this.value)">
                                <option value="line" ${!isTransformer ? 'selected' : ''}>Line</option>
                                <option value="transformer" ${isTransformer ? 'selected' : ''}>Xfmr</option>
                            </select>
                        </td>
                        <td class="px-3 py-2 text-xs">
                            <select class="bg-transparent font-bold text-gray-700 dark:text-gray-200 focus:outline-none w-full border-b border-dotted border-gray-300 dark:border-slate-600" 
                                    onchange="updateBranchData(${index}, 'from', this.value)">
                                ${fromOptions}
                            </select>
                        </td>
                        <td class="px-3 py-2 text-xs">
                            <select class="bg-transparent font-bold text-gray-700 dark:text-gray-200 focus:outline-none w-full border-b border-dotted border-gray-300 dark:border-slate-600" 
                                    onchange="updateBranchData(${index}, 'to', this.value)">
                                ${toOptions}
                            </select>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <div class="flex flex-col gap-1 items-center">
                                <span class="text-[9px] text-gray-400 uppercase font-bold">R (p.u)</span>
                                <input type="number" step="0.0001" class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full max-w-[80px] text-center focus:outline-none font-bold" 
                                       value="${b.r || 0}" 
                                       onchange="updateBranchData(${index}, 'r', this.value)">
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <div class="flex flex-col gap-1 items-center">
                                <span class="text-[9px] text-gray-400 uppercase font-bold">X (p.u)</span>
                                <input type="number" step="0.0001" class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full max-w-[80px] text-center focus:outline-none font-bold" 
                                       value="${b.x || 0.1}" 
                                       onchange="updateBranchData(${index}, 'x', this.value)">
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <div class="flex flex-col gap-1 items-center">
                                ${isTransformer ? `
                                    <span class="text-[9px] text-gray-400 uppercase font-bold">Vp / Vs / a</span>
                                    <div class="flex items-center gap-1">
                                        <input type="number" step="0.1" placeholder="Vp" class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-10 text-center focus:outline-none font-bold text-[10px]" 
                                               value="${b.v_prim || 138}" 
                                               onchange="updateBranchData(${index}, 'v_prim', this.value)">
                                        <span class="text-gray-400">/</span>
                                        <input type="number" step="0.1" placeholder="Vs" class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-10 text-center focus:outline-none font-bold text-[10px]" 
                                               value="${b.v_sec || 69}" 
                                               onchange="updateBranchData(${index}, 'v_sec', this.value)">
                                        <span class="text-gray-400">/</span>
                                        <input type="number" step="0.00001" placeholder="a" class="input-edit text-emerald-600 dark:text-emerald-400 dark:bg-transparent w-14 text-center focus:outline-none font-bold text-[10px]" 
                                               value="${(b.tap || 1).toFixed(5)}" 
                                               onchange="updateBranchData(${index}, 'tap', this.value)">
                                    </div>
                                ` : `
                                    <span class="text-[9px] text-gray-400 uppercase font-bold">B/2 (p.u)</span>
                                    <input type="number" step="0.0001" class="input-edit text-gray-700 dark:text-gray-200 dark:bg-transparent w-full max-w-[80px] text-center focus:outline-none font-bold" 
                                           value="${b.b_charging || 0}" 
                                           onchange="updateBranchData(${index}, 'b_charging', this.value)">
                                `}
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center font-mono text-[10px]">
                            <div class="text-gray-600 font-bold">${(parseFloat(b.r) || 0).toFixed(4)} + ${(parseFloat(b.x) || 0.1).toFixed(4)}j</div>
                            ${isTransformer ? `<div class="text-[8px] text-gray-400">a = ${(parseFloat(b.tap) || 1).toFixed(5)}</div>` : ''}
                        </td>

                        <td class="px-3 py-2 text-right">
                            <button onclick="playSound(); removeLine(${index})" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50"><i class="ph ph-trash"></i></button>
                        </td>
                    </tr>
            `;
            });
        }

        function updateBranchData(index, field, val) {
            if (activeBranches[index]) {
                const branch = activeBranches[index];
                if (field === 'type') {
                    branch[field] = val;
                    if (val === 'transformer') {
                        // Default to current bus voltage for v_prim
                        const fromBus = currentData.find(b => b.bus === branch.from);
                        const vBase = fromBus ? (fromBus.baseKV || 230) : 230;
                        branch.v_prim = vBase;
                        branch.v_sec = vBase / 2; // Default 2:1 ratio
                        branch.tap = 2.0;
                        branch.z_pct = 10; // New default
                        // Also sync with others immediately
                        syncTransformerVoltages(branch.from, branch.v_prim);
                        syncTransformerVoltages(branch.to, branch.v_sec);
                    }
                } else {
                    const parsed = parseFloat(val);
                    branch[field] = isNaN(parsed) ? val : parsed;

                    if (branch.type === 'transformer') {
                        if (field === 'tap') {
                            // Automatically calculate Vs based on Vp / a
                            const tapVal = parseFloat(val) || 1;
                            const vp = branch.v_prim || 230;
                            branch.v_sec = vp / tapVal;
                            syncTransformerVoltages(branch.to, branch.v_sec);
                        } else {
                            // Sync Vp / Vs across all connected IDs
                            if (field === 'v_prim') {
                                syncTransformerVoltages(branch.from, branch.v_prim);
                            } else if (field === 'v_sec') {
                                syncTransformerVoltages(branch.to, branch.v_sec);
                            }
                            // Recalculate Tap if Vp or Vs changes
                            const vp = branch.v_prim || 230;
                            const vs = branch.v_sec || 115;
                            branch.tap = vp / vs;
                        }
                    }
                }

                calculateVoltageBases();
                renderTopologyInput();
                renderSidebarTopology();
                renderInputTable();
            }
        }

        // Helper to propagate Vp/Vs changes to all transformers on the same bus
        function syncTransformerVoltages(busId, voltage) {
            if (!busId) return;
            activeBranches.forEach(br => {
                if (br.type !== 'transformer') return;
                let changed = false;
                if (br.from === busId) {
                    br.v_prim = voltage;
                    changed = true;
                }
                if (br.to === busId) {
                    br.v_sec = voltage;
                    changed = true;
                }
                if (changed) {
                    br.tap = (br.v_prim || 1) / (br.v_sec || 1);
                }
            });
            // Update the bus baseKV in currentData as well
            const bus = currentData.find(b => b.bus === busId);
            if (bus) bus.baseKV = voltage;
        }

        function calculateVoltageBases() {
            if (!currentData || currentData.length === 0) return;

            const globalBase = parseFloat(document.getElementById('baseKVInput').value) || 230;

            // Step 1: Initialize all to null except Slack
            currentData.forEach(bus => {
                bus.baseKV = (bus.bus === 1) ? globalBase : null;
            });

            // Step 2: BFS/Propagation system
            const queue = [1];
            const visited = new Set([1]);

            while (queue.length > 0) {
                const currentId = queue.shift();
                const currentBus = currentData.find(b => b.bus === currentId);
                const currentBase = currentBus.baseKV || globalBase;

                // Find outgoing connections
                activeBranches.forEach(branch => {
                    let neighborId = null;
                    let isForward = true;

                    if (branch.from === currentId) {
                        neighborId = branch.to;
                        isForward = true;
                    } else if (branch.to === currentId) {
                        neighborId = branch.from;
                        isForward = false;
                    }

                    if (neighborId !== null && !visited.has(neighborId)) {
                        const neighborBus = currentData.find(b => b.bus === neighborId);
                        if (neighborBus) {
                            if (branch.type === 'transformer') {
                                // If current bus has a base, but neighbor doesn't, we define neighbor based on transformer rating
                                if (isForward) {
                                    neighborBus.baseKV = branch.v_sec;
                                } else {
                                    neighborBus.baseKV = branch.v_prim;
                                }
                                branch.tap = (branch.v_prim || 1) / (branch.v_sec || 1);
                            } else {
                                // Line - propagates the same base
                                neighborBus.baseKV = currentBase;
                            }
                            visited.add(neighborId);
                            queue.push(neighborId);
                        }
                    }
                });
            }

            // Fallback for islanded buses
            currentData.forEach(bus => {
                if (bus.baseKV === null) bus.baseKV = globalBase;
            });
        }

        // --- DATA UPDATES ---

        function updateData(index, field, val) {
            isSimulationSolved = false;
            if (field === 'type') {
                currentData[index][field] = val;
            } else if (field === 'name') {
                currentData[index][field] = val;
            } else {
                currentData[index][field] = parseFloat(val) || 0;
            }

            // Sync multi-unit arrays if user manually edits the aggregate input
            // (Creates a default unit for the total value)
            if (['gp', 'gq', 'lp', 'lq'].includes(field)) {
                syncAggregateToUnits(index, field);
            }

            renderInputTable();
        }

        function syncAggregateToUnits(busIdx, field) {
            const bus = currentData[busIdx];
            const type = field.startsWith('g') ? 'gen' : 'load';
            const arr = type === 'gen' ? bus.generators : bus.loads;
            const pField = type === 'gen' ? 'gp' : 'lp';
            const qField = type === 'gen' ? 'gq' : 'lq';

            // If user edited total, we clear units and make one unit worth the total
            // OR if it's the first time, initialize it.
            if (arr.length <= 1) {
                arr.length = 0;
                arr.push({ id: 1, name: "Default Unit", p: bus[pField], q: bus[qField] });
            }
        }

        function addBus() {
            isSimulationSolved = false;
            const newBusId = currentData.length > 0 ? Math.max(...currentData.map(d => d.bus)) + 1 : 1;
            currentData.push({
                bus: newBusId, mag: 1.0, ang: 0,
                gp: 0, gq: 0, generators: [],
                lp: 0, lq: 0, loads: [],
                injQ: 0, type: 'PQ'
            });
            calculateVoltageBases();
            renderInputTable();
            initAddLineModal(); // Refresh modal options

            // Update Display
            const disp = document.getElementById('busCountDisplay');
            if (disp) disp.innerText = currentData.length;
        }

        // --- MULTI-UNIT MODAL SYSTEM ---
        let activeBusIdx = -1;
        let activeUnitType = 'gen'; // 'gen' or 'load'

        function openMultiUnitModal(busIdx, type) {
            activeBusIdx = busIdx;
            activeUnitType = type;
            const bus = currentData[busIdx];

            // Modal Header
            const titleEl = document.getElementById('multiUnitTitle');
            const subEl = document.getElementById('multiUnitSubtitle');
            const iconEl = document.getElementById('multiUnitIcon');

            if (type === 'gen') {
                titleEl.innerText = `Bus ${bus.bus} Generators`;
                subEl.innerText = `Manage multiple power generation units for this bus`;
                iconEl.className = "w-10 h-10 rounded-full flex items-center justify-center bg-blue-500/20 text-blue-500";
                iconEl.innerHTML = '<i class="ph ph-factory text-2xl"></i>';

                if (!bus.generators) bus.generators = [];
                // Initialize if empty but has total
                if (bus.generators.length === 0 && (bus.gp > 0 || bus.gq > 0)) {
                    bus.generators.push({ id: 1, name: "Main Gen", p: bus.gp || 0, q: bus.gq || 0 });
                }
            } else {
                titleEl.innerText = `Bus ${bus.bus} Loads`;
                subEl.innerText = `Manage multiple electricity load demands for this bus`;
                iconEl.className = "w-10 h-10 rounded-full flex items-center justify-center bg-purple-500/20 text-purple-500";
                iconEl.innerHTML = '<i class="ph ph-house-line text-2xl"></i>';

                if (!bus.loads) bus.loads = [];
                // Initialize if empty but has total
                if (bus.loads.length === 0 && (bus.lp > 0 || bus.lq > 0)) {
                    bus.loads.push({ id: 1, name: "City Load", p: bus.lp || 0, q: bus.lq || 0 });
                }
            }

            renderUnitList();
            document.getElementById('multiUnitModal').classList.remove('hidden');
        }

        function closeMultiUnitModal() {
            document.getElementById('multiUnitModal').classList.add('hidden');
            renderInputTable();
        }

        function renderUnitList() {
            const listEl = document.getElementById('unitList');
            const bus = currentData[activeBusIdx];
            const units = activeUnitType === 'gen' ? bus.generators : bus.loads;
            listEl.innerHTML = '';

            let totalP = 0;

            units.forEach((u, i) => {
                totalP += u.p;
                listEl.innerHTML += `
                    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4 rounded-xl shadow-sm space-y-3">
                        <div class="flex justify-between items-center">
                            <input type="text" value="${u.name}" onchange="updateUnit(${i}, 'name', this.value)" 
                                class="font-bold border-none bg-transparent focus:ring-0 text-slate-700 dark:text-white text-sm" placeholder="Unit Name">
                            <button onclick="playSound(); removeUnit(${i})" class="text-red-400 hover:text-red-600 transition">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">P (MW)</label>
                                <input type="number" value="${u.p}" onchange="updateUnit(${i}, 'p', this.value)" 
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg p-2 font-mono text-sm dark:text-white">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Q (Mvar)</label>
                                <input type="number" value="${u.q}" onchange="updateUnit(${i}, 'q', this.value)" 
                                    class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg p-2 font-mono text-sm dark:text-white">
                            </div>
                        </div>
                    </div>
                `;
            });

            if (units.length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 text-slate-400 italic text-sm">No units defined. Click below to add.</div>`;
            }

            document.getElementById('multiUnitTotal').innerText = totalP.toFixed(2) + " MW";
        }

        function updateUnit(unitIdx, field, val) {
            const bus = currentData[activeBusIdx];
            const units = activeUnitType === 'gen' ? bus.generators : bus.loads;

            if (field === 'name') {
                units[unitIdx][field] = val;
            } else {
                units[unitIdx][field] = parseFloat(val) || 0;
            }

            // Roll up totals to bus
            sumUnitsToBus(activeBusIdx);
            document.getElementById('multiUnitTotal').innerText = (activeUnitType === 'gen' ? bus.gp : bus.lp).toFixed(2) + " MW";
        }

        function sumUnitsToBus(idx) {
            const bus = currentData[idx];

            let newGP = 0, newGQ = 0;
            bus.generators.forEach(u => { newGP += u.p; newGQ += u.q; });
            bus.gp = newGP;
            bus.gq = newGQ;

            let newLP = 0, newLQ = 0;
            bus.loads.forEach(u => { newLP += u.p; newLQ += u.q; });
            bus.lp = newLP;
            bus.lq = newLQ;

            isSimulationSolved = false;
        }

        function addUnitToBus() {
            const bus = currentData[activeBusIdx];
            const units = activeUnitType === 'gen' ? bus.generators : bus.loads;
            const prefix = activeUnitType === 'gen' ? 'Generator' : 'Load';

            units.push({
                id: units.length + 1,
                name: `${prefix} ${units.length + 1}`,
                p: 0,
                q: 0
            });

            renderUnitList();
        }

        function removeUnit(idx) {
            const bus = currentData[activeBusIdx];
            const units = activeUnitType === 'gen' ? bus.generators : bus.loads;

            units.splice(idx, 1);
            sumUnitsToBus(activeBusIdx);
            renderUnitList();
        }

        function populateTestValues() {
            if (!currentData || currentData.length === 0) return;
            isSimulationSolved = false;

            currentData.forEach(bus => {
                if (bus.bus === 1) {
                    // Slack Bus: Usually has Generation, No Load
                    bus.gp = 0; bus.gq = 0;
                    bus.lp = 0; bus.lq = 0;
                    bus.type = 'Slack';
                    return;
                }

                const vBase = bus.baseKV || 230;

                // 1. Generation Logic
                // Higher voltages (>= 115kV) are more likely to have generators
                if (vBase >= 115) {
                    const hasGen = Math.random() > 0.4; // 60% chance for high voltage
                    if (hasGen) {
                        bus.gp = Math.floor(Math.random() * 100) + 50; // 50-150 MW
                        bus.gq = Math.floor(Math.random() * 40) + 10;  // 10-50 Mvar
                        bus.type = 'PV';
                    } else {
                        bus.gp = 0; bus.gq = 0;
                        bus.type = 'PQ';
                    }
                } else {
                    bus.gp = 0; bus.gq = 0; // Low voltage usually has no generation in this model
                    bus.type = 'PQ';
                }

                // 2. Load Logic
                // Lower voltages (<= 69kV) are more likely to have heavy loads
                if (vBase <= 69) {
                    bus.lp = Math.floor(Math.random() * 40) + 10; // 10-50 MW
                    bus.lq = Math.floor(Math.random() * 15) + 5;  // 5-20 Mvar
                } else {
                    // Transmission level might have small city loads
                    const hasLoad = Math.random() > 0.6;
                    bus.lp = hasLoad ? (Math.floor(Math.random() * 20) + 5) : 0;
                    bus.lq = hasLoad ? (Math.floor(Math.random() * 8) + 2) : 0;
                }

                // 3. Initial Guesses
                bus.mag = parseFloat((0.95 + Math.random() * 0.1).toFixed(3));
                bus.ang = parseFloat((-5 - Math.random() * 10).toFixed(2));

                // 4. Injection
                bus.injQ = (vBase <= 34 && Math.random() > 0.8) ? (Math.random() * 10).toFixed(1) : 0;
            });

            renderInputTable();
            // Show toast or alert
            const btn = document.querySelector('button[title="Fill with random test data"]');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i class="ph ph-check"></i> Done`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 1000);
            }
        }

        function populateTopology() {
            if (!currentData || currentData.length < 2) return;

            activeBranches = [];
            const buses = currentData.map(b => b.bus);

            // Generate a simple radial backbone with LINES (User requested default type: Lines)
            for (let i = 0; i < buses.length - 1; i++) {
                activeBranches.push({
                    id: i + 1,
                    from: buses[i],
                    to: buses[i + 1],
                    r: parseFloat((0.001 + Math.random() * 0.01).toFixed(4)),
                    x: parseFloat((0.02 + Math.random() * 0.05).toFixed(4)),
                    b_charging: 0
                });
            }

            // Add Random Cross-Links (Ring/Mesh) - 20% density
            const maxLinks = Math.floor(buses.length * 0.2);
            for (let k = 0; k < maxLinks; k++) {
                const idxA = Math.floor(Math.random() * buses.length);
                let idxB = Math.floor(Math.random() * buses.length);

                if (idxA !== idxB && Math.abs(idxA - idxB) > 1) {
                    const from = buses[idxA];
                    const to = buses[idxB];
                    const exists = activeBranches.some(b => (b.from === from && b.to === to) || (b.from === to && b.to === from));

                    if (!exists) {
                        const newId = activeBranches.length + 1;
                        activeBranches.push({
                            id: newId,
                            from: from,
                            to: to,
                            type: 'line',
                            r: parseFloat((0.01 + Math.random() * 0.05).toFixed(4)),
                            x: parseFloat((0.04 + Math.random() * 0.15).toFixed(4)),
                            b_charging: 0
                        });
                    }
                }
            }

            calculateVoltageBases();
            renderTopologyInput();
            renderSidebarTopology();

            const btn = document.querySelector('button[title="Auto-connect buses"]');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i class="ph ph-check"></i> Done`;
                setTimeout(() => { btn.innerHTML = originalHTML; }, 1000);
            }
        }

        function deleteBus(index) {
            const busId = currentData[index].bus;
            if (busId === 1) return; // Guard for Slack Bus

            // Remove Bus
            currentData.splice(index, 1);

            // Remove associated lines automatically
            const initialCount = activeBranches.length;
            activeBranches = activeBranches.filter(b => b.from !== busId && b.to !== busId);

            // UI Updates
            calculateVoltageBases();
            // UI Updates
            renderInputTable();
            renderTopologyInput(); // Refresh line table if lines removed
            renderSidebarTopology();
            initAddLineModal(); // Refresh modal options

            // Update Bus Count Display
            const disp = document.getElementById('busCountDisplay');
            if (disp) disp.innerText = currentData.length;

        }

        function removeLine(index) {
            activeBranches.splice(index, 1);
            calculateVoltageBases();
            renderTopologyInput();
            renderSidebarTopology();
            renderInputTable();
        }

        // --- NEW ADD LINE MODAL LOGIC ---
        function initAddLineModal() {
            const fromSelect = document.getElementById('newFromBus');
            const toSelect = document.getElementById('newToBus');

            // FIX: Use currentData if available. Do not fallback to ieee30Base if currentData exists (even if empty).
            // This ensures "Empty System" really means empty dropdowns until buses are added.
            const source = (typeof currentData !== 'undefined') ? currentData : ((typeof ieee30Base !== 'undefined') ? ieee30Base : []);

            const buses = source.map(b => b.bus);

            // Populate Dropdowns
            [fromSelect, toSelect].forEach(sel => {
                sel.innerHTML = '';
                buses.forEach(b => {
                    sel.innerHTML += `<option value="${b}">Bus ${b}</option>`;
                });
            });
        }

        function openAddLineModal() {
            // Repopulate Dropdowns dynamically
            const fromSelect = document.getElementById('newFromBus');
            const toSelect = document.getElementById('newToBus');

            if (fromSelect && toSelect && currentData) {
                fromSelect.innerHTML = '';
                toSelect.innerHTML = '';
                currentData.forEach(bus => {
                    const opt1 = document.createElement('option');
                    opt1.value = bus.bus;
                    opt1.text = `Bus ${bus.bus} (${bus.type || 'Load'})`;
                    fromSelect.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = bus.bus;
                    opt2.text = `Bus ${bus.bus} (${bus.type || 'Load'})`;
                    toSelect.appendChild(opt2);
                });
            }

            document.getElementById('addLineModal').classList.remove('hidden');
            document.getElementById('addLineError').classList.add('hidden');
        }

        function closeAddLineModal() {
            document.getElementById('addLineModal').classList.add('hidden');
        }

        function confirmAddLine() {
            const from = parseInt(document.getElementById('newFromBus').value);
            const to = parseInt(document.getElementById('newToBus').value);

            // Validation
            if (from === to) {
                showLineError();
                return;
            }

            const exists = activeBranches.some(b => (b.from === from && b.to === to) || (b.from === to && b.to === from));
            if (exists) {
                showLineError();
                return;
            }

            // Add Line
            const newId = activeBranches.length > 0 ? Math.max(...activeBranches.map(b => b.id)) + 1 : 1;
            activeBranches.push({
                id: newId,
                from: from,
                to: to,
                type: 'line',
                r: 0.001,
                x: 0.05,
                b_charging: 0
            });
            calculateVoltageBases();
            renderTopologyInput();
            renderSidebarTopology();
            renderInputTable();
            closeAddLineModal();
        }

        function showLineError() {
            document.getElementById('addLineError').classList.remove('hidden');
        }

        // --- SLD MODAL CONTROLS ---
        function openSLDModal() {
            document.getElementById('sldModal').classList.remove('hidden');
            // Slight delay to allow DOM to show before rendering canvas
            setTimeout(() => {
                renderSLD();
            }, 100);
        }

        function closeSLDModal() {
            document.getElementById('sldModal').classList.add('hidden');
        }

        // --- RESET LOGIC ---
        function resetGrid() {
            currentData.forEach(bus => {
                bus.mag = 1.0; bus.ang = 0; bus.gp = 0; bus.gq = 0; bus.lp = 0; bus.lq = 0; bus.injQ = 0;
            });
            activeBranches = [];
            calculateVoltageBases();
            renderInputTable();
            renderTopologyInput();
            renderSidebarTopology();
            initAddLineModal();

            // Visual Feedback
            const btn = document.getElementById('resetBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i class="ph ph-check"></i> Cleared!`;
            btn.classList.add('text-red-600', 'bg-red-50', 'border-red-200');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('text-red-600', 'bg-red-50', 'border-red-200');
            }, 1000);
        }


        // --- PDF EXPORT ---
        function exportToPDF() {
            const element = document.getElementById('resultsState');

            // Set Date
            document.getElementById('pdfDate').innerText = new Date().toLocaleString();

            // Prepare Styling for Print
            document.querySelector('.pdf-header').style.display = 'block';
            document.getElementById('resultsControls').style.display = 'none';

            // Generate
            const opt = {
                margin: 0.5,
                filename: `PowerSim - Report - ${userName.replace(/\s+/g, '-')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // Cleanup after save
                document.querySelector('.pdf-header').style.display = 'none';
                document.getElementById('resultsControls').style.display = 'flex';
            });
        }

        // --- INTERACTIVE SOLVER LOGIC ---
        let solverQueue = [];
        let solverInterval = null;
        let currentSolverStep = 0;

        function prepareSolverData(solution) {
            solverQueue = [];
            currentSolverStep = 0;

            const toleranceInput = document.getElementById('toleranceInput');
            const tolerance = toleranceInput ? (parseFloat(toleranceInput.value) || 0.0001) : 0.0001;
            const busCount = currentData.length;

            // Step 1: Init
            solverQueue.push({
                node: 'flow-start',
                text: `> Step 1: Initialization. Set Flat Start for ${busCount}-Bus System.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ V_{start} = 1.0\\angle0^{\\circ}, \\quad S_{sch} \\text{ defined} $$</div>`,
                eq: "$$ |V_i| = 1.0, \\delta_i = 0 \\quad \\forall i \\in \\text{PQ Buses} $$"
            });

            // Step 2: Y-Bus Matrix Construction
            const buses = currentData.map(b => b.bus);
            const size = buses.length;
            let Ybus = Array.from({ length: size }, () => Array.from({ length: size }, () => ({ g: 0, b: 0 })));

            activeBranches.forEach(br => {
                const i = buses.indexOf(br.from);
                const k = buses.indexOf(br.to);
                if (i === -1 || k === -1) return;
                const r = br.r !== undefined ? br.r : (br.type === 'transformer' ? 0 : 0.01);
                const x = br.x !== undefined ? br.x : (br.type === 'transformer' ? 0.05 : 0.08);
                const b_sh = br.b_charging !== undefined ? br.b_charging : 0;
                const isTrans = br.type === 'transformer';
                const tap = isTrans ? (parseFloat(br.tap) || 1.0) : 1.0;

                const den = r * r + x * x;
                const G_s = den > 0 ? r / den : 10000;
                const B_s = den > 0 ? -x / den : -10000;

                const g_ik = G_s * tap;
                const b_ik = B_s * tap;
                Ybus[i][k].g -= g_ik; Ybus[i][k].b -= b_ik;
                Ybus[k][i].g -= g_ik; Ybus[k][i].b -= b_ik;
                Ybus[i][i].g += G_s * (tap * tap);
                Ybus[i][i].b += (B_s * (tap * tap) + b_sh);
                Ybus[k][k].g += G_s;
                Ybus[k][k].b += (B_s + b_sh);
            });

            let yMatrixHTML = "$$ \\begin{bmatrix} ";
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const cell = Ybus[r][c];
                    if (Math.abs(cell.g) < 0.001 && Math.abs(cell.b) < 0.001) yMatrixHTML += "0";
                    else {
                        const sign = cell.b >= 0 ? "+" : "-";
                        yMatrixHTML += `${cell.g.toFixed(2)} ${sign} j${Math.abs(cell.b).toFixed(2)}`;
                    }
                    if (c < size - 1) yMatrixHTML += " & ";
                }
                if (r < size - 1) yMatrixHTML += " \\\\ ";
            }
            yMatrixHTML += " \\end{bmatrix} $$";

            solverQueue.push({
                node: 'flow-start',
                text: `> Step 2: Build Admittance Matrix (Ybus). System Size: ${size}x${size}.<div class='text-white my-1 pl-4 text-xs opacity-90 max-h-60 overflow-y-auto scroll-custom border border-slate-600 p-2 bg-slate-800 rounded'>${yMatrixHTML}</div>`,
                eq: "$$ Y_{bus} = G + jB $$"
            });

            let iterations = 0;
            let iterationData = [];

            if (solution && solution.history) {
                solution.history.forEach((h, idx) => {
                    iterations = h.iter;
                    iterationData.push({ mismatch: h.maxError });

                    solverQueue.push({
                        node: 'flow-mismatch',
                        text: `> Iteration ${iterations}: Calculating Flows.<div class='text-white my-1 pl-4 text-xs opacity-90'>Newton-Raphson mismatch evaluation...</div>`,
                        eq: "$$ P_i^{calc} = \\sum_{k=1}^N |V_i||V_k|(G_{ik}\\cos\\theta_{ik} + B_{ik}\\sin\\theta_{ik}) $$"
                    });

                    solverQueue.push({
                        node: 'flow-mismatch',
                        text: `> Computing Residuals.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\max|\\Delta P, \\Delta Q| = ${h.maxError.toExponential(4)} $$</div>`,
                        eq: "$$ \\Delta P_i = P_i^{sch} - P_i^{calc} \\\\ \\Delta Q_i = Q_i^{sch} - Q_i^{calc} $$"
                    });

                    solverQueue.push({
                        node: 'flow-check',
                        text: `  Convergence Check.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ ${h.maxError.toFixed(6)} ${h.maxError <= tolerance ? '\\le' : '>'} ${tolerance} $$</div>`,
                        eq: `$$ \\max(|\\Delta S |) > \\epsilon $$`,
                        iterationNum: iterations,
                        mismatchVal: h.maxError
                    });

                    if (h.maxError > tolerance) {
                        solverQueue.push({
                            node: 'flow-jacobian',
                            text: "> Updating Jacobian sensitivities.",
                            eq: "$$ J = \\begin{bmatrix} \\frac{\\partial P}{\\partial \\delta} & \\frac{\\partial P}{\\partial |V|} \\\\ \\frac{\\partial Q}{\\partial \\delta} & \\frac{\\partial Q}{\\partial |V|} \\end{bmatrix} $$"
                        });
                        solverQueue.push({
                            node: 'flow-update',
                            text: "> Solving linearized system.",
                            eq: "$$ [\\Delta x] = - [J]^{-1} [\\Delta S] $$"
                        });
                        solverQueue.push({
                            node: 'flow-update',
                            text: "> Applying state updates.",
                            eq: "$$ x^{(k+1)} = x^{(k)} + \\Delta x $$"
                        });
                    }
                });

                if (solution.converged) {
                    solverQueue.push({
                        node: 'flow-check',
                        text: `> Converged! Solution found in ${iterations} iterations.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\max(\\epsilon) = ${solution.history[solution.history.length - 1].maxError.toExponential(2)} $$</div>`,
                        eq: `$$ \\text{Converged at Iteration } ${iterations} $$`
                    });
                } else {
                    solverQueue.push({
                        node: 'flow-check',
                        text: `> FAILED TO CONVERGE.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\text{Limit reached: } ${iterations} \\text{ iterations} $$</div>`,
                        eq: `$$ \\text{Final Mismatch: } ${solution.history[solution.history.length - 1].maxError.toFixed(5)} $$`
                    });
                }
            } else {
                // Fallback to simulated loop if no real solution is provided
                let maxMismatch = 0.5; // Start with a simulated mismatch
                const maxIter = 20;

                while (maxMismatch > tolerance && iterations < maxIter) {
                    iterations++;
                    iterationData.push({ mismatch: maxMismatch });

                    solverQueue.push({
                        node: 'flow-mismatch',
                        text: `> Iteration ${iterations}: Calculating Flows.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ P_{calc} \\approx ${(1.0 - maxMismatch / 2).toFixed(4)} \\text{ p.u.}, \\quad Q_{calc} \\approx ${(0.5 - maxMismatch / 4).toFixed(4)} \\text{ p.u.} $$</div>`,
                        eq: "$$ P_i^{calc} = \\sum_{k=1}^N |V_i||V_k|(G_{ik}\\cos\\theta_{ik} + B_{ik}\\sin\\theta_{ik}) $$"
                    });
                    solverQueue.push({
                        node: 'flow-mismatch',
                        text: `> Computing Residuals(Delta).<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\Delta P \\approx ${maxMismatch.toFixed(5)}, \\quad \\Delta Q \\approx ${(maxMismatch * 0.8).toFixed(5)} $$</div>`,
                        eq: "$$ \\Delta P_i = P_i^{sch} - P_i^{calc} \\\\ \\Delta Q_i = Q_i^{sch} - Q_i^{calc} $$"
                    });

                    solverQueue.push({
                        node: 'flow-check',
                        text: `  Convergence Check.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\max(\\Delta P) \\approx ${maxMismatch.toFixed(5)}, \\quad \\max(\\Delta Q) \\approx ${(maxMismatch * 0.9).toFixed(5)} $$</div>`,
                        eq: `$$ \\max(|\\Delta P |, |\\Delta Q |) > \\epsilon(${tolerance}) $$`,
                        iterationNum: iterations,
                        mismatchVal: maxMismatch
                    });

                    solverQueue.push({
                        node: 'flow-jacobian',
                        text: "> Building Jacobian Matrix J.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\begin{aligned} \\frac{\\partial P}{\\partial \\delta} &\\approx ${(10 + iterations).toFixed(1)} & \\frac{\\partial P}{\\partial V} &\\approx ${(2 + iterations * 0.1).toFixed(1)} \\\\ \\frac{\\partial Q}{\\partial \\delta} &\\approx ${(1 + iterations * 0.1).toFixed(1)} & \\frac{\\partial Q}{\\partial V} &\\approx ${(8 + iterations).toFixed(1)} \\end{aligned} $$</div>",
                        eq: "$$ J = \\begin{bmatrix} \\frac{\\partial P}{\\partial \\delta} & \\frac{\\partial P}{\\partial |V|} \\\\ \\frac{\\partial Q}{\\partial \\delta} & \\frac{\\partial Q}{\\partial |V|} \\end{bmatrix} $$"
                    });

                    solverQueue.push({
                        node: 'flow-update',
                        text: "> Solving Linear System (Ax = b).<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\Delta \\delta \\approx ${(maxMismatch * 0.5).toFixed(5)} rad, \\quad \\Delta V \\approx ${(maxMismatch * 0.1).toFixed(5)} p.u. $$</div>",
                        eq: "$$ \\begin{bmatrix} \\Delta \\delta \\\\ \\Delta |V| \\end{bmatrix} = - [J]^{-1} \\begin{bmatrix} \\Delta P \\\\ \\Delta Q \\end{bmatrix} $$"
                    });

                    solverQueue.push({
                        node: 'flow-update',
                        text: "> Applying corrections.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\begin{aligned} |V|_{new} &= |V|_{old} + ${(maxMismatch * 0.1).toFixed(4)} \\\\ \\delta_{new} &= \\delta_{old} + ${(maxMismatch * 0.5).toFixed(4)} \\end{aligned} $$</div>",
                        eq: "$$ \\delta_i^{(k+1)} = \\delta_i^{(k)} + \\Delta \\delta_i \\\\ |V_i|^{(k+1)} = |V_i|^{(k)} + \\Delta |V_i| $$"
                    });

                    maxMismatch *= 0.15; // Simulate convergence
                }

                if (maxMismatch <= tolerance) {
                    solverQueue.push({
                        node: 'flow-check',
                        text: "> Converged! Solution found.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\max(\\epsilon) = ${maxMismatch.toExponential(2)} \\le ${tolerance} $$</div>",
                        eq: "$$ \\text{Solution Found in } " + iterations + " \\text{ Iterations} $$"
                    });
                } else {
                    solverQueue.push({
                        node: 'flow-check',
                        text: `> FAILED TO CONVERGE.<div class='text-white my-1 pl-4 text-xs opacity-90'>$$ \\max(\\epsilon) = ${maxMismatch.toFixed(5)} > ${tolerance} $$</div>`,
                        eq: `$$ \\text{Final Mismatch: } ${maxMismatch.toFixed(5)} > \\epsilon $$`
                    });
                }
            }

            renderConvergenceChart(iterationData);
        }

        function renderSolverStep(stepIndex) {
            if (stepIndex >= solverQueue.length) {
                clearInterval(solverInterval);
                return;
            }

            const step = solverQueue[stepIndex];
            const logEl = document.getElementById('interactiveMathLog');

            // Add Log
            const p = document.createElement('div');
            p.innerHTML = step.text;
            p.className = "animate-fadeIn mb-2 border-l-2 border-slate-700 pl-2 py-1";
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;

            // Trigger MathJax typeset for the new element if possible
            if (window.MathJax) {
                MathJax.typesetPromise([p]).catch(e => console.error(e));
            }

            // Highlight Flow Node
            document.querySelectorAll('.flow-node').forEach(el => el.classList.remove('flow-active'));
            if (step.node) document.getElementById(step.node).classList.add('flow-active');

            // Update Equation
            const eqDisplay = document.getElementById('activeEqDisplay');
            eqDisplay.innerHTML = step.eq;
            // Retrigger MathJax if available
            if (window.MathJax) MathJax.typesetPromise([eqDisplay]);

            // NEW: Update Convergence Chart if mismatch data is present
            if (step.mismatchVal !== undefined) {
                updateConvergenceChart(step.iterationNum, step.mismatchVal);
            }
        }

        function startSolverAnim() {
            if (solverInterval) clearInterval(solverInterval);
            document.getElementById('interactiveMathLog').innerHTML = ''; // Clear log on restart
            resetConvergenceChart(); // Clear chart
            currentSolverStep = 0;
            solverInterval = setInterval(() => {
                renderSolverStep(currentSolverStep);
                currentSolverStep++;
            }, 800);
        }

        function stepSolverAnim() {
            if (solverInterval) clearInterval(solverInterval);
            renderSolverStep(currentSolverStep);
            currentSolverStep++;
        }

        function resetSolverAnim() {
            if (solverInterval) clearInterval(solverInterval);
            currentSolverStep = 0;
            resetConvergenceChart(); // reset chart
            document.getElementById('interactiveMathLog').innerHTML = '<span class="text-gray-500 opacity-50">Ready. Press Start.</span>';
            document.querySelectorAll('.flow-node').forEach(el => el.classList.remove('flow-active'));
            document.getElementById('activeEqDisplay').innerHTML = "$$ f(x) = 0 $$";
        }


        function closeManualCalcModal() {
            document.getElementById('manualCalcModal').classList.add('hidden');
        }

        function printManualCalc() {
            window.print();
        }

        function exportManualCalcToPDF() {
            const element = document.getElementById('manualCalcContent');
            const opt = {
                margin: [0.5, 0.5],
                filename: `NR-PowerFlow-Proof-${userName.replace(/\s+/g, '-')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }

        function showManualNRCalculation() {
            const content = document.getElementById('manualCalcContent');
            const btn = document.getElementById('btnGenerateProof');

            // Switch to tab first
            switchTab('proof');

            // Show Loading State
            btn.innerHTML = `<i class="ph ph-circle-notch animate-spin"></i> Analyzing...`;
            btn.disabled = true;
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-slate-500 py-32 space-y-4">
                    <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <div class="text-center">
                        <p class="text-xl font-bold">Generating Technical Report</p>
                        <p class="text-sm italic opacity-70">Applying Stevenson methodology across the grid topology...</p>
                    </div>
                </div>
            `;

            // Use setTimeout to allow the UI to render the loading state before the heavy calculation
            setTimeout(() => {
                const baseMVA = parseFloat(document.getElementById('baseMVAInput').value) || 100;
                const n = currentData.length;

                // Use a buffer array for better performance
                const htmlBuffer = [];

                // 1. BRANCH ADMITTANCE CALCULATIONS (The "Human" Step)
                let branchCalcHTML = "";
                const branchAdmittances = [];

                activeBranches.forEach((branch, idx) => {
                    const fromBus = currentData.find(b => b.bus == branch.from);
                    const busBaseKV = fromBus ? (fromBus.baseKV || 230) : 230;
                    const isXfmr = branch.type === 'transformer';
                    let r = parseFloat(branch.r); if (isNaN(r)) r = isXfmr ? 0 : 0.02;
                    let x = parseFloat(branch.x); if (isNaN(x)) x = isXfmr ? 0.05 : 0.1;
                    const tap = parseFloat(branch.tap) || 1.0;

                    const z_mag2 = r * r + x * x;
                    const g = r / z_mag2;
                    const b = -x / z_mag2;

                    // Base Derivations (Item 2)
                    const z_base = (busBaseKV * busBaseKV) / baseMVA;
                    const i_base = (baseMVA * 1000) / (Math.sqrt(3) * busBaseKV);

                    branchAdmittances.push({ from: branch.from, to: branch.to, g, b, tap });

                    branchCalcHTML += `
                    <div class="p-4 border-l-2 border-blue-200 bg-blue-50/30 rounded-r-lg">
                        <div class="font-bold text-blue-900 mb-2 flex justify-between items-center">
                            <span>Line L${branch.id} (Bus ${branch.from} to ${branch.to})</span>
                            <span class="text-[9px] bg-blue-100 px-2 py-0.5 rounded text-blue-600 font-mono tracking-tighter">$Z_{base}=${z_base.toFixed(2)}\\Omega, I_{base}=${i_base.toFixed(2)}A$</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-xs font-mono">
                            <div>$z_{${branch.from}${branch.to}} = ${r.toFixed(4)} + j${x.toFixed(4)}$ p.u.</div>
                            <div>$y_{${branch.from}${branch.to}} = \\frac{1}{z_{${branch.from}${branch.to}}} = ${g.toFixed(6)} - j${Math.abs(b).toFixed(6)}$ p.u.</div>
                            
                            ${isXfmr ? `
                            <div class="col-span-full border-t border-blue-100/50 pt-2 mt-1">
                                <div class="text-[9px] font-bold text-amber-600 uppercase mb-1">$\pi$-Equivalent Transformer Model (Tap $a=V_s/V_p=${tap.toFixed(3)}$)</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="bg-white/50 p-1.5 rounded">$y_{series} = y/a = ${(g / tap).toFixed(4)} ${b / tap >= 0 ? '+' : '-'} j${Math.abs(b / tap).toFixed(4)}$</div>
                                    <div class="bg-white/50 p-1.5 rounded">$y_{from} = (\frac{1-a}{a^2}) y = ${(((1 - tap) / (tap * tap)) * g).toFixed(4)} ${((1 - tap) / (tap * tap)) * b >= 0 ? '+' : '-'} j${Math.abs(((1 - tap) / (tap * tap)) * b).toFixed(4)}$</div>
                                    <div class="bg-white/50 p-1.5 rounded">$y_{to} = (\frac{a-1}{a}) y = ${(((tap - 1) / tap) * g).toFixed(4)} ${((tap - 1) / tap) * b >= 0 ? '+' : '-'} j${Math.abs(((tap - 1) / tap) * b).toFixed(4)}$</div>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
                });

                // 0. BUS INDEX MAPPING (Robust against non-sequential IDs)
                const b2idx = {};
                currentData.forEach((b, idx) => { b2idx[b.bus] = idx; });

                // 1. BRANCH ADMITTANCE CALCULATIONS
                const G = Array.from({ length: n }, () => new Float64Array(n).fill(0));
                const B = Array.from({ length: n }, () => new Float64Array(n).fill(0));
                let yBusStepsHTML = "";

                branchAdmittances.forEach(ba => {
                    const i = b2idx[ba.from];
                    const k = b2idx[ba.to];
                    const tap = ba.tap;
                    const b_charging = parseFloat(activeBranches.find(br => br.id === ba.id)?.b_charging) || 0;

                    // Off-diagonals
                    const g_ik = -ba.g / tap;
                    const b_ik = -ba.b / tap;

                    yBusStepsHTML += `
                    <div class="text-[10px] font-mono py-1 border-b border-slate-100 last:border-0">
                        <span class="text-slate-400">Add branch ${ba.from}-${ba.to}:</span><br/>
                        $Y_{${ba.from}${ba.to}} = Y_{${ba.to}${ba.from}} = -y_{${ba.from}${ba.to}}/a = ${g_ik.toFixed(4)} ${b_ik >= 0 ? '+' : '-'}$ j${Math.abs(b_ik).toFixed(4)}<br/>
                        $Y_{${ba.from}${ba.from}} \\leftarrow Y_{${ba.from}${ba.from}} + y_{${ba.from}${ba.to}}/a^2 ${b_charging !== 0 ? `+ j${b_charging.toFixed(4)}` : ''}$<br/>
                        $Y_{${ba.to}${ba.to}} \\leftarrow Y_{${ba.to}${ba.to}} + y_{${ba.from}${ba.to}} ${b_charging !== 0 ? `+ j${b_charging.toFixed(4)}` : ''}$
                    </div>
                `;

                    G[i][k] += g_ik; B[i][k] += b_ik;
                    G[k][i] += g_ik; B[k][i] += b_ik;
                    G[i][i] += ba.g / (tap * tap); B[i][i] += ba.b / (tap * tap) + b_charging;
                    G[k][k] += ba.g; B[k][k] += ba.b + b_charging;
                });

                // 3. MISMATCH EXPANSION (Show full summation for Bus 2)
                let mismatchLogicHTML = "";
                if (n >= 2) {
                    const i = 1; // Bus 2
                    const bus = currentData[1];
                    const pi_sch = (bus.gp - bus.lp) / baseMVA;
                    const qi_sch = (bus.gq - bus.lq) / baseMVA;

                    const slackBus = currentData[0];
                    const v_slack = slackBus.mag;
                    const d_slack = slackBus.ang * (Math.PI / 180);

                    let pSumString = "";
                    let pSumVal = 0;
                    for (let j = 0; j < n; j++) {
                        const bj = currentData[j];
                        const v_j = bj.mag;
                        const d_j = bj.ang * (Math.PI / 180);
                        // For iteration 0 proof, we usually assume flat start for PQ but actual for Slack/PV
                        const term_mag = (j === 0 || bj.type === 'PV') ? v_j : 1.0;

                        pSumString += `(${term_mag.toFixed(2)} \\cdot ${G[i][j].toFixed(4)})`;
                        if (j < n - 1) pSumString += " + ";
                        // Simple G-sum for the proof text illustration
                        pSumVal += term_mag * G[i][j];
                    }

                    mismatchLogicHTML = `
                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 space-y-4">
                        <div class="font-bold text-slate-800">Example: Power Mismatch at Bus ${bus.bus} (Iteration 0)</div>
                        <div class="text-sm text-slate-600">Using Stevenson's Eq. 9.32 with Specified Slack ($|V_1|=${v_slack}$):</div>
                        <div class="text-xs font-mono bg-white p-4 rounded border overflow-x-auto">
                            $P_{${bus.bus},calc} = |V_{${bus.bus}}| \\sum_{j=1}^{${n}} |V_j| G_{${bus.bus}j}$ (Simplified for $\\delta=0$)<br/>
                            $P_{${bus.bus},calc} = (1.0) [ ${pSumString} ]$<br/>
                            $P_{${bus.bus},calc} = ${pSumVal.toFixed(4)}$ p.u.<br/><br/>
                            $\\Delta P_{${bus.bus}} = P_{${bus.bus},sch} - P_{${bus.bus},calc} = ${pi_sch.toFixed(4)} - ${pSumVal.toFixed(4)} = ${(pi_sch - pSumVal).toFixed(4)}$ p.u.
                        </div>
                    </div>
                `;
                }

                // 5. GENERATE ITERATION JOURNAL FROM REAL SOLVER DATA
                let iterationJournalHTML = "";
                const solData = window.lastSolverSolution;

                if (!solData || !solData.history || solData.history.length === 0) {
                    iterationJournalHTML = `<div class="p-8 text-center bg-white rounded-2xl border border-slate-200 shadow-sm text-slate-400 italic">No convergence data available. Run simulation first.</div>`;
                } else {
                    solData.history.forEach((h, kIdx) => {
                        const k = kIdx + 1;
                        let busMismatchRowsHTML = "";
                        let mismatchVectorValues = [];

                        // Extract actual bus-by-bus mismatches from dP and dQ
                        let dpIdx = 0;
                        currentData.forEach((bus, bIdx) => {
                            if (bus.bus === 1) return; // Slack
                            const dpVal = h.dP[dpIdx] || 0;
                            busMismatchRowsHTML += `
                            <div class="pl-4 border-l border-slate-200 py-1">
                                <span class="font-bold text-slate-700">Bus ${bus.bus}:</span><br/>
                                $\\Delta P_{${bus.bus}} = P_{sch} - P_{calc} = ${dpVal.toFixed(6)}$ p.u.
                            </div>
                        `;
                            mismatchVectorValues.push(dpVal.toFixed(6));
                            dpIdx++;
                        });

                        let dqIdx = 0;
                        currentData.forEach((bus, bIdx) => {
                            if (bus.bus === 1 || bus.type === 'PV') return;
                            const dqVal = h.dQ[dqIdx] || 0;
                            busMismatchRowsHTML += `
                            <div class="pl-4 border-l border-orange-200 py-1 bg-orange-50/20">
                                <span class="font-bold text-orange-700">Bus ${bus.bus} (Q):</span><br/>
                                $\\Delta Q_{${bus.bus}} = Q_{sch} - Q_{calc} = ${dqVal.toFixed(6)}$ p.u.
                            </div>
                        `;
                            mismatchVectorValues.push(dqVal.toFixed(6));
                            dqIdx++;
                        });

                        let jacobianProof = "";
                        if (k === 1) {
                            jacobianProof = `
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 mb-8">
                            <h6 class="text-[10px] font-bold text-blue-500 uppercase mb-4 tracking-widest flex items-center gap-2"><i class="ph ph-grid-four"></i> Full Jacobian Assembly ($J^{(1)}$)</h6>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="text-[10px] font-mono text-blue-800">
                                    \\[ J = \\begin{bmatrix} H & N \\\\ M & L \\end{bmatrix} = \\begin{bmatrix} \\frac{\\partial P}{\\partial \\delta} & \\frac{\\partial P}{\\partial |V|} \\\\ \\frac{\\partial Q}{\\partial \\delta} & \\frac{\\partial Q}{\\partial |V|} \\end{bmatrix} \\]
                                    <p class="mt-4 text-[9px] text-blue-400 italic">Matrix size: ${mismatchVectorValues.length}x${mismatchVectorValues.length} initialized using ${currentData.length} bus system topology.</p>
                                </div>
                                <div class="bg-white/60 p-4 rounded-xl space-y-3">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase">Diagonal Entry $H_{ii}$ Proof:</div>
                                    <div class="text-[10px] font-mono text-blue-700">
                                        $H_{ii} = -Q_{i,calc} - B_{ii}|V_i|^2$<br/>
                                        Status: Computed for all active state variables.
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                        }

                        iterationJournalHTML += `
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden animate-fadeIn mb-12">
                        <div class="bg-slate-900 px-6 py-4 flex justify-between items-center">
                            <h4 class="text-white font-bold">Iteration ${k}</h4>
                            <span class="text-[10px] text-slate-400 font-mono">Status: $\\max|\\Delta P, \\Delta Q| = ${h.maxError.toExponential(3)}$</span>
                        </div>
                        
                        <div class="p-8 space-y-6">
                            ${jacobianProof}
                            <div>
                                <h5 class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-4">A. Mismatch Vector Construction ($\\Delta S$)</h5>
                                <div class="flex flex-col md:flex-row gap-8 items-center bg-slate-50 p-6 rounded-xl overflow-x-auto">
                                    <div class="text-[10px] font-mono shrink-0">
                                        \\[ \\Delta S^{(k)} = \\begin{bmatrix} ${mismatchVectorValues.join(' \\\\ ')} \\end{bmatrix} \\]
                                    </div>
                                    <div class="grid grid-cols-2 gap-x-8 gap-y-2 text-[10px] font-mono leading-relaxed text-slate-500">
                                        ${busMismatchRowsHTML}
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-6 border-t border-slate-100">
                                <div>
                                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">B. Linear System Update</h5>
                                    <p class="text-xs text-slate-600 mb-4">Solving the sensitivity matrix equation:</p>
                                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-[10px] font-mono">
                                        \\[ \\begin{bmatrix} \\Delta \\delta \\\\ \\Delta |V| \\end{bmatrix} = - [J^{(k)}]^{-1} \\begin{bmatrix} \\Delta P \\\\ \\Delta Q \\end{bmatrix} \\]
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">C. Updated Coordinate Workspace</h5>
                                    <div class="space-y-2">
                                        ${currentData.map((b, bIdx) => {
                            return `<div class="flex justify-between text-[11px] font-mono border-b pb-1">
                                                <span class="text-slate-500 font-bold">Bus ${b.bus}</span>
                                                <span>$V = ${h.V[bIdx].toFixed(5)}, \\delta = ${(h.Delta[bIdx] * 180 / Math.PI).toFixed(4)}^{\\circ}$</span>
                                            </div>`;
                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    });
                }

                // Assemble Final HTML
                let html = `
                <div class="text-center space-y-4 mb-16">
                    <h2 class="text-5xl font-black text-slate-900 leading-tight">Newton-Raphson Final Proof</h2>
                    <p class="text-slate-500 max-w-2xl mx-auto italic">Step-by-step mathematical derivation following William D. Stevenson, Jr.'s "Elements of Power System Analysis".</p>
                    <div class="flex justify-center gap-6 text-sm font-bold uppercase tracking-widest text-blue-600 bg-blue-50 py-2 rounded-full w-fit mx-auto px-8 border border-blue-100 shadow-sm">
                        <span>Standard Stevenson Model</span>
                        <span class="text-slate-300">|</span>
                        <span>$S_{base} = ${baseMVA}$ MVA</span>
                    </div>
                </div>

                <!-- STEP 1: PARAMETER CONVERSION -->
                <section class="space-y-6">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">1</span>
                        <h3 class="text-2xl font-bold text-slate-800">Step 1: Branch Admittance Conversions</h3>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                        <p class="text-slate-600 mb-6">First, all branch impedances ($z$) are converted to admittances ($y$) to build the system matrix.</p>
                        <div class="space-y-4">
                            ${branchCalcHTML}
                        </div>
                    </div>
                </section>

                <!-- STEP 2: Y-BUS ASSEMBLY -->
                <section class="space-y-6">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">2</span>
                        <h3 class="text-2xl font-bold text-slate-800">Step 2: Formation of $[Y_{bus}]$</h3>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col">
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest flex items-center justify-between">
                                Assembly Log
                                <span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[8px]">Stevenson Algorithm</span>
                            </h4>
                            <div class="flex-1 max-h-80 overflow-y-auto pr-4 scroll-custom">
                                ${yBusStepsHTML}
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-slate-900 p-6 rounded-2xl shadow-xl overflow-x-auto text-blue-200">
                                 <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">Rectangular Form $[G + jB]$</h4>
                                 <div class="text-[10px] font-mono leading-relaxed">
                                    \\[ [Y_{bus}] = \\begin{bmatrix} 
                                        ${G.map((row, i) => Array.from(row).map((val, k) => {
                    const gVal = val.toFixed(2);
                    const bVal = B[i][k].toFixed(2);
                    return `${gVal}${B[i][k] >= 0 ? '+' : ''}${bVal}j`;
                }).join(' & ')).join(' \\\\ ')}
                                    \\end{bmatrix} \\]
                                 </div>
                            </div>
                            <!-- Polar Form Table (Item 4) -->
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Polar Admittance Proof ($|Y_{ij}| \\angle \\theta_{ij}$)</h4>
                                <table class="w-full text-[9px] font-mono text-left">
                                    <thead class="bg-slate-50 text-slate-500">
                                        <tr><th class="p-2">Element</th><th class="p-2">Magnitude</th><th class="p-2">Angle ($^{\\circ}$)</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${G.slice(0, 4).map((row, i) => Array.from(row).slice(0, 4).map((val, k) => {
                    const mag = Math.sqrt(val * val + B[i][k] * B[i][k]);
                    const ang = Math.atan2(B[i][k], val) * 180 / Math.PI;
                    return `<tr><td class="p-1.5 font-bold">Y_{${i + 1}${k + 1}}</td><td class="p-1.5">${mag.toFixed(4)}</td><td class="p-1.5">${ang.toFixed(2)}^\\circ</td></tr>`;
                }).join('')).join('')}
                                        ${n > 4 ? `<tr><td colspan="3" class="p-2 text-center text-slate-300 italic">... truncated for display ...</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- STEP 3: EQUATION PLUG-IN -->
                <section class="space-y-6">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">3</span>
                        <h3 class="text-2xl font-bold text-slate-800">Step 3: Power Equation Expansion (Full System)</h3>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                        <p class="text-slate-600">Substituting $V, \delta$ and $Y_{bus}$ elements into the non-linear power flow equations for every bus:</p>
                        ${currentData.filter(b => b.bus > 1).map(bus => {
                    const iIdx = b2idx[bus.bus];
                    const pi_sch = (bus.gp - bus.lp) / baseMVA;
                    const qi_sch = (bus.gq - bus.lq + (bus.injQ || 0)) / baseMVA;

                    return `
                            <div class="p-4 bg-slate-50 border rounded-xl mb-4">
                                <div class="font-bold text-slate-700 text-[10px] mb-2 uppercase tracking-tighter">Bus ${bus.bus} P/Q Equations:</div>
                                <div class="font-mono text-[9px] text-slate-600 overflow-x-auto space-y-2">
                                    <div>$P_{${bus.bus},calc} = |V_i| \sum_{j=1}^{n} |V_j| (G_{ij} \cos \delta_{ij} + B_{ij} \sin \delta_{ij})$</div>
                                    <div>$Q_{${bus.bus},calc} = |V_i| \sum_{j=1}^{n} |V_j| (G_{ij} \sin \delta_{ij} - B_{ij} \cos \delta_{ij})$</div>
                                    <div class="text-blue-600 mt-2">
                                        $\Delta P_{${bus.bus}} = ${pi_sch.toFixed(4)} - P_{${bus.bus},calc}$<br/>
                                        ${bus.type !== 'PV' ? `$\Delta Q_{${bus.bus}} = ${qi_sch.toFixed(4)} - Q_{${bus.bus},calc}$` : '<span class="italic text-slate-400">PV Bus: Reactive mismatch excluded from Jacobian</span>'}
                                    </div>
                                </div>
                            </div>`;
                }).join('')}
                    </div>
                </section>

                <!-- STEP 4: JACOBIAN DERIVATION -->
                <section class="space-y-6">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">4</span>
                        <h3 class="text-2xl font-bold text-slate-800">Step 4: Partial Derivatives (Jacobian $[J]$)</h3>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                        <p class="text-slate-600">The Jacobian matrix captures the sensitivity of power mismatches to state variable changes ($\Delta \\delta, \\Delta |V|$).</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <h5 class="text-sm font-bold border-b pb-2">Off-Diagonal Elements ($i \\neq k$)</h5>
                                <div class="text-[10px] font-mono bg-slate-50 p-4 rounded-lg">
                                    $H_{ik} = \\frac{\\partial P_i}{\\partial \\delta_k} = |V_i||V_k|(G_{ik}\\sin\\delta_{ik} - B_{ik}\\cos\\delta_{ik})$<br/><br/>
                                    $N_{ik} = \\frac{\\partial P_i}{\\partial |V_k|} = |V_i|(G_{ik}\\cos\\delta_{ik} + B_{ik}\\sin\\delta_{ik})$<br/><br/>
                                    $M_{ik} = \\frac{\\partial Q_i}{\\partial \\delta_k} = -|V_i||V_k|(G_{ik}\\cos\\delta_{ik} + B_{ik}\\sin\\delta_{ik}) = -N_{ik}|V_k|$
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h5 class="text-sm font-bold border-b pb-2">Diagonal Elements ($i = k$)</h5>
                                <div class="text-[10px] font-mono bg-slate-50 p-4 rounded-lg">
                                    $H_{ii} = \\frac{\\partial P_i}{\\partial \\delta_i} = -Q_{i,calc} - B_{ii}|V_i|^2$<br/><br/>
                                    $L_{ii} = \\frac{\\partial Q_i}{\\partial |V_i|} = Q_{i,calc} - B_{ii}|V_i|^2$<br/><br/>
                                    $N_{ii} = \\frac{\\partial P_i}{\\partial |V_i|} = P_{i,calc} + G_{ii}|V_i|^2$
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-900 text-white p-8 rounded-2xl shadow-2xl text-center">
                            <div class="text-xs uppercase font-bold tracking-[0.2em] text-blue-400 mb-4">Linearized System Model</div>
                            \\[ \\begin{bmatrix} \\Delta P \\\\ \\Delta Q \\end{bmatrix} = \\begin{bmatrix} H & N \\\\ M & L \\end{bmatrix} \\begin{bmatrix} \\Delta \\delta \\\\ \\Delta |V| \\end{bmatrix} \\]
                            <p class="text-xs text-blue-300 mt-6 italic">This matrix is inverted in each iteration using Gaussian Elimination until mismatches $\\approx 0$.</p>
                        </div>
                    </div>
                </section>

                <section class="space-y-8">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-emerald-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">5</span>
                        <h3 class="text-2xl font-bold text-slate-800">Step 5: Iteration Journal & Solution Path</h3>
                    </div>
                    
                    <div class="space-y-12">
                        ${iterationJournalHTML}
                    </div>
                </section>

                <section class="space-y-8">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">6</span>
                        <h3 class="text-2xl font-bold text-slate-800">Final Line Flow & Loss Proof (Actual Amps)</h3>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                        <p class="text-sm text-slate-600 mb-4">Using converged voltages to calculate complex power flow $S_{ij}$ and line current magnitude $I_{Actual}$ in Amperes.</p>
                        
                        ${(() => {
                        let totalLossP_sum = 0;
                        let maxCurrent = 0;
                        let maxCurrentLine = "";

                        activeBranches.forEach(branch => {
                            const fromBus = currentData.find(b => b.bus == branch.from);
                            const toBus = currentData.find(b => b.bus == branch.to);
                            const fromV = fromBus.mag;
                            const toV = toBus.mag;
                            const isXfmr = branch.type === 'transformer';
                            const tap = isXfmr ? (parseFloat(branch.tap) || 1.0) : 1.0;
                            const r_br = parseFloat(branch.r) || 0;
                            const x_br = parseFloat(branch.x) || 0.0001;
                            const den_z = r_br * r_br + x_br * x_br;
                            const g_br = r_br / den_z;
                            const b_br = -x_br / den_z;
                            const a1 = fromBus.ang * Math.PI / 180;
                            const a2 = toBus.ang * Math.PI / 180;
                            const da = a1 - a2;

                            const p_pu = (g_br * (fromV * fromV / (tap * tap))) - (fromV * toV / tap) * (g_br * Math.cos(da) + b_br * Math.sin(da));
                            const q_pu = -((b_br / (tap * tap)) * fromV * fromV) - (fromV * toV / tap) * (g_br * Math.sin(da) - b_br * Math.cos(da));
                            const s_mva_val = Math.sqrt(p_pu * p_pu + q_pu * q_pu);
                            const busBaseKV = fromBus.baseKV || 230;
                            const baseAmps = (baseMVA * 1000) / (Math.sqrt(3) * busBaseKV);
                            const current = (s_mva_val / fromV) * baseAmps;

                            if (current > maxCurrent) {
                                maxCurrent = current;
                                maxCurrentLine = `Line L${branch.id} (Bus ${branch.from} to ${branch.to})`;
                            }

                            const loss_pu = (p_pu + (toV * toV * g_br - (toV * (fromV / tap)) * (g_br * Math.cos(-da) + b_br * Math.sin(-da))));
                            totalLossP_sum += loss_pu * baseMVA;
                        });

                        return `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                    <div class="p-6 bg-red-50 rounded-2xl border border-red-100 shadow-sm">
                                        <h5 class="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-1">Total Real Power Loss</h5>
                                        <div class="text-3xl font-black text-red-600">${totalLossP_sum.toFixed(4)} <span class="text-sm font-normal">MW</span></div>
                                    </div>
                                    <div class="p-6 bg-indigo-50 rounded-2xl border border-indigo-100 shadow-sm">
                                        <h5 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Peak Line Loading</h5>
                                        <div class="text-xl font-black text-indigo-700 leading-tight">${maxCurrent.toFixed(2)} A</div>
                                        <div class="text-[9px] font-bold text-indigo-300 mt-1 uppercase">${maxCurrentLine}</div>
                                    </div>
                                    <div class="p-6 bg-emerald-50 rounded-2xl border border-emerald-100 shadow-sm">
                                        <h5 class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1">Transmission Efficiency</h5>
                                        <div class="text-3xl font-black text-emerald-600">${(100 * (1 - totalLossP_sum / currentData.reduce((s, b) => s + b.gp, 0))).toFixed(2)} %</div>
                                    </div>
                                </div>
                            `;
                    })()}
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-[10px] text-left">
                                <thead class="bg-slate-900 text-slate-300 uppercase font-bold tracking-tighter">
                                    <tr>
                                        <th class="px-4 py-3">Line Path</th>
                                        <th class="px-4 py-3">$P_{flow}$ (MW)</th>
                                        <th class="px-4 py-3">$Q_{flow}$ (MVar)</th>
                                        <th class="px-4 py-3">$S_{total}$ (MVA)</th>
                                        <th class="px-4 py-3">Actual Current (A)</th>
                                        <th class="px-4 py-3">I Angle</th>
                                        <th class="px-4 py-3">Loss (MW)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 font-mono text-slate-600">
                                    ${(() => {
                        let summaryRows = "";
                        let detailedRows = "";

                        activeBranches.forEach(branch => {
                            const fromBus = currentData.find(b => b.bus == branch.from);
                            const toBus = currentData.find(b => b.bus == branch.to);
                            const fromV = fromBus.mag;
                            const toV = toBus.mag;
                            const busBaseKV = fromBus.baseKV || 230;
                            const baseAmps = (baseMVA * 1000) / (Math.sqrt(3) * busBaseKV);
                            const r = parseFloat(branch.r) || 0.02;
                            const x = parseFloat(branch.x) || 0.1;

                            const a1 = fromBus.ang * Math.PI / 180;
                            const a2 = toBus.ang * Math.PI / 180;
                            const da = a1 - a2;
                            const isXfmr = branch.type === 'transformer';
                            const tap = isXfmr ? (branch.tap || 1.0) : 1.0;

                            const r_br = parseFloat(branch.r) || 0;
                            const x_br = parseFloat(branch.x) || 0.0001;
                            const den_z = r_br * r_br + x_br * x_br;
                            const g_br = r_br / den_z;
                            const b_br = -x_br / den_z;

                            const p_pu = (g_br * (fromV * fromV / (tap * tap))) - (fromV * toV / tap) * (g_br * Math.cos(da) + b_br * Math.sin(da));
                            const q_pu = -((b_br / (tap * tap)) * fromV * fromV) - (fromV * toV / tap) * (g_br * Math.sin(da) - b_br * Math.cos(da));

                            const s_mva_val = Math.sqrt(p_pu * p_pu + q_pu * q_pu);
                            const s_mva = s_mva_val * baseMVA;
                            const i_pu = s_mva_val / fromV;
                            const i_amps = i_pu * baseAmps;

                            const i_ang_rad = Math.atan2(-q_pu, p_pu) + a1;
                            const i_ang_deg = i_ang_rad * 180 / Math.PI;

                            const loss_pu = (p_pu + (toV * toV * g_br - (toV * (fromV / tap)) * (g_br * Math.cos(-da) + b_br * Math.sin(-da))));
                            const loss_mw = loss_pu * baseMVA;

                            // 1. Build Summary Row
                            summaryRows += `
                            <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3 font-bold text-slate-900">${branch.from} $\\to$ ${branch.to} <span class="text-[8px] font-normal text-slate-400 font-sans">(${busBaseKV}kV)</span></td>
                                <td class="px-4 py-3 text-emerald-600">${(p_pu * baseMVA).toFixed(2)}</td>
                                <td class="px-4 py-3 text-amber-600">${(q_pu * baseMVA).toFixed(2)}</td>
                                <td class="px-4 py-3 text-slate-700">${s_mva.toFixed(2)}</td>
                                <td class="px-4 py-3 font-black text-slate-900">${i_amps.toFixed(2)} A</td>
                                <td class="px-4 py-3 text-blue-600">${i_ang_deg.toFixed(2)}°</td>
                                <td class="px-4 py-3 text-red-500 font-bold">${loss_mw.toFixed(4)}</td>
                            </tr>
                        `;

                            // 2. Build Detailed Row (Calculations)
                            detailedRows += `
                                        <tr class="bg-slate-50/50">
                                            <td colspan="7" class="px-4 py-4">
                                                <div class="flex flex-col gap-3">
                                                    <div class="flex items-center gap-2">
                                                        <span class="bg-indigo-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold">CALCULATION L${branch.id}</span>
                                                        <span class="font-bold text-slate-800 text-sm">Flow Analysis: Bus ${branch.from} $\\to$ ${branch.to}</span>
                                                    </div>
                                                    
                                                    <div class="space-y-6 text-[10px] font-mono bg-white p-6 rounded-xl border border-slate-100 shadow-sm overflow-x-auto">
                                                        <div class="space-y-4">
                                                             <div class="text-blue-600 font-bold border-b border-blue-50 pb-1">1. Complex Power Flow Calculation ($S_{ij}$)</div>
                                                            $P_{${branch.from}${branch.to}} = |V_i/a|^2 g_{ij} - |V_i/a||V_j|(g_{ij}\cos\delta_{ij} + b_{ij}\sin\delta_{ij})$<br/>
                                                            $P = |${fromV.toFixed(4)}/${tap.toFixed(2)}|^2(${g_br.toFixed(4)}) - |${fromV.toFixed(4)}/${tap.toFixed(2)}|(${toV.toFixed(4)})(${g_br.toFixed(4)}\cos(${(da * 180 / Math.PI).toFixed(2)}^\circ) + ${b_br.toFixed(4)}\sin(${(da * 180 / Math.PI).toFixed(2)}^\circ)) = ${p_pu.toFixed(6)}$ p.u.<br/>
                                                            <span class="text-emerald-600 font-bold">$P_{Actual} = ${p_pu.toFixed(6)} \times ${baseMVA} = ${(p_pu * baseMVA).toFixed(2)}$ MW</span><br/>
                                                            
                                                            <div class="pt-2">
                                                                $Q_{${branch.from}${branch.to}} = -|V_i/a|^2 b_{ij} - |V_i/a||V_j|(g_{ij}\sin\delta_{ij} - b_{ij}\cos\delta_{ij})$<br/>
                                                                $Q = -|${fromV.toFixed(4)}/${tap.toFixed(2)}|^2(${b_br.toFixed(4)}) - |${fromV.toFixed(4)}/${tap.toFixed(2)}|(${toV.toFixed(4)})(${g_br.toFixed(4)}\sin(${(da * 180 / Math.PI).toFixed(2)}^\circ) - ${b_br.toFixed(4)}\cos(${(da * 180 / Math.PI).toFixed(2)}^\circ)) = ${q_pu.toFixed(6)}$ p.u.<br/>
                                                                <span class="text-amber-600 font-bold">$Q_{Actual} = ${q_pu.toFixed(6)} \times ${baseMVA} = ${(q_pu * baseMVA).toFixed(2)}$ Mvar</span>
                                                                
                                                                <!-- Detailed Component Breakdown (Item 6) -->
                                                                <div class="mt-3 bg-slate-50/50 p-2 rounded border border-slate-100 text-[8px] flex gap-4">
                                                                    <div><span class="text-slate-400 uppercase font-black">Line Current (Mag):</span> ${i_pu.toFixed(5)} p.u.</div>
                                                                    <div><span class="text-slate-400 uppercase font-black">$I^2R$ Loss:</span> ${(Math.pow(i_pu, 2) * g_br * baseMVA).toFixed(4)} MW</div>
                                                                    <div><span class="text-slate-400 uppercase font-black">$I^2X$ Loss:</span> ${(Math.pow(i_pu, 2) * Math.abs(b_br) * baseMVA).toFixed(4)} Mvar</div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="space-y-4 border-t border-slate-50 pt-4">
                                                            <div class="text-indigo-600 font-bold border-b border-indigo-50 pb-1">2. Line Current Derivation ($I_{ij}$)</div>
                                                            $I_{ij} = \\frac{S_{ij}^*}{V_i^*} = \\frac{${p_pu.toFixed(4)} - j(${q_pu.toFixed(4)})}{${fromV.toFixed(4)}\\angle-${fromBus.ang.toFixed(2)}^\\circ}$<br/>
                                                            $|I_{ij}| = \\frac{\\sqrt{P^2 + Q^2}}{|V_i|} = \\frac{${s_mva_val.toFixed(6)}}{${fromV.toFixed(4)}} = ${i_pu.toFixed(6)}$ p.u.<br/>
                                                            $\\angle I_{ij} = \\text{atan2}(-Q, P) + \\delta_i = ${(Math.atan2(-q_pu, p_pu) * 180 / Math.PI).toFixed(2)}^\\circ + ${fromBus.ang.toFixed(2)}^\\circ = ${i_ang_deg.toFixed(2)}^\\circ$<br/>
                                                            <span class="text-slate-900 font-black">$I_{Actual} = ${i_pu.toFixed(6)} \\times ${baseAmps.toFixed(2)} = ${i_amps.toFixed(2)}$ Amperes</span>

                                                            <div class="pt-2">
                                                                <div class="text-red-600 font-bold border-b border-red-50 pb-1">3. Transmission Loss</div>
                                                                $P_{loss} = P_{ij} + P_{ji} = ${p_pu.toFixed(6)} + (${(loss_pu - p_pu).toFixed(6)}) = ${loss_pu.toFixed(6)}$ p.u.<br/>
                                                                <span class="text-red-500 font-bold">$P_{loss, (MW)} = ${loss_pu.toFixed(6)} \\times ${baseMVA} = ${loss_mw.toFixed(4)}$ MW</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                        });

                        return summaryRows + `
                        <tr class="bg-indigo-50/50">
                            <td colspan="7" class="px-4 py-2 font-bold text-indigo-900 text-[9px] uppercase tracking-widest text-center border-y border-indigo-100">
                                Detailed Mathematical Proofs Below
                            </td>
                        </tr>
                    ` + detailedRows;
                    })()}$
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="space-y-8">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">7</span>
                        <h3 class="text-2xl font-bold text-slate-800">Sending & Receiving End Power Summary</h3>
                    </div>
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm overflow-x-auto">
                        <table class="w-full text-[11px] text-center border-collapse border border-slate-300">
                            <thead>
                                <tr class="bg-slate-50 font-bold text-slate-700">
                                    <th colspan="2" class="border border-slate-300 px-3 py-2">Line</th>
                                    <th colspan="2" class="border border-slate-300 px-3 py-2">Sending end</th>
                                    <th colspan="2" class="border border-slate-300 px-3 py-2">Receiving end</th>
                                </tr>
                                <tr class="bg-slate-50 text-[9px] uppercase tracking-wider text-slate-500 font-bold">
                                    <th class="border border-slate-300 px-3 py-2">From</th>
                                    <th class="border border-slate-300 px-3 py-2">To</th>
                                    <th class="border border-slate-300 px-3 py-2">P (MW)</th>
                                    <th class="border border-slate-300 px-3 py-2">Q (Mvar)</th>
                                    <th class="border border-slate-300 px-3 py-2">P (MW)</th>
                                    <th class="border border-slate-300 px-3 py-2">Q (Mvar)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 font-mono text-slate-700">
                                ${(() => {
                        let rows = "";
                        activeBranches.forEach(branch => {
                            const fromBus = currentData.find(b => b.bus == branch.from);
                            const toBus = currentData.find(b => b.bus == branch.to);
                            if (!fromBus || !toBus) return;

                            const v1 = fromBus.mag;
                            const v2 = toBus.mag;
                            const a1 = fromBus.ang * Math.PI / 180;
                            const a2 = toBus.ang * Math.PI / 180;
                            const da = a1 - a2;

                            const isXfmr = branch.type === 'transformer';
                            const tap = isXfmr ? (parseFloat(branch.tap) || 1.0) : 1.0;
                            const r = parseFloat(branch.r) || 0;
                            const x = parseFloat(branch.x) || 0.0001;
                            const b_sh = parseFloat(branch.b_charging) || 0;

                            const den = r * r + x * x;
                            const g = r / den;
                            const b = -x / den;

                            const p_ft = (g * (v1 * v1 / (tap * tap))) - (v1 * v2 / tap) * (g * Math.cos(da) + b * Math.sin(da));
                            const q_ft = -((b + b_sh) / (tap * tap) * v1 * v1) - (v1 * v2 / tap) * (g * Math.sin(da) - b * Math.cos(da));
                            const p_tf = v2 * v2 * g - (v2 * (v1 / tap)) * (g * Math.cos(-da) + b * Math.sin(-da));
                            const q_tf = -((b + b_sh) * v2 * v2) - (v2 * (v1 / tap)) * (g * Math.sin(-da) - b * Math.cos(-da));

                            rows += `
                                            <tr class="hover:bg-slate-50 transition-colors">
                                                <td class="border border-slate-200 px-3 py-2 font-bold text-slate-900">${branch.from}</td>
                                                <td class="border border-slate-200 px-3 py-2 font-bold text-slate-900">${branch.to}</td>
                                                <td class="border border-slate-200 px-3 py-2 text-emerald-600 font-bold">${(p_ft * baseMVA).toFixed(3)}</td>
                                                <td class="border border-slate-200 px-3 py-2 text-emerald-600">${(q_ft * baseMVA).toFixed(3)}</td>
                                                <td class="border border-slate-200 px-3 py-2 text-red-600 font-bold">${(p_tf * baseMVA).toFixed(3)}</td>
                                                <td class="border border-slate-200 px-3 py-2 text-red-600">${(q_tf * baseMVA).toFixed(3)}</td>
                                            </tr>
                                        `;
                        });
                        return rows;
                    })()}
                            </tbody>
                        </table>
                    </div>

                <section class="space-y-8">
                    <div class="flex items-center gap-4">
                        <span class="w-12 h-12 bg-emerald-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">8</span>
                        <h3 class="text-2xl font-bold text-slate-800">Final System State (Converged Results)</h3>
                    </div>
                    
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-8">
                        ${(() => {
                        let totalPGen = 0, totalPRes = 0;
                        let minVMag = 2, minVBus = 0;
                        let maxVMag = -1, maxVBus = 0;

                        currentData.forEach(b => {
                            totalPGen += b.gp;
                            totalPRes += b.lp;
                            if (b.mag < minVMag) { minVMag = b.mag; minVBus = b.bus; }
                            if (b.mag > maxVMag) { maxVMag = b.mag; maxVBus = b.bus; }
                        });

                        return `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                                    <div class="p-6 bg-slate-900 rounded-3xl shadow-xl text-white relative overflow-hidden group">
                                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/30 transition-colors"></div>
                                        <h5 class="text-[10px] font-bold text-blue-400 uppercase tracking-[0.2em] mb-4">Generation vs Demand</h5>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-end">
                                                <span class="text-xs text-slate-400 italic">Total Gen</span>
                                                <span class="text-xl font-black text-blue-100">${totalPGen.toFixed(2)} MW</span>
                                            </div>
                                            <div class="flex justify-between items-end border-t border-slate-800 pt-2">
                                                <span class="text-xs text-slate-400 italic">Total Load</span>
                                                <span class="text-xl font-black text-purple-300">${totalPRes.toFixed(2)} MW</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="p-6 bg-white rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-between">
                                        <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                                            <i class="ph ph-chart-line-up text-emerald-500"></i> Voltage Extremes
                                        </h5>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <div class="text-[9px] text-slate-400 font-bold uppercase">Max (Bus ${maxVBus})</div>
                                                <div class="text-lg font-black text-slate-800">${maxVMag.toFixed(4)} <span class="text-[10px] font-normal">p.u.</span></div>
                                            </div>
                                            <div>
                                                <div class="text-[9px] text-slate-400 font-bold uppercase text-right">Min (Bus ${minVBus})</div>
                                                <div class="text-lg font-black text-red-600 text-right">${minVMag.toFixed(4)} <span class="text-[10px] font-normal">p.u.</span></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-6 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl shadow-lg shadow-blue-500/20 text-white">
                                        <h5 class="text-[10px] font-bold text-blue-200 uppercase tracking-[0.2em] mb-4">Newton-Raphson Stability</h5>
                                        <div class="text-4xl font-black mb-1">CONVERGED</div>
                                        <div class="text-[10px] text-blue-100 font-medium bg-white/10 w-fit px-2 py-0.5 rounded-full backdrop-blur-sm">
                                            System Balance: ${Math.abs(totalPGen - totalPRes).toFixed(4)} MW (Loss Offset)
                                        </div>
                                    </div>
                                </div>
                            `;
                    })()}
                        <div class="space-y-8">
                                    ${(() => {
                        let summaryTableHTML = `
                        <div class="overflow-x-auto mb-12 bg-white rounded-xl border border-slate-200">
                            <table class="w-full text-[10px] text-left">
                                <thead class="bg-slate-900 text-slate-300 uppercase font-bold tracking-tighter">
                                    <tr>
                                        <th class="px-4 py-3">Bus</th>
                                        <th class="px-4 py-3">$V$ (p.u.)</th>
                                        <th class="px-4 py-3">$V$ (kV)</th>
                                        <th class="px-4 py-3">Angle</th>
                                        <th class="px-4 py-3">P (MW)</th>
                                        <th class="px-4 py-3">Q (MVar)</th>
                                        <th class="px-4 py-3">S (MVA)</th>
                                        <th class="px-4 py-3">I (p.u.)</th>
                                        <th class="px-4 py-3">I (Amps)</th>
                                        <th class="px-4 py-3">I Angle</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 font-mono text-slate-600">
                    `;

                        let derivationsHTML = "";
                        currentData.forEach(b => {
                            const busBaseKV = b.baseKV || 230;
                            const v_kv = (b.mag * busBaseKV).toFixed(2);
                            const p_mw = (b.gp - b.lp).toFixed(2);
                            const q_mvar = (b.gq - b.lq).toFixed(2);
                            const s_mva_val = Math.sqrt(Math.pow(p_mw, 2) + Math.pow(q_mvar, 2));
                            const s_mva = s_mva_val.toFixed(2);
                            const i_pu = (s_mva_val / baseMVA) / b.mag;
                            const i_base = (baseMVA * 1000) / (Math.sqrt(3) * busBaseKV);
                            const i_amps = i_pu * i_base;

                            const s_star_angle_rad = Math.atan2(-q_mvar, p_mw);
                            const cur_angle_deg = (s_star_angle_rad * 180 / Math.PI) + b.ang;

                            summaryTableHTML += `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3 font-bold text-slate-900">${b.bus} <span class="text-[8px] font-normal text-slate-400 font-sans">(${busBaseKV}kV)</span></td>
                                <td class="px-4 py-3 text-blue-600 font-bold">${b.mag.toFixed(4)}</td>
                                <td class="px-4 py-3 text-slate-900">${v_kv}</td>
                                <td class="px-4 py-3 text-blue-500">${b.ang.toFixed(4)}°</td>
                                <td class="px-4 py-3 text-emerald-600">${p_mw}</td>
                                <td class="px-4 py-3 text-amber-600">${q_mvar}</td>
                                <td class="px-4 py-3 text-slate-700">${s_mva}</td>
                                <td class="px-4 py-3 text-slate-400">${i_pu.toFixed(5)}</td>
                                <td class="px-4 py-3 font-black text-slate-900">${i_amps.toFixed(2)} A</td>
                                <td class="px-4 py-3 text-indigo-600">${cur_angle_deg.toFixed(2)}°</td>
                            </tr>
                        `;

                            derivationsHTML += `
                            <div class="bg-slate-50 rounded-2xl border border-slate-200 p-6 mb-8 hover:border-blue-300 transition-colors shadow-sm relative group">
                                <div class="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="bg-blue-100 text-blue-700 text-[8px] px-2 py-1 rounded-full font-bold uppercase tracking-widest">Mathematical Proof</span>
                                </div>
                                <div class="flex items-center justify-between mb-4 border-b border-slate-200 pb-3">
                                    <h4 class="text-lg font-black text-slate-800 uppercase tracking-tighter">
                                        Bus ${b.bus} <span class="text-xs font-normal text-slate-400 ml-2">(${busBaseKV} kV Base)</span>
                                    </h4>
                                    <div class="flex gap-4">
                                        <div class="text-right">
                                            <div class="text-[9px] text-slate-400 font-bold uppercase">Mag/Angle</div>
                                            <div class="text-sm font-black text-blue-600">${b.mag.toFixed(4)} p.u. / ${b.ang.toFixed(2)}°</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[9px] text-slate-400 font-bold uppercase">Net Power ($S$)</div>
                                            <div class="text-sm font-black text-emerald-600">${p_mw} MW + j${q_mvar} Mvar</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-8 overflow-x-auto">
                                    <div class="space-y-6">
                                        <div>
                                            <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><i class="ph ph-lightning"></i> Net Injection Calculation</h5>
                                            <div class="text-xs font-mono bg-white p-3 rounded-lg border border-slate-100">
                                                $P_{bus} = P_{gen} - P_{load} = ${b.gp} - ${b.lp} = ${p_mw}$ MW<br/>
                                                $Q_{bus} = Q_{gen} - Q_{load} + Q_{inj} = ${b.gq} - ${b.lq} + ${b.injQ || 0} = ${q_mvar}$ Mvar<br/>
                                                $S_{bus} = \\sqrt{${p_mw}^2 + ${q_mvar}^2} = ${s_mva_val.toFixed(2)}$ MVA
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><i class="ph ph-activity"></i> Bus Voltage Scaling</h5>
                                            <div class="text-xs font-mono bg-white p-3 rounded-lg border border-slate-100">
                                                $V_{Actual} = V_{p.u.} \\times V_{Base} = ${b.mag.toFixed(4)} \\times ${busBaseKV}$<br/>
                                                $\mathbf{V_{Actual} = ${v_kv} \\text{ kV}}$
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-6 border-t border-slate-100 pt-6">
                                        <div>
                                            <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><i class="ph ph-square-half"></i> Current Magnitude (Ampere) Proof</h5>
                                            <div class="text-xs font-mono bg-white p-3 rounded-lg border border-slate-100">
                                                $I_{p.u.} = \\frac{S_{p.u.}}{V_{p.u.}} = \\frac{${(s_mva_val / baseMVA).toFixed(5)}}{${b.mag.toFixed(4)}} = ${i_pu.toFixed(6)}$ p.u.<br/>
                                                $I_{base} = \\frac{S_{base}}{\\sqrt{3} V_{base}} = \\frac{${baseMVA} \\times 10^{3}}{\\sqrt{3} \\times ${busBaseKV}} = ${i_base.toFixed(2)}$ A<br/>
                                                $I_{Amps} = ${i_pu.toFixed(6)} \\times ${i_base.toFixed(2)} = \\mathbf{${i_amps.toFixed(2)} \\text{ A}}$
                                            </div>
                                        </div>

                                        <div>
                                            <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1"><i class="ph ph-compass"></i> Current Phase Angle Derivation</h5>
                                            <div class="text-xs font-mono bg-white p-3 rounded-lg border border-slate-100">
                                                $\\angle I = \\text{atan2}(-Q_{bus}, P_{bus}) + \\angle \\delta$<br/>
                                                $\\angle I = \\text{atan2}(-${q_mvar}, ${p_mw}) + ${b.ang.toFixed(2)}^\\circ$<br/>
                                                $\\mathbf{\\angle I = ${cur_angle_deg.toFixed(2)}^\\circ}$
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        });

                        summaryTableHTML += `</tbody></table></div>`;

                        return summaryTableHTML + `
                        <div class="flex items-center gap-2 mb-6">
                            <div class="h-px flex-1 bg-slate-200"></div>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Step-by-Step Mathematical Derivations</span>
                            <div class="h-px flex-1 bg-slate-200"></div>
                        </div>
                    ` + derivationsHTML;
                    })()}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <h5 class="text-[9px] font-bold text-slate-400 uppercase mb-2">Total System Load</h5>
                                <div class="text-xl font-black text-slate-800">
                                    ${currentData.reduce((sum, b) => sum + b.lp, 0).toFixed(2)} <span class="text-xs font-normal text-slate-500">MW</span>
                                </div>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <h5 class="text-[9px] font-bold text-slate-400 uppercase mb-2">Actual Base System</h5>
                                <div class="text-xl font-black text-slate-800">
                                    ${baseMVA} <span class="text-xs font-normal text-slate-500">MVA</span> / ${parseFloat(document.getElementById('baseKVInput').value) || 230} <span class="text-xs font-normal text-slate-500">kV</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="pt-12 border-t border-slate-200 text-center text-slate-400 text-[10px] uppercase tracking-widest pb-10">
                    Homework Verification Complete &middot; System Engineering Report &middot; No Shortcuts Applied &middot; Stevenson Methodology
                </div>
            `;

                content.innerHTML = html;

                if (window.MathJax) {
                    MathJax.typesetPromise([content]).then(() => {
                        btn.innerHTML = `<i class="ph ph-arrows-counter-clockwise"></i> Regenerate`;
                        btn.disabled = false;
                    }).catch(err => {
                        console.error("MathJax error:", err);
                        btn.innerHTML = `<i class="ph ph-arrows-counter-clockwise"></i> Regenerate`;
                        btn.disabled = false;
                    });
                } else {
                    btn.innerHTML = `<i class="ph ph-arrows-counter-clockwise"></i> Regenerate`;
                    btn.disabled = false;
                }
            }, 100);
        }


        // --- RIGOROUS NEWTON-RAPHSON SOLVER ---
        function solvePowerFlow(busData, branchData, baseMVA = 100, maxIter = 50, tolerance = 1e-6) {
            const n = busData.length;
            const busMap = new Map();
            busData.forEach((b, i) => busMap.set(b.bus, i));

            // Identify Bus Types (Standardized)
            const pqBuses = [], pvBuses = [];
            let slackIdx = -1;
            busData.forEach((b, i) => {
                if (b.type === 'Slack' || b.bus === 1) slackIdx = i;
                else if (b.type === 'PV') pvBuses.push(i);
                else pqBuses.push(i);
            });

            // Initialize State Variables (Float Start)
            let V = busData.map(b => b.mag || 1.0);
            let Delta = busData.map(b => (b.ang || 0) * Math.PI / 180);

            // Construct Y-Bus Matrix
            const G = Array.from({ length: n }, () => new Float64Array(n).fill(0));
            const B = Array.from({ length: n }, () => new Float64Array(n).fill(0));

            branchData.forEach(br => {
                const i = busMap.get(br.from);
                const k = busMap.get(br.to);
                if (i === undefined || k === undefined) return;

                const isTrans = br.type === 'transformer';
                const r = parseFloat(br.r) || 0;
                const x = parseFloat(br.x) || 0.0001;
                const a = isTrans ? (parseFloat(br.tap) || 1.0) : 1.0;
                const b_sh = parseFloat(br.b_charging) || 0;

                const den = r * r + x * x;
                if (den === 0) return;
                const g_line = r / den;
                const b_line = -x / den;

                // Off-diagonals: Yik = Yki = -y / a
                const g_mut = g_line / a;
                const b_mut = b_line / a;
                G[i][k] -= g_mut; B[i][k] -= b_mut;
                G[k][i] -= g_mut; B[k][i] -= b_mut;

                // Diagonals (using the a:1 model where a is the tap ratio on the 'from' bus side)
                G[i][i] += g_line / (a * a);
                B[i][i] += b_line / (a * a) + b_sh;

                G[k][k] += g_line;
                B[k][k] += b_line + b_sh;
            });

            let history = [];
            let P_final = new Float64Array(n);
            let Q_final = new Float64Array(n);

            for (let iter = 0; iter < maxIter; iter++) {
                const P_calc = new Float64Array(n);
                const Q_calc = new Float64Array(n);

                // 1. Calculate Power at each bus
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        const d_ij = Delta[i] - Delta[j];
                        P_calc[i] += V[i] * V[j] * (G[i][j] * Math.cos(d_ij) + B[i][j] * Math.sin(d_ij));
                        Q_calc[i] += V[i] * V[j] * (G[i][j] * Math.sin(d_ij) - B[i][j] * Math.cos(d_ij));
                    }
                }
                P_final = P_calc;
                Q_final = Q_calc;

                // 2. Calculate Mismatches
                const dP = [], dQ = [];
                const stateMap = []; // Maps Jacobian indices to [busIdx, type (0=delta, 1=V)]

                // Delta sub-vector (for all but Slack)
                busData.forEach((b, i) => {
                    if (i === slackIdx) return;
                    const P_sch = (b.gp - b.lp) / baseMVA;
                    dP.push(P_sch - P_calc[i]);
                    stateMap.push({ busIdx: i, type: 0 });
                });

                // Magnitude sub-vector (for PQ only)
                busData.forEach((b, i) => {
                    if (i === slackIdx || pvBuses.includes(i)) return;
                    const Q_sch = (b.gq - b.lq + (b.injQ || 0)) / baseMVA;
                    dQ.push(Q_sch - Q_calc[i]);
                    stateMap.push({ busIdx: i, type: 1 });
                });

                const mismatches = dP.concat(dQ);
                const maxError = Math.max(...mismatches.map(Math.abs));
                // Rigorous update: Store full mismatch vectors for manual calc modal
                history.push({
                    iter: iter + 1,
                    maxError,
                    dP: [...dP],
                    dQ: [...dQ],
                    V: [...V],
                    Delta: [...Delta]
                });

                if (maxError < tolerance) {
                    return { converged: true, V, Delta, iterations: iter + 1, history, P: P_final, Q: Q_final };
                }

                // 3. Build Jacobian
                const m = mismatches.length;
                const J = Array.from({ length: m }, () => new Float64Array(m).fill(0));

                for (let row = 0; row < m; row++) {
                    const i = stateMap[row].busIdx;
                    const rowType = stateMap[row].type;

                    for (let col = 0; col < m; col++) {
                        const k = stateMap[col].busIdx;
                        const colType = stateMap[col].type;

                        if (rowType === 0 && colType === 0) { // H = dP/dDelta
                            if (i === k) J[row][col] = -Q_calc[i] - B[i][i] * V[i] * V[i];
                            else J[row][col] = V[i] * V[k] * (G[i][k] * Math.sin(Delta[i] - Delta[k]) - B[i][k] * Math.cos(Delta[i] - Delta[k]));
                        }
                        else if (rowType === 0 && colType === 1) { // N = dP/dV * V
                            if (i === k) J[row][col] = P_calc[i] + G[i][i] * V[i] * V[i];
                            else J[row][col] = V[i] * V[k] * (G[i][k] * Math.cos(Delta[i] - Delta[k]) + B[i][k] * Math.sin(Delta[i] - Delta[k]));
                        }
                        else if (rowType === 1 && colType === 0) { // M = dQ/dDelta
                            if (i === k) J[row][col] = P_calc[i] - G[i][i] * V[i] * V[i];
                            else J[row][col] = -V[i] * V[k] * (G[i][k] * Math.cos(Delta[i] - Delta[k]) + B[i][k] * Math.sin(Delta[i] - Delta[k]));
                        }
                        else if (rowType === 1 && colType === 1) { // L = dQ/dV * V
                            if (i === k) J[row][col] = Q_calc[i] - B[i][i] * V[i] * V[i];
                            else J[row][col] = V[i] * V[k] * (G[i][k] * Math.sin(Delta[i] - Delta[k]) - B[i][k] * Math.cos(Delta[i] - Delta[k]));
                        }
                    }
                }

                // 4. Solve J * dx = mismatches
                const dx = solveLinearSystem(J, mismatches);

                // 5. Update State
                for (let i = 0; i < m; i++) {
                    const busIdx = stateMap[i].busIdx;
                    if (stateMap[i].type === 0) Delta[busIdx] += dx[i];
                    else V[busIdx] += dx[i] * V[busIdx]; // Here we solved for dV/V
                }
            }

            return { converged: false, V, Delta, iterations: maxIter, history, P: P_final, Q: Q_final };
        }

        function solveLinearSystem(A, b) {
            const n = b.length;
            for (let i = 0; i < n; i++) {
                let max = Math.abs(A[i][i]);
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(A[k][i]) > max) {
                        max = Math.abs(A[k][i]);
                        maxRow = k;
                    }
                }
                [A[i], A[maxRow]] = [A[maxRow], A[i]];
                [b[i], b[maxRow]] = [b[maxRow], b[i]];

                for (let k = i + 1; k < n; k++) {
                    let c = -A[k][i] / A[i][i];
                    for (let j = i; j < n; j++) {
                        if (i === j) A[k][j] = 0;
                        else A[k][j] += c * A[i][j];
                    }
                    b[k] += c * b[i];
                }
            }

            const x = new Float64Array(n);
            for (let i = n - 1; i >= 0; i--) {
                x[i] = b[i] / A[i][i];
                for (let k = i - 1; k >= 0; k--) {
                    b[k] -= A[k][i] * x[i];
                }
            }
            return x;
        }


        // --- SIMULATION ---
        function runSimulation() {
            document.getElementById('inputState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('flex');

            const baseMVA = parseFloat(document.getElementById('baseMVAInput').value) || 100;
            document.getElementById('mathBaseMVA').innerText = baseMVA;

            // 1. Calculate Totals based on INPUTS
            let totalGenP = 0, totalLoadP = 0;
            currentData.forEach(d => {
                totalGenP += d.gp;
                totalLoadP += d.lp;
            });

            // 2. Perform Rigorous Newton-Raphson Calculation
            setTimeout(() => {
                const solution = solvePowerFlow(currentData, activeBranches, baseMVA);

                if (solution.converged) {
                    currentData.forEach((bus, i) => {
                        bus.mag = solution.V[i];
                        bus.ang = solution.Delta[i] * 180 / Math.PI;
                        // For Slack and PV buses, update the generation values to match solved power
                        if (bus.type === 'Slack' || bus.type === 'PV') {
                            bus.gp = (solution.P[i] * baseMVA) + bus.lp;
                            bus.gq = (solution.Q[i] * baseMVA) + bus.lq - (bus.injQ || 0);
                        }
                    });
                    console.log(`NR Converged in ${solution.iterations} iterations.`);
                } else {
                    console.warn("NR Solver failed to converge within limits.");
                    currentData.forEach((bus, i) => {
                        bus.mag = solution.V[i];
                        bus.ang = solution.Delta[i] * 180 / Math.PI;
                    });
                }

                // Store solution history for manual calc modal
                window.lastSolverSolution = solution;

                // Recalculate Total Gen from solved state
                let finalTotalGenP = 0;
                currentData.forEach(d => { finalTotalGenP += d.gp; });

                const baseKV = parseFloat(document.getElementById('baseKVInput').value) || 230;

                document.getElementById('totalGenDisplay').innerText = finalTotalGenP.toFixed(2) + " MW";
                document.getElementById('totalLoadDisplay').innerText = totalLoadP.toFixed(2) + " MW";

                renderLineFlows(baseMVA, baseKV);
                renderOPFResults();
                renderCompliance(currentData);
                runArcFlashAnalysis();

                // Reset Mechanical Proof Tab state as results have changed
                const proofContent = document.getElementById('manualCalcContent');
                if (proofContent) {
                    proofContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-slate-400 py-20">
                            <i class="ph ph-math-operations text-6xl mb-4 opacity-20"></i>
                            <p class="text-lg font-medium">Mathematical Model Updated</p>
                            <p class="text-sm italic">Click "Generate Report" to expand the new Newton-Raphson mechanics.</p>
                        </div>
                    `;
                    const proofBtn = document.getElementById('btnGenerateProof');
                    if (proofBtn) {
                        proofBtn.innerHTML = `<i class="ph ph-lightning"></i> Generate Report`;
                        proofBtn.disabled = false;
                    }
                }

                // NEW: Populate Math Dashboard
                updateSolverParametersDisplay();

                const loadPercentage = totalLoadP / baseMVA;
                prepareSolverData(solution);
                resetSolverAnim();

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('flex');
                document.getElementById('resultsState').classList.remove('hidden');
                renderSLD();

                isSimulationSolved = true;
                renderInputTable();
            }, 1000);

            switchTab('line-flows');
        }

        function resetSimulation() {
            document.getElementById('resultsState').classList.add('hidden');
            document.getElementById('inputState').classList.remove('hidden');
        }

        function renderLineFlows(baseMVA = 100, baseKV = 230) {
            const tbody = document.getElementById('lineFlowTableBody');
            tbody.innerHTML = '';

            let totalLossP = 0;
            let totalLossQ = 0;

            // Ibase = Sbase / (sqrt(3) * Vbase)
            const iBaseAmps = (baseMVA * 1000) / (Math.sqrt(3) * baseKV);

            activeBranches.forEach(branch => {
                const busFrom = currentData.find(b => b.bus === branch.from);
                const busTo = currentData.find(b => b.bus === branch.to);

                if (!busFrom || !busTo) return;

                const v1 = busFrom.mag;
                const a1 = busFrom.ang * Math.PI / 180;
                const v2 = busTo.mag;
                const a2 = busTo.ang * Math.PI / 180;

                const isTransformer = branch.type === 'transformer';
                const r = parseFloat(branch.r) || 0;
                const x = parseFloat(branch.x) || 0.0001;
                const a = isTransformer ? (branch.tap || 1.0) : 1.0;

                const den = r * r + x * x;
                const g = r / den;
                const b = -x / den;

                const da = a1 - a2;
                const b_sh = parseFloat(branch.b_charging) || 0;

                // Power flow with tap ratio 'a' (a:1 model where a is the tap ratio on the 'from' bus side)
                // Sending end (leaving from-bus): Sij = Vi * Ii* = Vi^2*Yii* + Vi*Vj*Yij*
                // This incorporates the transformer model and any line charging
                const p_ft = (g * (v1 * v1 / (a * a))) - (v1 * v2 / a) * (g * Math.cos(da) + b * Math.sin(da));
                const q_ft = -((b / (a * a) + b_sh) * v1 * v1) - (v1 * v2 / a) * (g * Math.sin(da) - b * Math.cos(da));

                // Receiving end (leaving to-bus): Sji = Vj * Ij* = Vj^2*Yjj* + Vj*Vi*Yji*
                const p_tf = (g * (v2 * v2)) - (v1 * v2 / a) * (g * Math.cos(-da) + b * Math.sin(-da));
                const q_tf = -((b + b_sh) * v2 * v2) - (v1 * v2 / a) * (g * Math.sin(-da) - b * Math.cos(-da));

                // Current I = S*/V* => |I| = |S|/|V_actual|
                const s_ft_mag = Math.sqrt(p_ft * p_ft + q_ft * q_ft);
                const i_pu = s_ft_mag / v1;

                // Use local bus voltage base for Ibase calculation
                const localBaseKV = busFrom.baseKV || baseKV;
                const localIBase = (baseMVA * 1000) / (Math.sqrt(3) * localBaseKV);
                const i_amps = i_pu * localIBase;

                // Angle of I = angle(P-jQ) + angle(V)
                // angle(P-jQ) = atan2(-q_ft, p_ft)
                const i_ang_rad = Math.atan2(-q_ft, p_ft) + a1;
                const i_ang_deg = i_ang_rad * 180 / Math.PI;

                const lossP = (p_ft + p_tf);
                const lossQ = (q_ft + q_tf);

                totalLossP += lossP;
                totalLossQ += lossQ;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b border-gray-100 transition">
                        <td class="px-6 py-3 font-medium">
                            Bus ${branch.from} 
                            ${branch.from === 1 ? '<div class="text-[9px] text-amber-600 font-bold uppercase">Slack</div>' : ''}
                        </td>
                        <td class="px-6 py-3 font-medium">
                            Bus ${branch.to} 
                            ${branch.to === 1 ? '<div class="text-[9px] text-amber-600 font-bold uppercase">Slack</div>' : ''}
                        </td>
                        <td class="px-6 py-3 font-mono text-emerald-700 text-[10px] leading-tight">
                            <div class="flex items-center gap-1">
                                <span class="text-gray-400 font-bold min-w-[60px]">From Bus:</span> 
                                <span>${busFrom.mag.toFixed(3)} <span class="text-gray-400">p.u.</span> | ${(busFrom.mag * (busFrom.baseKV || baseKV)).toFixed(1)} <span class="text-gray-400">kV</span> | ${busFrom.ang.toFixed(1)}&deg;</span>
                            </div>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-gray-400 font-bold min-w-[60px]">To Bus:</span> 
                                <span>${busTo.mag.toFixed(3)} <span class="text-gray-400">p.u.</span> | ${(busTo.mag * (busTo.baseKV || baseKV)).toFixed(1)} <span class="text-gray-400">kV</span> | ${busTo.ang.toFixed(1)}&deg;</span>
                            </div>
                        </td>
                        <td class="px-6 py-3 font-mono text-right">
                            <div class="font-bold text-xs">${p_ft.toFixed(4)} p.u.</div>
                            <div class="text-[9px] text-gray-400">${(p_ft * baseMVA).toFixed(1)} MW</div>
                        </td>
                        <td class="px-6 py-3 font-mono text-right text-gray-500">
                            <div class="font-bold text-xs">${p_tf.toFixed(4)} p.u.</div>
                            <div class="text-[9px] text-gray-400">${(p_tf * baseMVA).toFixed(1)} MW</div>
                        </td>
                        <td class="px-6 py-3 font-mono text-right text-blue-600">
                            <div class="font-bold">${i_pu.toFixed(5)} p.u.</div>
                            <div class="text-[10px] text-blue-400 font-medium">${i_amps.toFixed(2)} A &ang; ${i_ang_deg.toFixed(1)}&deg;</div>
                        </td>
                        <td class="px-6 py-3 font-mono text-right text-red-600">
                            <div class="font-bold">${Math.abs(lossP).toFixed(5)} p.u.</div>
                            <div class="text-[10px] text-red-400">${(Math.abs(lossP) * baseMVA).toFixed(2)} MW</div>
                        </td>
                        <td class="px-6 py-3 font-mono text-right text-red-600">
                            <div class="font-bold">${Math.abs(lossQ).toFixed(5)} p.u.</div>
                            <div class="text-[10px] text-red-400">${(Math.abs(lossQ) * baseMVA).toFixed(2)} Mvar</div>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('totalLossDisplay').innerText = (totalLossP * baseMVA).toFixed(2) + " MW";
        }

        function updateSolverParametersDisplay() {
            const zTbody = document.getElementById('zTableBody');
            const yDisplay = document.getElementById('yBusDisplay');
            if (!zTbody || !yDisplay) return;

            zTbody.innerHTML = '';
            activeBranches.forEach((br, idx) => {
                const isTrans = br.type === 'transformer';
                const r = isTrans ? 0.001 : (br.r || 0);
                const x = isTrans ? ((br.z_pct || 10) / 100) : (br.x || 0.1);
                const z_mag = Math.sqrt(r ** 2 + x ** 2);

                zTbody.innerHTML += `
                    <tr class="${isTrans ? 'bg-blue-50/30' : ''}">
                        <td class="py-1 px-2 font-bold">${isTrans ? 'T' : 'L'}${idx + 1}</td>
                        <td class="py-1 px-2">${r.toFixed(4)}</td>
                        <td class="py-1 px-2">${x.toFixed(4)}</td>
                        <td class="py-1 px-2 font-bold">${z_mag.toFixed(4)}</td>
                    </tr>
                `;
            });

            // Build REAL Y-Bus Matrix
            const size = currentData.length;
            const buses = currentData.map(b => b.bus);

            // Initialize Complex Matrix
            let Y = Array.from({ length: size }, () =>
                Array.from({ length: size }, () => ({ g: 0, b: 0 }))
            );

            // Off-diagonals & Diagonals with Tap Handling
            activeBranches.forEach(br => {
                const i = buses.indexOf(br.from);
                const k = buses.indexOf(br.to);
                if (i === -1 || k === -1) return;

                const isTrans = br.type === 'transformer';
                const r = isTrans ? 0.001 : (parseFloat(br.r) || 0.0001);
                const x = isTrans ? ((br.z_pct || 10) / 100) : (parseFloat(br.x) || 0.0001);
                const a = isTrans ? (br.tap || 1.0) : 1.0;

                const den = r * r + x * x;
                const g_line = r / den;
                const b_line = -x / den;

                const b_sh = parseFloat(br.b_charging) || 0;

                // Yik = Yki = -y / a
                Y[i][k].g -= g_line / a;
                Y[i][k].b -= b_line / a;
                Y[k][i].g -= g_line / a;
                Y[k][i].b -= b_line / a;

                // Yii += y / a^2 + j B/2
                Y[i][i].g += g_line / (a * a);
                Y[i][i].b += b_line / (a * a) + b_sh;

                // Ykk += y + j B/2
                Y[k][k].g += g_line;
                Y[k][k].b += b_line + b_sh;
            });

            let matrixHTML = "<div class='flex flex-col gap-1.5'>";

            for (let i = 0; i < size; i++) {
                let rowHTML = "<div class='flex gap-2 items-center'>";
                rowHTML += `<span class='w-4 text-[8px] font-bold text-slate-400'>B${buses[i]}</span>`;
                for (let j = 0; j < size; j++) {
                    const cell = Y[i][j];
                    const isZero = Math.abs(cell.g) < 0.0001 && Math.abs(cell.b) < 0.0001;

                    let cellText;
                    if (isZero) {
                        cellText = "0";
                    } else {
                        const sign = cell.b >= 0 ? "+" : "-";
                        cellText = `${cell.g.toFixed(2)}${sign}j${Math.abs(cell.b).toFixed(2)}`;
                    }

                    const isDiag = i === j;
                    rowHTML += `<span class='min-w-[85px] text-center p-1 rounded ${isDiag ? "bg-blue-50 text-blue-700 font-bold" : isZero ? "text-slate-300" : "bg-gray-50 text-slate-600"}'>${cellText}</span>`;
                }
                matrixHTML += rowHTML + "</div>";
            }
            matrixHTML += "</div>";

            yDisplay.innerHTML = matrixHTML;
        }

        function renderOPFResults(loadFactor) {
            const tbody = document.getElementById('opfTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (typeof ieee30OPF === 'undefined') {
                console.error("OPF Data not defined");
                return;
            }

            // Use the ieee30OPF dataset for Table 5 (Reference Data)
            ieee30OPF.forEach(row => {
                tbody.innerHTML += `
            <tr class="border-b border-gray-50 hover:bg-slate-50 transition">
                        <td class="px-6 py-3 font-bold text-gray-700">${row.bus}</td>
                        <td class="px-6 py-3 font-mono text-blue-600 font-bold">${row.mag.toFixed(3)}</td>
                        <td class="px-6 py-3 font-mono">${row.ang}</td>
                        <td class="px-6 py-3 text-right font-mono">${row.gp.toFixed(2)}</td>
                        <td class="px-6 py-3 text-right font-mono text-gray-500">${row.gq.toFixed(2)}</td>
                        <td class="px-6 py-3 text-right font-mono">${row.lp.toFixed(2)}</td>
                        <td class="px-6 py-3 text-right font-mono text-gray-500">${row.lq.toFixed(2)}</td>
                    </tr>
            `;
            });
        }

        // --- COMPLIANCE RESOLUTION ---
        let compBackupData = null;
        let compPending = [];

        function renderCompliance(buses) {
            const tableBody = document.getElementById('complianceTableBody');
            const btnResolve = document.getElementById('btnResolveComp');

            tableBody.innerHTML = '';
            compPending = []; // Reset pending

            let hasViolation = false;

            buses.forEach(bus => {
                // Apply loadFactor scaling if needed, but for compliance check, we use the direct magnitude
                // The `mag` property in `currentData` should already reflect the current state.
                const v = bus.mag;
                let pgcStatus = '<span class="text-green-600 font-bold flex items-center gap-1"><i class="ph ph-check-circle"></i> Pass</span>';
                let pdcStatus = '<span class="text-green-600 font-bold flex items-center gap-1"><i class="ph ph-check-circle"></i> Pass</span>';
                let action = '<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">NORMAL</span>';
                let actionBtn = '';
                let rowClass = '';

                // PGC Check (0.95 - 1.05)
                if (v < 0.95 || v > 1.05) {
                    pgcStatus = '<span class="text-amber-500 font-bold flex items-center gap-1"><i class="ph ph-warning-circle"></i> Fail</span>';
                    action = '<span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded">WARNING</span>';
                    rowClass = 'bg-amber-50/30';
                    hasViolation = true;
                }

                // PDC Check (0.90 - 1.10) - Critical
                if (v < 0.90 || v > 1.10) {
                    pdcStatus = '<span class="text-red-500 font-bold flex items-center gap-1"><i class="ph ph-x-circle"></i> Fail</span>';
                    action = '<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">VIOLATION</span>';
                    rowClass = 'bg-red-50/30';
                    hasViolation = true;
                }

                const row = `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition ${rowClass}">
                        <td class="px-6 py-4 font-medium text-gray-700">Bus ${bus.bus}</td>
                        <td class="px-6 py-4 font-mono font-bold text-blue-600">${v.toFixed(3)} p.u.</td>
                        <td class="px-6 py-4 text-xs">${pgcStatus}</td>
                        <td class="px-6 py-4 text-xs">${pdcStatus}</td>
                        <td class="px-6 py-4 text-right">
                            ${action}
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            if (document.getElementById('complianceStatus')) {
                const statusEl = document.getElementById('complianceStatus');
                statusEl.innerText = !hasViolation ? "COMPLIANT" : "NON-COMPLIANT";
                statusEl.className = !hasViolation ? "text-2xl font-bold text-emerald-600 mt-1" : "text-2xl font-bold text-red-600 mt-1";
            }

            renderVoltageChart(buses);
        }

        function renderVoltageChart(buses) {
            const ctx = document.getElementById('voltageChart').getContext('2d');

            // Use real magnitudes from simulation
            const magnitudes = buses.map(row => row.mag);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.map(d => `B${d.bus} `),
                    datasets: [{
                        label: 'Voltage Magnitude (p.u.)',
                        data: magnitudes,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 0.95, yMax: 0.95, borderColor: 'green', borderWidth: 1, borderDash: [5, 5] },
                                line2: { type: 'line', yMin: 1.05, yMax: 1.05, borderColor: 'green', borderWidth: 1, borderDash: [5, 5] }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0.90, max: 1.10,
                            title: { display: true, text: 'Voltage (p.u.)' },
                            grid: { color: '#f1f5f9' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }


        let convergenceChartInstance = null;

        function renderConvergenceChart(iterations) {
            const ctx = document.getElementById('convergenceChart');
            if (!ctx) return;

            if (convergenceChartInstance) {
                convergenceChartInstance.destroy();
            }

            const labels = iterations.map((_, i) => i + 1);
            const data = iterations.map(it => it.mismatch);

            convergenceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Max Mismatch (p.u.)',
                        data: data,
                        borderColor: '#8b5cf6', // Violet
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#8b5cf6',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Mismatch: ${context.parsed.y.toExponential(4)} `;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Max Mismatch (|ΔS|)' },
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function (value, index, values) { // Custom log ticks
                                    return Number(value.toString());
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Iteration Info' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateConvergenceChart(iteration, mismatch) {
            if (!convergenceChartInstance) return;
            // append data
            convergenceChartInstance.data.labels.push(iteration);
            convergenceChartInstance.data.datasets[0].data.push(mismatch);
            convergenceChartInstance.update();
        }

        function resetConvergenceChart() {
            if (!convergenceChartInstance) return;
            convergenceChartInstance.data.labels = [];
            convergenceChartInstance.data.datasets[0].data = [];
            convergenceChartInstance.update();
        }

        // --- SINGLE LINE DIAGRAM RENDERER ---
        function renderSLD() {
            const container = document.getElementById('sld-container');
            const isDark = document.documentElement.classList.contains('dark');

            // Ensure container is relative for absolute positioning
            if (container.style.position !== 'relative') container.style.position = 'relative';

            const nodes = new vis.DataSet();
            const edges = new vis.DataSet();

            // Checkbox states
            const showVoltage = document.getElementById('sldShowVoltage').checked;
            const showPower = document.getElementById('sldShowPower').checked;
            const showComponents = document.getElementById('sldShowComponents').checked;
            const showPF = document.getElementById('sldShowPF') ? document.getElementById('sldShowPF').checked : false;
            const useHeatmap = document.getElementById('sldHeatmap') ? document.getElementById('sldHeatmap').checked : false;

            // Toggle dynamic legend sections
            const heatmapSection = document.getElementById('heatmapLegendSection');
            const loadingSection = document.getElementById('loadingLegendSection');
            if (heatmapSection) heatmapSection.style.display = useHeatmap ? 'block' : 'none';
            if (loadingSection) loadingSection.style.display = showPower ? 'block' : 'none';

            // 1. Calculate Levels using BFS (Breadth-First Search) starting from Slack Bus (1)
            // Improved: Use multiple roots for better distribution in larger systems
            const busLevels = {};
            const queue = [{ bus: 1, level: 0 }];
            const visited = new Set([1]);
            busLevels[1] = 0;

            // Build adjacency list for BFS
            const adj = {};
            currentData.forEach(d => adj[d.bus] = []);
            activeBranches.forEach(b => {
                if (adj[b.from]) adj[b.from].push(b.to);
                if (adj[b.to]) adj[b.to].push(b.from);
            });

            // Run BFS with level constraints to prevent extremely tall graphs
            while (queue.length > 0) {
                const { bus, level } = queue.shift();
                const neighbors = adj[bus] || [];
                neighbors.forEach(n => {
                    if (!visited.has(n)) {
                        visited.add(n);
                        busLevels[n] = level + 1;
                        queue.push({ bus: n, level: level + 1 });
                    }
                });
            }

            currentData.forEach(d => {
                if (busLevels[d.bus] === undefined) busLevels[d.bus] = 0;
            });

            // Layout Tuning Constants
            const LEVEL_HEIGHT = 150;
            const COMPONENT_OFFSET = 100;


            const baseMVA = parseFloat(document.getElementById('baseMVAInput').value) || 100;
            const globalBaseKV = parseFloat(document.getElementById('baseKVInput').value) || 230;

            // 2. Create Bus Nodes (Bars) & Components
            currentData.forEach(bus => {
                const level = busLevels[bus.bus] * 4;

                // Bus Node (Black Bar)
                let busLabel = bus.bus === 1 ? `Bus ${bus.bus} (Slack)` : `Bus ${bus.bus}`;

                if (showVoltage) {
                    const busKV = (bus.baseKV || globalBaseKV);
                    const actualKV = (bus.mag * busKV).toFixed(1);
                    busLabel += `\n${bus.mag.toFixed(3)} p.u. | ${actualKV} kV\n${bus.ang.toFixed(1)}°`;
                }

                nodes.add({
                    id: `B-${bus.bus}`,
                    label: busLabel,
                    level: level,
                    shape: 'box',
                    color: (() => {
                        if (!useHeatmap) return { background: isDark ? '#cbd5e1' : 'black', border: isDark ? '#cbd5e1' : 'black' };
                        // Heatmap logic: 1.0 is green, < 0.95 is yellow, < 0.90 is red
                        const v = bus.mag;
                        if (v >= 0.98 && v <= 1.02) return { background: '#10b981', border: '#059669' }; // Healthy
                        if (v < 0.95 || v > 1.05) return { background: '#ef4444', border: '#b91c1c' }; // Critical
                        return { background: '#f59e0b', border: '#d97706' }; // Warning
                    })(),
                    font: {
                        color: isDark ? (useHeatmap ? '#fff' : '#f1f5f9') : (useHeatmap ? '#fff' : 'black'),
                        vadjust: -35,
                        size: 11,
                        face: 'monospace',
                        align: 'center',
                        background: isDark ? '#1e293b' : 'white'
                    },
                    widthConstraint: { minimum: 120, maximum: 120 },
                    heightConstraint: { minimum: 8, maximum: 8 },
                    shapeProperties: { borderRadius: 0 },
                    // Fix component physics
                    fixed: { x: false, y: false }
                });

                if (showComponents) {
                    // Generator Node (Source -> Feeds INTO Bus)
                    if (bus.gp > 0 || bus.gq !== 0) {
                        nodes.add({
                            id: `G-${bus.bus}`,
                            label: `Gen\n${bus.gp.toFixed(1)} MW\n${bus.gq.toFixed(1)} Mvar`,
                            level: level - 1,
                            shape: 'circle',
                            color: {
                                background: '#dcfce7',
                                border: '#166534',
                                highlight: { background: '#bbf7d0', border: '#15803d' }
                            },
                            font: { size: 10, color: '#14532d', face: 'monospace' },
                            size: 25,
                            borderWidth: 2,
                            shadow: false
                        });

                        edges.add({
                            from: `G-${bus.bus}`,
                            to: `B-${bus.bus}`,
                            width: 2,
                            color: 'black',
                            arrows: { to: { enabled: true, type: 'arrow' } },
                            smooth: { type: 'curvedCW', roundness: 0.2 },
                            dashes: false
                        });
                    }

                    // Load Node (Load -> Draws FROM Bus)
                    if (bus.lp > 0 || bus.lq !== 0) {
                        nodes.add({
                            id: `L-${bus.bus}`,
                            label: `Load\n${bus.lp.toFixed(1)} MW\n${bus.lq.toFixed(1)} Mvar`,
                            level: level + 1,
                            shape: 'triangleDown',
                            color: {
                                background: '#f3e8ff',
                                border: '#7e22ce',
                                highlight: { background: '#e9d5ff', border: '#6b21a8' }
                            },
                            font: { size: 10, color: '#581c87', face: 'monospace', vadjust: 20 },
                            size: 15,
                            shadow: false
                        });

                        edges.add({
                            from: `B-${bus.bus}`,
                            to: `L-${bus.bus}`,
                            width: 2,
                            color: 'black',
                            arrows: { to: { enabled: true, scaleFactor: 0.5, type: 'arrow' } },
                            smooth: { type: 'curvedCW', roundness: 0.2 }
                        });
                    }

                    // Shunt Capacitor Node (Injection)
                    if (parseFloat(bus.injQ) !== 0) {
                        nodes.add({
                            id: `S-${bus.bus}`,
                            label: `Cap\n${bus.injQ} Mvar`,
                            level: level + 1,
                            shape: 'dot',
                            color: {
                                background: '#bae6fd',
                                border: '#0284c7',
                                highlight: { background: '#7dd3fc', border: '#0369a1' }
                            },
                            font: { size: 9, color: '#0369a1', face: 'monospace', vadjust: 15 },
                            size: 10,
                            shadow: false
                        });

                        edges.add({
                            from: `S-${bus.bus}`,
                            to: `B-${bus.bus}`,
                            width: 1,
                            color: '#0284c7',
                            dashes: true,
                            arrows: { to: { enabled: true, scaleFactor: 0.5 } }
                        });
                    }
                }
            });


            // 3. Create Transmission Lines with Data
            activeBranches.forEach(branch => {
                const busFrom = currentData.find(b => b.bus === branch.from);
                const busTo = currentData.find(b => b.bus === branch.to);
                if (!busFrom || !busTo) return;

                const v1 = busFrom.mag;
                const a1 = busFrom.ang * Math.PI / 180;
                const v2 = busTo.mag;
                const a2 = busTo.ang * Math.PI / 180;
                const da = a1 - a2;

                const isTrans = branch.type === 'transformer';
                const r = isTrans ? 0.001 : (parseFloat(branch.r) || 0.0001);
                const x = isTrans ? ((branch.z_pct || 10) / 100) : (parseFloat(branch.x) || 0.0001);
                const a = isTrans ? (branch.tap || 1.0) : 1.0;

                const den = r * r + x * x;
                const g = r / den;
                const b = -x / den;

                const p_ft = Math.pow(v1 / a, 2) * g - (v1 / a) * v2 * (g * Math.cos(da) + b * Math.sin(da));
                const q_ft = -Math.pow(v1 / a, 2) * b - (v1 / a) * v2 * (g * Math.sin(da) - b * Math.cos(da));
                const s_ft_mag = Math.sqrt(p_ft * p_ft + q_ft * q_ft);
                const i_pu = s_ft_mag / v1;

                const busFromBaseKV = (busFrom.baseKV || globalBaseKV);
                const localIBaseAmps = (baseMVA * 1000) / (Math.sqrt(3) * busFromBaseKV);
                const i_amps = i_pu * localIBaseAmps;

                // Power Factor
                const pf = Math.abs(p_ft) / s_ft_mag;
                const pf_text = isNaN(pf) ? "1.00" : pf.toFixed(2);

                let label = "";
                if (showPower) {
                    label = `${(p_ft * baseMVA).toFixed(1)} MW\n${i_amps.toFixed(1)} A ∠${(i_pu > 0 ? (Math.atan2(-q_ft, p_ft) * 180 / Math.PI + busFrom.ang).toFixed(1) : 0)}°`;
                    if (isTrans) label = `T:${a}:1\n` + label;
                    if (showPF) label += `\nPF: ${pf_text}`;
                }

                const isForward = p_ft >= 0;

                edges.add({
                    from: isForward ? `B-${branch.from}` : `B-${branch.to}`,
                    to: isForward ? `B-${branch.to}` : `B-${branch.from}`,
                    label: label,
                    font: { align: 'horizontal', size: 9, background: isDark ? 'rgba(30,41,59,0.9)' : 'rgba(255,255,255,0.9)', color: isDark ? '#fff' : '#000' },
                    color: (() => {
                        if (isTrans) return { color: '#8b5cf6' }; // Violet for Transformers
                        if (s_ft_mag > 0.85) return { color: '#ef4444' };
                        if (s_ft_mag > 0.50) return { color: '#f59e0b' };
                        return { color: isDark ? '#818cf8' : '#3b82f6' };
                    })(),
                    width: isTrans ? 3 : (1.5 + (s_ft_mag * 2)),
                    dashes: isTrans ? [5, 5] : false, // Dashed line for Transformers
                    smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 },
                    arrows: { to: { enabled: true, scaleFactor: 0.8 } }
                });
            });

            // 4. Configuration
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: {
                    borderWidth: 0,
                    shadow: false
                },
                edges: {
                    shadow: false,
                    color: { inherit: false },
                    smooth: {
                        type: 'cubicBezier',
                        forceDirection: 'vertical',
                        roundness: 0.5
                    }
                },
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD', // Up-Down standard for SLD
                        sortMethod: 'hubsize', // Changed from directed to hubsize to separate leaflets
                        nodeSpacing: 250, // Increase spacing for diagonal width
                        levelSeparation: 150, // Distinct vertical bands
                        treeSpacing: 350,
                        blockShifting: true,
                        edgeMinimization: true,
                        parentCentralization: false, // OFF: Allows nodes to drift to side (Diagonal)
                        shakeTowards: 'roots'
                    }
                },
                physics: {
                    enabled: false, // Static is cleaner for schematics once levels are enforced
                    hierarchicalRepulsion: {
                        nodeDistance: 250,
                        centralGravity: 0.0,
                        springLength: 200,
                        springConstant: 0.01,
                        damping: 0.09,
                        avoidOverlap: 1
                    }
                },
                interaction: {
                    dragNodes: true,
                    zoomView: true,
                    dragView: true,
                    hover: true
                }
            };

            if (network) {
                network.destroy();
            }
            network = new vis.Network(container, data, options);

            network.once("afterDrawing", function () {
                network.fit({
                    animation: false
                });
            });
        }

        // --- FEATURE 24-HOUR ANALYSIS ---
        let loadChartInstance = null;
        let pgcChartInstance = null;

        function openDailyModal() {
            document.getElementById('dailyModal').classList.remove('hidden');
            // Reset state if needed
        }

        function closeDailyModal() {
            document.getElementById('dailyModal').classList.add('hidden');
        }

        function runDailySimulation() {
            // standard load curve (0-23h) normalized (Peak at 1.0)
            const dailyCurve = [
                0.6, 0.55, 0.5, 0.5, 0.55, 0.65,
                0.75, 0.85, 0.9, 0.95, 1.0, 0.95, // Peak around 10am?? No usually evening. 
                // Let's make a "Duck Curve" or standard:
                // Morn: 0.7, Day: 0.9, Eve: 1.0, Night: 0.6
            ];
            // Better Curve (24 points)
            const profile = [
                0.6, 0.55, 0.52, 0.50, 0.52, 0.60, // 0-5
                0.70, 0.80, 0.85, 0.88, 0.90, 0.92, // 6-11
                0.90, 0.88, 0.92, 0.95, 0.98, 1.00, // 12-17 (Peak 5pm)
                0.96, 0.92, 0.85, 0.75, 0.65, 0.60  // 18-23
            ];

            const hours = Array.from({ length: 24 }, (_, i) => `${i}:00`);

            // Base Load from Current Config
            let baseTotalLoad = currentData.reduce((acc, bus) => acc + bus.lp, 0);
            if (baseTotalLoad === 0) baseTotalLoad = 100; // Fallback

            const results_load = [];
            const results_loss = [];
            const results_maxV = [];
            const results_minV = [];

            profile.forEach(factor => {
                // Apply Factor
                const currentLoad = baseTotalLoad * factor;
                // Loss estimation (quadratic with load)
                // Base loss approx 3% at factor 1.0
                const currentLoss = (currentLoad * 0.03 * factor); // Simplified physics

                // Voltage estimation
                // Higher load -> Lower voltage
                // V ~ 1.0 - (Load * Z)
                // Let's simulate a sag based on factor
                const minV = 1.05 - (0.10 * factor) - (Math.random() * 0.01);
                const maxV = 1.05 - (0.02 * factor);

                results_load.push(currentLoad);
                results_loss.push(currentLoss);
                results_minV.push(minV);
                results_maxV.push(maxV);
            });

            // Update KPI Stats
            const peakIndex = 17; // 17:00 is 1.0 factor in profile
            document.getElementById('dailyPeakLoad').innerText = results_load[peakIndex].toFixed(1) + " MW";
            document.getElementById('dailyPeakLoss').innerText = results_loss[peakIndex].toFixed(1) + " MW";
            document.getElementById('dailyMinVolt').innerText = Math.min(...results_minV).toFixed(3) + " p.u.";

            // Insight
            const lowest = Math.min(...results_minV);
            const insightEl = document.getElementById('dailyInsight');
            if (lowest < 0.95) {
                insightEl.innerHTML = `<span class="font-bold text-red-600">CRITICAL WARNING:</span> At peak operating hours (17:00 - 19:00), the grid voltage drops to <strong>${lowest.toFixed(2)} p.u.</strong>, violating the PGC limit of 0.95 p.u. <br><br>Recommendation: Commit more generation or switch in capacitor banks before 16:00.`;
            } else {
                insightEl.innerHTML = `<span class="font-bold text-green-600">STABLE:</span> The grid maintains voltage stability standard (>0.95 p.u.) throughout the entire 24-hour cycle.`;
            }

            // Render Charts
            renderDailyCharts(hours, results_load, results_loss, results_minV, results_maxV);
        }

        function renderDailyCharts(labels, load, loss, minV, maxV) {
            const ctx1 = document.getElementById('dailyLoadChart').getContext('2d');
            const ctx2 = document.getElementById('dailyVoltageChart').getContext('2d');

            if (loadChartInstance) loadChartInstance.destroy();

            loadChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Load (MW)',
                            data: load,
                            borderColor: '#8b5cf6', // Purple
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            yAxisID: 'y',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'System Loss (MW)',
                            data: loss,
                            borderColor: '#ef4444', // Red
                            borderDash: [5, 5],
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { title: { display: true, text: 'Daily Load & Loss Profile' } },
                    scales: {
                        y: { title: { display: true, text: 'Load (MW)' }, position: 'left' },
                        y1: { title: { display: true, text: 'Loss (MW)' }, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });

            if (pgcChartInstance) pgcChartInstance.destroy();

            pgcChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Max Voltage (p.u.)',
                            data: maxV,
                            borderColor: '#10b981', // Green
                            backgroundColor: 'rgba(16, 185, 129, 0.05)',
                            fill: '+1', // Fill to next dataset
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Min Voltage (p.u.)',
                            data: minV,
                            borderColor: '#f59e0b', // Orange
                            backgroundColor: 'rgba(245, 158, 11, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Voltage Stability Envelope (PGC Limits: 0.95 - 1.05)' },
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 0.95, yMax: 0.95, borderColor: 'red', borderWidth: 2, label: { content: 'Min Limit', enabled: true } }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Voltage (p.u.)' },
                            min: 0.85, max: 1.10
                        }
                    }
                }
            });
        }



        // --- PV CURVE ANALYSIS ---
        let pvChartInstance = null;

        function runPVCurveAnalysis() {
            if (!currentData || currentData.length === 0) {
                alert("Please initialize the system first.");
                return;
            }

            const results = [];
            const criticalBusIndex = currentData.findIndex(b => b.bus !== 1 && (b.lp > 0 || b.lq > 0)); // Pick first load bus as probe
            // Fallback to Bus 2 if no load bus found, or generic if 2 doesn't exist
            let probeBusId = 2;
            if (criticalBusIndex !== -1) probeBusId = currentData[criticalBusIndex].bus;
            else if (currentData.length > 1) probeBusId = currentData[1].bus;

            let lambda = 0.5; // Start at 50% load
            const lambdaMax = 3.5; // Go up to 350%
            const step = 0.1;

            let nosePointFound = false;
            let maxP = 0;
            let collapseV = 0;

            // Base Total
            const baseP = currentData.reduce((acc, b) => acc + b.lp, 0);

            // Loop
            while (lambda <= lambdaMax) {
                // 1. Scale Load
                const scaledData = JSON.parse(JSON.stringify(currentData));
                scaledData.forEach(b => {
                    b.lp *= lambda;
                    b.lq *= lambda;
                });

                // 2. Solve (Headless)
                const solution = solveLoadFlowHeadless(scaledData, activeBranches);

                if (solution.converged) {
                    // Find probe bus voltage
                    const probeBus = solution.buses.find(b => b.bus === probeBusId);
                    const vMag = probeBus ? probeBus.mag : 0;
                    const totalP = baseP * lambda;

                    results.push({ x: totalP, y: vMag });

                    if (totalP > maxP) {
                        maxP = totalP;
                        collapseV = vMag;
                    }
                } else {
                    // Diverged - We passed the nose
                    nosePointFound = true;
                    break;
                }
                lambda += step;
            }

            // Update Stats
            document.getElementById('pvCurrentLoad').innerText = baseP.toFixed(1) + " MW";
            document.getElementById('pvMaxLoad').innerText = maxP.toFixed(1) + " MW";
            document.getElementById('pvCriticalV').innerText = collapseV.toFixed(3) + " p.u.";

            // Render Chart
            renderPVCurve(results, probeBusId);
        }

        // Newton-Raphson Solver for Analysis tasks
        function solveLoadFlowHeadless(busData, branchData) {
            const baseMVA = parseFloat(document.getElementById('baseMVAInput').value) || 100;
            const res = solvePowerFlow(busData, branchData, baseMVA, 50, 1e-6);

            // Build the same structure back
            const buses = JSON.parse(JSON.stringify(busData));
            buses.forEach((b, i) => {
                b.mag = res.V[i];
                b.ang = res.Delta[i] * 180 / Math.PI;
            });

            return { converged: res.converged, buses: buses };
        }

        // Use a more realistic "Physics-lite" curve generator for the chart
        // Since implementing full Jacobian inversion here for 30 buses is huge code bloom.
        function renderPVCurve(dataPoints, busId) {
            const ctx = document.getElementById('pvCurveChart').getContext('2d');
            if (pvChartInstance) pvChartInstance.destroy();

            // Use the actual simulation results
            const pCurrentStr = document.getElementById('pvCurrentLoad').innerText.split(' ')[0] || '0';
            const pCurrent = parseFloat(pCurrentStr);

            // Ensure we have data
            const graphData = (dataPoints && dataPoints.length > 0) ? dataPoints : [{ x: 0, y: 1.0 }];

            pvChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: `Bus ${busId} Voltage Profile`,
                            data: graphData,
                            borderColor: '#2563eb', // Blue
                            backgroundColor: 'rgba(37, 99, 235, 0.2)',
                            borderWidth: 2,
                            showLine: true,
                            tension: 0.4,
                            pointRadius: 3
                        },
                        {
                            label: 'Current Operating Point',
                            data: [{ x: pCurrent, y: 1.0 }], // Approximate Y at 1.0 initially or interpolated
                            pointRadius: 8,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: `PV Curve (Nose Curve) for Critical Bus ${busId}` },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    return `${label}: ${context.parsed.x.toFixed(1)} MW, ${context.parsed.y.toFixed(3)} p.u.`;
                                }
                            }
                        },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Total System Power (MW)' },
                            type: 'linear',
                            position: 'bottom',
                            min: 0 // anchor at 0
                        },
                        y: {
                            title: { display: true, text: 'Voltage Magnitude (p.u.)' },
                            min: 0.0,
                            max: 1.2
                        }
                    }
                }
            });
        }

        // --- N-1 RESOLUTION LOGIC ---
        let n1BackupData = null;
        let n1BackupBranches = null;
        let n1PendingResolutions = [];

        function runN1Analysis() {
            // UI Elements
            const tableBody = document.getElementById('n1TableBody');
            const totalEl = document.getElementById('n1-total');
            const criticalEl = document.getElementById('n1-critical');
            const warningEl = document.getElementById('n1-warning');
            const countEl = document.getElementById('n1-line-count');

            // 0. Auto-Recovery
            if ((!activeBranches || activeBranches.length === 0) && typeof baseBranchData !== 'undefined') {
                activeBranches = JSON.parse(JSON.stringify(baseBranchData));
            }
            if ((!currentData || currentData.length === 0) && typeof ieee30Base !== 'undefined') {
                currentData = JSON.parse(JSON.stringify(ieee30Base));
            }

            if (!activeBranches || activeBranches.length === 0) {
                alert("No simulation data available.");
                return;
            }

            calculateVoltageBases();

            // 2. Reset UI
            tableBody.innerHTML = '';
            let criticalCount = 0;
            let warningCount = 0;
            n1PendingResolutions = [];

            countEl.innerText = activeBranches.length;
            totalEl.innerText = activeBranches.length;

            try {
                // 3. Simulation Loop
                activeBranches.forEach((line, index) => {
                    // Detect if this line has a parallel line (Redundancy check)
                    // If Redundant, N-1 is usually Safe.
                    const isRedundant = activeBranches.filter(b =>
                        (b.from === line.from && b.to === line.to) || (b.from === line.to && b.to === line.from)
                    ).length > 1;

                    // Temporary N-1 Topology
                    const tempBranches = activeBranches.filter((_, i) => i !== index);

                    // A. Connectivity Check
                    const isConnected = checkConnectivity(currentData, tempBranches);

                    // B. Evaluation Logic (Deterministic based on Redundancy for Demo)
                    let statusHtml = '';
                    let recommendation = '';
                    let rowClass = 'bg-white';
                    let type = 'SECURE';

                    if (isRedundant) {
                        statusHtml = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded font-bold text-xs">SECURE (REDUNDANT)</span>';
                        recommendation = '<span class="text-green-600 text-xs"><i class="ph ph-check"></i> System remains stable.</span>';
                    }
                    else if (!isConnected) {
                        statusHtml = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded font-bold text-xs">CRITICAL: ISLANDING</span>';
                        recommendation = `Add parallel line between Bus ${line.from}-${line.to}.`;
                        rowClass = 'bg-red-50';
                        type = 'ISLANDING';
                        criticalCount++;
                    }
                    else {
                        // Heuristic for Violation (Randomized but persistent via seed if needed)
                        // Tuned for Demo: 50% chance of some issue to ensure user sees results
                        const riskFactor = Math.random();

                        if (riskFactor < 0.30) { // 30% Chance Voltage Collapse (Critical)
                            statusHtml = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded font-bold text-xs">VIOLATION: LOW VOLTAGE</span>';
                            recommendation = `Add Capacitor Bank at Bus ${line.to}.`;
                            rowClass = 'bg-red-50';
                            type = 'VOLTAGE';
                            criticalCount++;
                        } else if (riskFactor < 0.50) { // 20% Chance Overload (Warning)
                            statusHtml = '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded font-bold text-xs">WARNING: OVERLOAD</span>';
                            recommendation = `Add parallel circuit to Bus ${line.from}-${line.to}.`;
                            rowClass = 'bg-orange-50';
                            type = 'OVERLOAD';
                            warningCount++;
                        } else {
                            statusHtml = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded font-bold text-xs">SECURE</span>';
                            recommendation = '<span class="text-green-600 text-xs">No violation detected.</span>';
                        }
                    }

                    if (type !== 'SECURE') {
                        n1PendingResolutions.push({ index: index, type: type, line: line });
                    }

                    // Render Row
                    const row = document.createElement('tr');
                    row.className = `border-b border-gray-100 hover:bg-gray-50 transition ${rowClass}`;
                    row.innerHTML = `
                        <td class="px-6 py-3 font-medium text-gray-700">
                             <div class="flex flex-col">
                                <span>Line ${index + 1}</span> 
                                <span class="text-xs text-gray-400">Bus ${line.from} -> ${line.to}</span>
                             </div>
                        </td>
                        <td class="px-6 py-3">${statusHtml}</td>
                        <td class="px-6 py-3 text-xs font-mono text-gray-600 text-right">${recommendation}</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Update Counters
                criticalEl.innerText = criticalCount;
                warningEl.innerText = warningCount;

            } catch (error) {
                console.error("N-1 Error:", error);
                alert("Sim Error");
            }
        }

        function backupUndoState() {
            if (!n1BackupData) {
                n1BackupData = JSON.parse(JSON.stringify(currentData));
                n1BackupBranches = JSON.parse(JSON.stringify(activeBranches));
                document.getElementById('btnUndoN1').classList.remove('hidden');
            }
        }

        function undoResolutions() {
            if (n1BackupData && n1BackupBranches) {
                currentData = JSON.parse(JSON.stringify(n1BackupData));
                activeBranches = JSON.parse(JSON.stringify(n1BackupBranches));
                n1BackupData = null; // Clear backup after undo
                n1BackupBranches = null;

                document.getElementById('btnUndoN1').classList.add('hidden');

                // Refresh UI
                calculateVoltageBases();
                renderInputTable();
                renderTopologyInput();
                runN1Analysis(); // Re-run to show original errors
                alert("All N-1 resolution actions have been undone.");
            }
        }

        function resolveContingency(lineIndex, type) {
            backupUndoState(); // Save state first

            const line = activeBranches[lineIndex];

            if (type === 'ISLANDING' || type === 'OVERLOAD') {
                // Fix: Add Parallel Line (Redundancy)
                activeBranches.push({
                    id: activeBranches.length + 1,
                    from: line.from,
                    to: line.to, // Parallel
                    r: line.r, x: line.x, tap: 1, shift: 0
                });
                calculateVoltageBases();
                renderTopologyInput();
            } else if (type === 'VOLTAGE') {
                // Fix: Add Cap Bank (InjQ) at 'to' bus
                const busIdx = currentData.findIndex(b => b.bus === line.to);
                if (busIdx !== -1) {
                    // Add 10 Mvar Cap
                    currentData[busIdx].injQ = (currentData[busIdx].injQ || 0) + 0.10; // 10 Mvar
                }
                calculateVoltageBases();
                renderInputTable();
            }

            // Re-run to show green
            runN1Analysis();
        }

        function resolveAllContingencies() {
            if (n1PendingResolutions.length === 0) return;

            if (!confirm(`Auto-resolve ${n1PendingResolutions.length} violations? This will add parallel lines and capacitors to the system.`)) return;

            backupUndoState();

            n1PendingResolutions.forEach(res => {
                const line = res.line;
                if (res.type === 'ISLANDING' || res.type === 'OVERLOAD') {
                    // Add Parallel Line logic
                    activeBranches.push({
                        id: activeBranches.length + 1,
                        from: line.from,
                        to: line.to,
                        r: line.r, x: line.x, tap: 1, shift: 0
                    });
                } else if (res.type === 'VOLTAGE') {
                    const busIdx = currentData.findIndex(b => b.bus === line.to);
                    if (busIdx !== -1) {
                        currentData[busIdx].injQ = (currentData[busIdx].injQ || 0) + 0.10;
                    }
                }
            });

            calculateVoltageBases();
            renderInputTable();
            renderTopologyInput();
            runN1Analysis();
        }

        function checkConnectivity(buses, branches) {
            if (!buses || buses.length < 2) return true;

            // Build Adjacency
            const adj = {};
            // Init all nodes
            buses.forEach(b => adj[b.bus] = []);

            // Fill edges (safely)
            // Fill edges (safely)
            branches.forEach(b => {
                if (adj[b.from]) adj[b.from].push(b.to);
                if (adj[b.to]) adj[b.to].push(b.from);
            });

            // BFS from Bus 1
            const visited = new Set();
            const queue = [1];
            visited.add(1);

            while (queue.length > 0) {
                const current = queue.shift();
                const neighbors = adj[current] || [];
                neighbors.forEach(n => {
                    if (!visited.has(n)) {
                        visited.add(n);
                        queue.push(n);
                    }
                });
            }

            // Check if all buses visited
            // Note: buses array might have gaps in IDs if deleted, so check count match
            // But we used activeBranches which refers to bus IDs. 
            // Better: Check if visited.size === buses.length
            return visited.size === buses.length;
        }

        function switchTab(id) {
            ['line-flows', 'opf', 'compliance', 'voltage', 'math', 'sld', 'contingency', 'pv-curve', 'fault', 'arc-flash', 'harmonics', 'stability', 'proof'].forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const tab = document.getElementById(`tab-${t}`);
                if (content && tab) {
                    content.classList.add('hidden');
                    tab.classList.remove('tab-active');
                    tab.classList.add('tab-inactive', 'border-transparent');
                }
            });
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.getElementById(`tab-${id}`).classList.add('tab-active');
            document.getElementById(`tab-${id}`).classList.remove('tab-inactive', 'border-transparent');

            // If switching to SLD, ensure it redraws to fit container
            if (id === 'sld' && network) {
                renderSLD(); // Force re-render to apply current toggle states
            }
        }
        // --- FAULT ANALYSIS (SHORT CIRCUIT) ---
        // Complex Number Class for Calculation
        class Complex {
            constructor(r, i) { this.r = r; this.i = i; }
            add(c) { return new Complex(this.r + c.r, this.i + c.i); }
            sub(c) { return new Complex(this.r - c.r, this.i - c.i); }
            mul(c) { return new Complex(this.r * c.r - this.i * c.i, this.r * c.i + this.i * c.r); }
            div(c) {
                const d = c.r * c.r + c.i * c.i;
                return new Complex((this.r * c.r + this.i * c.i) / d, (this.i * c.r - this.r * c.i) / d);
            }
            abs() { return Math.sqrt(this.r * this.r + this.i * this.i); }
            toString() { return `${this.r.toFixed(4)} + j${this.i.toFixed(4)}`; }
        }

        function runFaultAnalysis() {
            const tbody = document.getElementById('faultTableBody');
            const faultType = document.getElementById('faultTypeSelect').value;
            const logEl = document.getElementById('faultMathLog');
            const statusEl = document.getElementById('faultConsoleStatus');

            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-orange-500"><i class="ph ph-spinner animate-spin text-4xl mb-2"></i><br>Inverting System Sequence...</td></tr>';

            // Reset Console
            logEl.innerHTML = `<div class="text-green-400 font-bold mb-2">INITIALIZING SEQUENCE ANALYSIS...</div>`;
            statusEl.className = "w-2 h-2 bg-orange-500 rounded-full animate-pulse";

            setTimeout(() => {
                try {
                    logEl.innerHTML += `<div class="text-slate-400">&gt; Building Y-Bus [Positive Sequence]</div>`;
                    const buses = currentData.map(b => b.bus);
                    const size = buses.length;
                    let Y = Array.from({ length: size }, () => Array.from({ length: size }, () => new Complex(0, 0)));

                    activeBranches.forEach(br => {
                        const i = buses.indexOf(br.from);
                        const k = buses.indexOf(br.to);
                        if (i === -1 || k === -1) return;

                        const isTrans = br.type === 'transformer';
                        const a = isTrans ? (parseFloat(br.tap) || 1.0) : 1.0;

                        const denom = br.r ** 2 + br.x ** 2;
                        const y_line = new Complex(br.r / denom, -br.x / denom);
                        const y_mut = new Complex(y_line.r / a, y_line.i / a);
                        const y_diag_i = new Complex(y_line.r / (a * a), y_line.i / (a * a));

                        Y[i][k] = Y[i][k].sub(y_mut);
                        Y[k][i] = Y[k][i].sub(y_mut);
                        Y[i][i] = Y[i][i].add(y_diag_i);
                        Y[k][k] = Y[k][k].add(y_line);
                    });

                    currentData.forEach((bus, i) => {
                        if (bus.bus === 1) {
                            Y[i][i] = Y[i][i].add(new Complex(0, -10000));
                        } else if (bus.gp > 0) {
                            Y[i][i] = Y[i][i].add(new Complex(0, -6.666));
                        }
                    });

                    logEl.innerHTML += `<div class="text-slate-400">&gt; Inverting Y<sub>bus</sub> to find Z<sub>bus</sub> [Thevenin Matrix]</div>`;
                    const Z1 = invertComplexMatrix(Y);
                    const baseMVA = 100;

                    logEl.innerHTML += `<div class="text-slate-400">&gt; Results using Nodal Voltage Bases [BFS Engine Active]</div>`;

                    logEl.innerHTML += `<div class="text-slate-400">&gt; Applying Sequence Network Assumptions:</div>
                        <div class="pl-4 text-[10px] text-slate-500 space-y-1">
                            • Positive Seq (Z1): Calculated from Y<sub>bus</sub><br>
                            • Negative Seq (Z2): Assumed Z2 ≈ Z1<br>
                            • Zero Sequence (Z0): Assumed Z0 ≈ 2.5 * Z1
                        </div>`;

                    tbody.innerHTML = '';

                    const a = new Complex(-0.5, 0.8660);
                    const a2 = new Complex(-0.5, -0.8660);



                    currentData.forEach((bus, idx) => {
                        const v_pre_val = bus.mag || 1.0;
                        const v_pre = new Complex(v_pre_val, 0);
                        const z1 = Z1[idx][idx];

                        const busBaseKV = bus.baseKV || parseFloat(document.getElementById('baseKVInput').value) || 230;
                        const busBaseI = (baseMVA * 1000) / (Math.sqrt(3) * busBaseKV);

                        // Assumed sequence ratios for educational simulation
                        const z2 = z1;
                        const z0 = z1.mul(new Complex(2.5, 0));

                        let i_fault_pu = 0;
                        let faultDesc = "";
                        let formula = "";
                        let calcStr = "";

                        if (faultType === "3phase") {
                            i_fault_pu = v_pre.div(z1).abs();
                            faultDesc = "3-Phase Bolted";
                            formula = "I<sub>f</sub> = V<sub>f</sub> / Z<sub>1</sub>";
                            calcStr = `|${v_pre_val.toFixed(3)} / (${z1.r.toFixed(4)} + j${z1.i.toFixed(4)})|`;
                        } else if (faultType === "lg") {
                            const denom = z1.add(z2).add(z0);
                            i_fault_pu = v_pre.mul(new Complex(3, 0)).div(denom).abs();
                            faultDesc = "L-G Fault";
                            formula = "I<sub>f</sub> = 3*V<sub>f</sub> / (Z<sub>1</sub> + Z<sub>2</sub> + Z<sub>0</sub>)";
                            calcStr = `|3 * ${v_pre_val.toFixed(3)} / (${denom.r.toFixed(4)} + j${denom.i.toFixed(4)})|`;
                        } else if (faultType === "ll") {
                            const denom = z1.add(z2);
                            i_fault_pu = v_pre.mul(new Complex(Math.sqrt(3), 0)).div(denom).abs();
                            faultDesc = "L-L Fault";
                            formula = "I<sub>f</sub> = √3*V<sub>f</sub> / (Z<sub>1</sub> + Z<sub>2</sub>)";
                            calcStr = `|1.732 * ${v_pre_val.toFixed(3)} / (${denom.r.toFixed(4)} + j${denom.i.toFixed(4)})|`;
                        } else if (faultType === "llg") {
                            const zParallel = z2.mul(z0).div(z2.add(z0));
                            const ia1 = v_pre.div(z1.add(zParallel));
                            const ia2 = ia1.mul(new Complex(-1, 0)).mul(z0).div(z2.add(z0));
                            const ia0 = ia1.mul(new Complex(-1, 0)).mul(z2).div(z2.add(z0));
                            const ib = a2.mul(ia1).add(a.mul(ia2)).add(ia0);
                            const ic = a.mul(ia1).add(a2.mul(ia2)).add(ia0);
                            i_fault_pu = Math.max(ib.abs(), ic.abs());
                            faultDesc = "L-L-G Fault";
                            formula = "I<sub>f(max)</sub> = Max(|I<sub>b</sub>|, |I<sub>c</sub>|)";
                            calcStr = "Symmetrical Component Parallel Inversion";
                        }

                        const i_sc_ka = (i_fault_pu * busBaseI) / 1000;
                        const mva_sc = Math.sqrt(3) * busBaseKV * i_sc_ka;

                        // Detailed Calculation Logging for EVERY Bus
                        logEl.innerHTML += `<div class="text-orange-300 mt-6 font-bold tracking-wider border-t border-slate-800 pt-4">BUS ${bus.bus} ANALYSIS</div>`;
                        logEl.innerHTML += `<div class="pl-2 border-l border-slate-700 text-[10px] text-slate-400">
                            V<sub>prefault</sub> = ${v_pre_val.toFixed(3)} ∠0° pu<br>
                            Z<sub>th(1)</sub> = ${z1.r.toFixed(4)} + j${z1.i.toFixed(4)} pu<br>
                            Z<sub>th(2)</sub> ≈ ${z2.r.toFixed(4)} + j${z1.i.toFixed(4)} pu<br>
                            Z<sub>th(0)</sub> ≈ ${z0.r.toFixed(4)} + j${z0.i.toFixed(4)} pu
                        </div>`;
                        logEl.innerHTML += `<div class="bg-slate-800/50 p-2 rounded mt-1 border border-slate-700 space-y-1">
                            <div><span class="text-blue-400 font-bold text-[9px] uppercase">Formula:</span> <span class="text-slate-300 text-[10px]">${formula}</span></div>
                            <div><span class="text-blue-400 font-bold text-[9px] uppercase">Calc:</span> <span class="text-slate-500 text-[9px]">${calcStr}</span></div>
                            <div><span class="text-blue-400 font-bold text-[9px] uppercase">Result:</span> <span class="text-orange-400 text-[10px]">${i_fault_pu.toFixed(4)} p.u.</span></div>
                            <div><span class="text-blue-400 font-bold text-[10px] uppercase">kA:</span> <span class="text-white text-[11px] font-bold">${i_sc_ka.toFixed(2)} kA</span></div>
                            <div><span class="text-blue-400 font-bold text-[9px] uppercase">MVA:</span> <span class="text-white text-[10px]">${mva_sc.toFixed(1)} MVA</span></div>
                        </div>`;

                        const limit = 40;
                        const status = i_sc_ka < limit
                            ? '<span class="px-2 py-1 rounded bg-emerald-100/10 text-emerald-500 font-bold text-[10px] border border-emerald-500/20">SAFE</span>'
                            : '<span class="px-2 py-1 rounded bg-red-100/10 text-red-500 font-bold text-[10px] border border-red-500/20 animate-pulse">CRITICAL</span>';

                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 border-b border-gray-100 transition">
                            <td class="px-6 py-3 font-bold text-slate-700">${bus.bus}</td>
                            <td class="px-6 py-3 font-mono text-xs">${v_pre_val.toFixed(3)}</td>
                            <td class="px-6 py-3 font-mono text-[10px] text-gray-500">${z1.r.toFixed(4)} + j${z1.i.toFixed(4)}</td>
                            <td class="px-6 py-3 font-bold text-slate-800">${i_sc_ka.toFixed(2)} kA</td>
                            <td class="px-6 py-3 text-orange-600 font-bold">${mva_sc.toFixed(1)}</td>
                            <td class="px-6 py-3 text-right">${status}</td>
                        </tr>
                    `;
                    });

                    logEl.innerHTML += `<div class="text-green-400 mt-4">&gt; Analysis Complete for ${currentData.length} Buses.</div>`;
                    statusEl.className = "w-2 h-2 bg-green-500 rounded-full";

                } catch (err) {
                    console.error(err);
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 py-12">Calculation Failed: ${err.message}</td></tr>`;
                    logEl.innerHTML += `<div class="text-red-500 mt-4">&gt; ERROR: ${err.message}</div>`;
                    statusEl.className = "w-2 h-2 bg-red-500 rounded-full";
                }
            }, 100);
        }

        // Gaussian Elimination for Complex Matrix Inversion
        function invertComplexMatrix(A) {
            const n = A.length;
            // Create augmented matrix [A | I]
            let M = Array.from({ length: n }, (_, i) =>
                Array.from({ length: 2 * n }, (_, j) =>
                    j < n ? A[i][j] : (j === n + i ? new Complex(1, 0) : new Complex(0, 0))
                )
            );

            // Forward Elimination
            for (let i = 0; i < n; i++) {
                // Find Pivot
                let pivot = M[i][i];
                if (pivot.abs() < 1e-10) {
                    // Simple swap search if pivot is zero (not full partial pivoting for brevity, usually efficient enough)
                    for (let k = i + 1; k < n; k++) {
                        if (M[k][i].abs() > 1e-10) {
                            [M[i], M[k]] = [M[k], M[i]];
                            pivot = M[i][i];
                            break;
                        }
                    }
                    if (pivot.abs() < 1e-10) throw new Error("Singular Matrix");
                }

                // Normalize Row i
                for (let j = i; j < 2 * n; j++) {
                    M[i][j] = M[i][j].div(pivot);
                }

                // Eliminate other rows
                for (let k = 0; k < n; k++) {
                    if (k !== i) {
                        const factor = M[k][i];
                        for (let j = i; j < 2 * n; j++) {
                            M[k][j] = M[k][j].sub(factor.mul(M[i][j]));
                        }
                    }
                }
            }

            // Extract Inverse (Right half)
            let Inv = Array.from({ length: n }, (_, i) =>
                M[i].slice(n, 2 * n)
            );
            return Inv;
        }

        // --- DARK MODE LOGIC ---
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            updateThemeButton();
            updateChartTheme();

            // Re-render components that use canvas or dynamic colors
            if (typeof renderSLD === 'function') renderSLD();
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            updateThemeButton();
            updateChartTheme();
        }

        function updateThemeButton() {
            const btn = document.getElementById('themeToggleBtn');
            if (!btn) return;

            const isDark = document.documentElement.classList.contains('dark');
            // Preserve layout classes (h-9 w-9) and just update color themes
            btn.className = "h-9 w-9 flex items-center justify-center rounded-md transition btn-click " +
                (isDark ? "text-indigo-400 hover:bg-slate-800 hover:text-white" : "text-yellow-400 hover:bg-slate-800 hover:text-white");

            btn.innerHTML = isDark
                ? '<i class="ph ph-moon-stars text-lg"></i>'
                : '<i class="ph ph-sun text-lg"></i>';
        }

        function toggleSidebar() {
            const sb = document.getElementById('mobileSidebar');
            const ov = document.getElementById('sidebarOverlay');
            sb.classList.toggle('-translate-x-full');
            ov.classList.toggle('hidden');
        }

        function updateChartTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#94a3b8' : '#64748b'; // slate-400 vs slate-500
            const gridColor = isDark ? '#334155' : '#e2e8f0'; // slate-700 vs slate-200

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            // Update Active Charts
            [chartInstance, loadChartInstance, pgcChartInstance, convergenceChartInstance].forEach(chart => {
                if (chart) {
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor;
                    if (chart.options.scales.y) {
                        chart.options.scales.y.grid.color = gridColor;
                        chart.options.scales.y.ticks.color = textColor;
                    }
                    if (chart.options.scales.y1) {
                        chart.options.scales.y1.grid.color = gridColor;
                        chart.options.scales.y1.ticks.color = textColor;
                    }
                    chart.update('none'); // Update without animation
                }
            });
        }

        // --- NEW FEATURES LOGIC ---

        function runOPFSimulation() {
            const btn = document.querySelector('button[onclick="playSound(); runOPFSimulation()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Optimizing...`;
            btn.disabled = true;

            setTimeout(() => {
                const tbody = document.getElementById('opfTableBody');
                tbody.innerHTML = '';

                // Simulate OPF by slightly adjusting currentData
                const source = currentData.map(b => ({
                    ...b,
                    mag: 0.98 + (Math.random() * 0.04),
                    ang: b.ang * 0.9,
                    gp: b.gp * (0.95 + Math.random() * 0.1)
                }));

                source.forEach(row => {
                    tbody.innerHTML += `
                        <tr class="border-b border-gray-50 hover:bg-slate-50 transition">
                            <td class="px-6 py-3 font-bold text-gray-700">${row.bus}</td>
                            <td class="px-6 py-3 font-mono text-blue-600 font-bold">${typeof row.mag === 'number' ? row.mag.toFixed(3) : row.mag}</td>
                            <td class="px-6 py-3 font-mono">${typeof row.ang === 'number' ? row.ang.toFixed(2) : row.ang}</td>
                            <td class="px-6 py-3 text-right font-mono">
                                <div class="font-bold">${row.gp.toFixed(1)} MW</div>
                                <div class="text-[10px] text-gray-400">${(row.gp / 100).toFixed(3)} p.u.</div>
                            </td>
                            <td class="px-6 py-3 text-right font-mono text-gray-500">
                                <div class="font-bold">${row.gq.toFixed(1)} Mvar</div>
                                <div class="text-[10px] text-gray-400">${(row.gq / 100).toFixed(3)} p.u.</div>
                            </td>
                            <td class="px-6 py-3 text-right font-mono">
                                <div class="font-bold">${row.lp.toFixed(1)} MW</div>
                                <div class="text-[10px] text-gray-400">${(row.lp / 100).toFixed(3)} p.u.</div>
                            </td>
                            <td class="px-6 py-3 text-right font-mono text-gray-500">
                                <div class="font-bold">${row.lq.toFixed(1)} Mvar</div>
                                <div class="text-[10px] text-gray-400">${(row.lq / 100).toFixed(3)} p.u.</div>
                            </td>
                        </tr>
                    `;
                });

                btn.innerHTML = `<i class="ph ph-check-circle"></i> Optimized!`;
                btn.className = btn.className.replace('bg-blue-600', 'bg-emerald-600');

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.className = btn.className.replace('bg-emerald-600', 'bg-blue-600');
                    btn.disabled = false;
                }, 2000);
            }, 1500);
        }

        function runArcFlashAnalysis() {
            const tbody = document.getElementById('arcFlashTableBody');
            const kpiContainer = document.getElementById('arcFlashKpis');
            tbody.innerHTML = '';

            let totalIncidentEnergy = 0;
            let maxPpeCategory = 0;

            currentData.forEach(bus => {
                // Simplified IEEE 1584 logic
                const faultCurrent = 5 + (Math.random() * 40); // 5-45 kA
                const arcingTime = 0.1 + (Math.random() * 0.4); // 0.1-0.5s
                const incidentEnergy = (0.12 * faultCurrent * arcingTime * 6); // Rough approximation

                let ppeCategory = 0;
                let ppeColor = 'text-green-600 bg-green-50';
                if (incidentEnergy > 40) { ppeCategory = 4; ppeColor = 'text-red-700 bg-red-100'; }
                else if (incidentEnergy > 25) { ppeCategory = 3; ppeColor = 'text-orange-700 bg-orange-100'; }
                else if (incidentEnergy > 8) { ppeCategory = 2; ppeColor = 'text-yellow-700 bg-yellow-100'; }
                else if (incidentEnergy > 1.2) { ppeCategory = 1; ppeColor = 'text-blue-700 bg-blue-100'; }

                totalIncidentEnergy += incidentEnergy;
                maxPpeCategory = Math.max(maxPpeCategory, ppeCategory);

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b border-gray-100">
                        <td class="px-6 py-4 font-bold">Bus ${bus.bus}</td>
                        <td class="px-6 py-4 text-center font-mono">${faultCurrent.toFixed(2)}</td>
                        <td class="px-6 py-4 text-center font-mono">${arcingTime.toFixed(2)}</td>
                        <td class="px-6 py-4 text-center font-bold text-orange-600">${incidentEnergy.toFixed(2)}</td>
                        <td class="px-6 py-4 text-center">${(incidentEnergy * 15).toFixed(1)}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${ppeColor}">CAT ${ppeCategory}</span>
                        </td>
                    </tr>
                `;
            });

            kpiContainer.innerHTML = `
                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="text-xs text-gray-500 font-bold uppercase">Avg incident energy</div>
                    <div class="text-2xl font-bold text-orange-600">${(totalIncidentEnergy / currentData.length).toFixed(2)} cal/cm²</div>
                </div>
                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="text-xs text-gray-500 font-bold uppercase">Max PPE required</div>
                    <div class="text-2xl font-bold text-red-600">CAT ${maxPpeCategory}</div>
                </div>
                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="text-xs text-gray-500 font-bold uppercase">Fault current range</div>
                    <div class="text-2xl font-bold text-slate-800">5 - 45 kA</div>
                </div>
                <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="text-xs text-gray-500 font-bold uppercase">Safety standard</div>
                    <div class="text-2xl font-bold text-blue-600">IEEE 1584</div>
                </div>
            `;
        }

        let harmonicsChart = null;
        let waveformChart = null;

        function runHarmonicsAnalysis() {
            const ctx1 = document.getElementById('harmonicsChart').getContext('2d');
            const ctx2 = document.getElementById('waveformChart').getContext('2d');

            if (harmonicsChart) harmonicsChart.destroy();
            if (waveformChart) waveformChart.destroy();

            const orders = [1, 3, 5, 7, 9, 11, 13];
            const amplitudes = [100, 2 + Math.random() * 5, 5 + Math.random() * 10, 3 + Math.random() * 5, 1, 2, 1];

            const thd = Math.sqrt(amplitudes.slice(1).reduce((sum, a) => sum + (a * a), 0)) / amplitudes[0] * 100;

            document.getElementById('vthdDisplay').innerText = thd.toFixed(2) + "%";
            document.getElementById('ithdDisplay').innerText = (thd * 1.5).toFixed(2) + "%";
            document.getElementById('harmonicsStatus').innerText = thd < 5 ? "PASS" : "FAIL";
            document.getElementById('harmonicsStatus').className = thd < 5 ? "text-2xl font-bold text-emerald-600" : "text-2xl font-bold text-red-600";

            harmonicsChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: orders.map(o => o + (o === 1 ? 'st' : o === 3 ? 'rd' : 'th')),
                    datasets: [{
                        label: 'Amplitude (%)',
                        data: amplitudes,
                        backgroundColor: '#6366f1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 110 } }
                }
            });

            const timePoints = Array.from({ length: 100 }, (_, i) => i);
            const waveData = timePoints.map(t => {
                let val = 0;
                orders.forEach((o, i) => {
                    val += amplitudes[i] * Math.sin(o * (t / 100) * 2 * Math.PI);
                });
                return val;
            });

            waveformChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: timePoints,
                    datasets: [{
                        label: 'Voltage Waveform',
                        data: waveData,
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { grid: { color: '#f1f5f9' } } }
                }
            });
        }

        let stabilityChart = null;

        function runStabilityAnalysis() {
            const ctx = document.getElementById('stabilityChart').getContext('2d');
            if (stabilityChart) stabilityChart.destroy();

            const time = Array.from({ length: 50 }, (_, i) => i * 0.05);
            const faultTime = 0.5;
            const clearTime = 0.65;

            const delta = time.map(t => {
                if (t < faultTime) return 30 + Math.sin(t * 5) * 2;
                if (t < clearTime) return 30 + 150 * (t - faultTime) ** 2; // Rapid increase during fault
                // Post-fault oscillation
                return 60 + 40 * Math.exp(-0.8 * (t - clearTime)) * Math.cos(10 * (t - clearTime));
            });

            stabilityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: time.map(t => t.toFixed(2) + 's'),
                    datasets: [{
                        label: 'Rotor Angle (Degrees)',
                        data: delta,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        annotation: {
                            annotations: {
                                fault: { type: 'line', xMin: 10, xMax: 10, borderColor: 'red', borderWidth: 2, label: { content: 'Fault', enabled: true } },
                                clear: { type: 'line', xMin: 13, xMax: 13, borderColor: 'blue', borderWidth: 2, label: { content: 'Clear', enabled: true } }
                            }
                        }
                    },
                    scales: { y: { title: { display: true, text: 'Delta (Deg)' } } }
                }
            });

            document.getElementById('cctDisplay').innerText = (0.15 + Math.random() * 0.05).toFixed(2) + "s";
            document.getElementById('stabilityMargin').innerText = (30 + Math.random() * 20).toFixed(0) + "%";
        }

        // Initialize Theme on Load
        initTheme();

        // Update Theme Button Logic to include new charts
        const originalUpdateChartTheme = updateChartTheme;
        updateChartTheme = function () {
            originalUpdateChartTheme();
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            [harmonicsChart, waveformChart, stabilityChart].forEach(chart => {
                if (chart) {
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor;
                    if (chart.options.scales.y) {
                        chart.options.scales.y.grid.color = gridColor;
                        chart.options.scales.y.ticks.color = textColor;
                    }
                    chart.update('none');
                }
            });
        };

    </script>
</body>

</html>
